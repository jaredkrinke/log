<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
<title>Schemescape</title>
<id>https://log.schemescape.com/</id>
<link rel="self" href="https://log.schemescape.com/feed.xml"/>
<link rel="alternate" href="https://log.schemescape.com/"/>
<author>
<name>Schemescape</name>
</author>
<updated>2025-12-29T00:00:00.000Z</updated>

<entry>
<title>Beating myself at chess</title>
<id>https://log.schemescape.com/posts/diy/beating-myself-at-chess.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/diy/beating-myself-at-chess.html"/>
<updated>2025-12-29T00:00:00.000Z</updated>
<summary type="text">Or: programming a chess AI without any preparation whatsoever.</summary>
<content type="html">&lt;p&gt;&lt;strong&gt;Programming a chess AI that can beat me is an item that&#039;s been on my bucket list for a long time&lt;/strong&gt;, believe it or not.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Spoiler&lt;/strong&gt;: I&#039;m terrible at chess, so creating an AI to beat &lt;em&gt;me&lt;/em&gt; specifically wasn&#039;t too difficult.&lt;/p&gt;
&lt;p&gt;You can play against the AI from the comfort of your browser here: &lt;a href=&quot;https://jaredkrinke.github.io/cm-chessboard/&quot;&gt;https://jaredkrinke.github.io/cm-chessboard/&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;motivation&quot;&gt;Motivation&lt;/h1&gt;
&lt;p&gt;Similar to &lt;a href=&quot;https://log.schemescape.com/posts/diy/../static-site-generators/smallest-static-site-generator.html&quot;&gt;static site generators&lt;/a&gt;, no one is clamoring for a new chess engine written by me. My primary motivations were to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Experiment with my development environment&lt;/li&gt;
&lt;li&gt;Keep things as simple as possible&lt;/li&gt;
&lt;li&gt;Maybe port the result to an old, slow vintage computer&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;I opted to prepare as little as possible&lt;/strong&gt;--just start coding!&lt;/p&gt;
&lt;h1 id=&quot;development-environment&quot;&gt;Development environment&lt;/h1&gt;
&lt;p&gt;I&#039;m nostalgic for the pre-always-on-Internet days--without constant distractions and bloat. I also just revived an &lt;a href=&quot;https://log.schemescape.com/posts/diy/../hardware/farewell-to-a-netbook.html#the-future&quot;&gt;Asus EeeBook X205T netbook&lt;/a&gt;. So &lt;strong&gt;I settled on revisiting late 90s programming&lt;/strong&gt;, using GNU Screen, Vim, entr, and w3m, in terminal mode. &lt;strong&gt;Typing into the console on a tiny, light netbook is peak &amp;quot;cozy coding&amp;quot;&lt;/strong&gt;.&lt;/p&gt;
&lt;h1 id=&quot;keeping-things-simple&quot;&gt;Keeping things simple&lt;/h1&gt;
&lt;p&gt;With an eye toward simplicity, and also portability to old computers, I opted for using C, with as few dependencies as possible.&lt;/p&gt;
&lt;p&gt;In the end, the core of my chess engine and its associated AI (excluding the front end) have exactly &lt;strong&gt;zero&lt;/strong&gt; dependencies. It uses a fixed amount of memory, with no dynamic allocations! The full chess engine is under 600 lines and the AI is under 150. &lt;strong&gt;Compiled to WebAssembly, the whole shebang is under 6 KB&lt;/strong&gt;. I&#039;d been hoping to run it on my Pentium laptop or Raspberry Pi B, but now I&#039;m wondering if it could run on DOS, or maybe even an Amiga!&lt;/p&gt;
&lt;p&gt;Not everything went perfectly, however. &lt;strong&gt;In an attempt to rush through the project, I put off writing tests until absolutely necessary&lt;/strong&gt;--hoping they would never be needed. But eventually I needed to refactor and rewrite the trickiest bits of movement code (en passant and castling), and I had to stop and build up a test framework and tests from scratch, in the middle of a rewrite. For the record: the tests uncovered multiple bugs in my original implementation. &lt;strong&gt;Kids, don&#039;t skip writing tests!&lt;/strong&gt;&lt;/p&gt;
&lt;h1 id=&quot;integration&quot;&gt;Integration&lt;/h1&gt;
&lt;p&gt;The initial UI used ASCII characters in the terminal, but the non-square VGA font made it hard to imagine piece movements on the board (even after experimenting with ANSI escape codes to invert white squares--a feature I eventually abandoned).&lt;/p&gt;
&lt;p&gt;Rather than create a graphical interface from scratch, I opted to integrate with:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://www.gnu.org/software/xboard&quot;&gt;XBoard&lt;/a&gt; (using &lt;a href=&quot;https://www.chessprogramming.org/Chess_Engine_Communication_Protocol&quot;&gt;CECP, aka &amp;quot;the XBoard protocol&amp;quot;&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;Web browsers, using &lt;a href=&quot;https://shaack.com/projekte/cm-chessboard/&quot;&gt;cm-chessboard&lt;/a&gt; and WebAssembly&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;xboard&quot;&gt;XBoard&lt;/h2&gt;
&lt;p&gt;XBoard uses a line-based text protocol (&lt;a href=&quot;https://www.gnu.org/software/xboard/engine-intf.html&quot;&gt;documented here&lt;/a&gt;), so I thought it would be easy to implement. Pro tip: if you want to experiment with the XBoard protocol live, you can use &lt;code&gt;netcat&lt;/code&gt;, but you&#039;ll need to issue a &lt;code&gt;feature sigint=0 done=1&lt;/code&gt; command (otherwise, XBoard will send a &lt;code&gt;SIGINT&lt;/code&gt; to &amp;quot;wake up&amp;quot; your process, and &lt;code&gt;netcat&lt;/code&gt; will be so startled that it just dies).&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Given that I never learned standard chess notation, XBoard was actually perfect&lt;/strong&gt; since it uses consistent and logical syntax like &lt;code&gt;a7a8q&lt;/code&gt; (move from &lt;strong&gt;a7&lt;/strong&gt; to &lt;strong&gt;a8&lt;/strong&gt; and promote to a &lt;strong&gt;q&lt;/strong&gt;ueen). Other than disabling features I didn&#039;t know or care about, my XBoard client mostly just listened for player moves (e.g. &lt;code&gt;e2e4&lt;/code&gt;) and replied with the AI&#039;s moves (e.g. &lt;code&gt;move e7e5&lt;/code&gt;). The whole thing was under 100 lines of C.&lt;/p&gt;
&lt;h2 id=&quot;browsers&quot;&gt;Browsers&lt;/h2&gt;
&lt;p&gt;Integrating with browsers was a little more involved since I used C instead of JavaScript. Without any standard library dependencies, compiling to WebAssembly was fairly simple (my &lt;a href=&quot;https://log.schemescape.com/posts/diy/../webassembly/trivial-example.html&quot;&gt;trivial WebAssembly research&lt;/a&gt; came in handy!). &lt;strong&gt;I encoded moves into integers in order to avoid any complex marshalling of strings&lt;/strong&gt; back and forth (3 bits for rank, 3 bits for file, 3 bits for promotion, easily fitting within a &lt;code&gt;Number&lt;/code&gt;&#039;s mantissa).&lt;/p&gt;
&lt;p&gt;After more searching than I anticipated, I found a mobile-friendly HTML+JavaScript chessboard that didn&#039;t require any exotic build systems (or even NPM!): &lt;strong&gt;&lt;a href=&quot;https://github.com/shaack/cm-chessboard&quot;&gt;cm-chessboard&lt;/a&gt;&lt;/strong&gt;. I had hoped to find a single-file chessboard that worked, but such a thing doesn&#039;t appear to exist.&lt;/p&gt;
&lt;h1 id=&quot;so-can-it-beat-me&quot;&gt;So can it beat me?&lt;/h1&gt;
&lt;p&gt;Was I successful in beating myself at chess? &lt;strong&gt;I&#039;m afraid the answer is yes&lt;/strong&gt;. Every time I play against the AI, I seem to make some fatal mistake and lose my queen or a rook. I can generally get ahead early, but then I make a series of increasingly boneheaded mistakes until there&#039;s not much point in continuing on.&lt;/p&gt;
&lt;p&gt;I don&#039;t yet know if my chess program can beat anyone other than the worst chess player in the world.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;In summary: mission accomplished!&lt;/strong&gt; (At least until I stop being terrible at chess.)&lt;/p&gt;
&lt;p&gt;Overall, this project was enjoyable enough that I&#039;d recommend it to anyone wanting to practice programming or wanting to test out a new programming language (or paradigm).&lt;/p&gt;
&lt;h1 id=&quot;resources&quot;&gt;Resources&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://tildegit.org/scms/chess&quot;&gt;cchess source code&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://jaredkrinke.github.io/cm-chessboard/&quot;&gt;Browser-based demo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.chessprogramming.org/Chess_Engine_Communication_Protocol&quot;&gt;XBoard protocol&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
</entry>
<entry>
<title>Writing a financial tracker for fun and paranoia</title>
<id>https://log.schemescape.com/posts/diy/expense-classifier.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/diy/expense-classifier.html"/>
<updated>2025-09-03T00:00:00.000Z</updated>
<summary type="text">I wrote both a QFX parser and a naive Bayes classifier from scratch because I have stopped trusting third-party dependencies.</summary>
<content type="html">&lt;p&gt;Sometimes I write software for fun (e.g. &lt;a href=&quot;https://jaredkrinke.itch.io/sic-1&quot;&gt;SIC-1, a single-instruction (subleq) programming game&lt;/a&gt;). Sometimes I write software because I have unreasonably specific requirements that existing tools can&#039;t satisfy (e.g. &lt;a href=&quot;https://github.com/jaredkrinke/luasmith&quot;&gt;luasmith, a 450 KB static site generator&lt;/a&gt;). Even though it&#039;s for my own benefit, I usually hope someone else will find it interesting or useful, so I share the code and maybe write about it.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;It&#039;s rare that I write (non-work-related) software, fully expecting no one else to ever see or use it,&lt;/strong&gt; but this is one of those times.&lt;/p&gt;
&lt;p&gt;Read on to see how paranoia prompted me to write a financial transaction parser and &lt;del&gt;an AI&lt;/del&gt; a statistical classifier from scratch, in Python (&lt;a href=&quot;https://log.schemescape.com/posts/diy/../programming-languages/python-as-a-modern-basic.html&quot;&gt;yes, Python&lt;/a&gt;).&lt;/p&gt;
&lt;h1 id=&quot;goal&quot;&gt;Goal&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;I want to know where my hard-earned money is going.&lt;/strong&gt;&lt;/p&gt;
&lt;h1 id=&quot;background&quot;&gt;Background&lt;/h1&gt;
&lt;p&gt;For more years than I care to admit, my workflow involved manually reviewing transactions, mentally classifying them, and entering everything into an Excel spreadsheet. Eventually, as a software developer, I realized that &lt;strong&gt;this is one of the few times in my life where I can actually apply my marketable skills directly to my daily existence&lt;/strong&gt;. Why did I not automate this sooner!?&lt;/p&gt;
&lt;h1 id=&quot;implementation&quot;&gt;Implementation&lt;/h1&gt;
&lt;p&gt;What did I actually end up building?&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;First, I needed a way to parse lists of transactions from my bank, credit cards, etc.&lt;/li&gt;
&lt;li&gt;Second, I wanted some sort of statistical classifier for transactions, for convenience&lt;/li&gt;
&lt;li&gt;Third, it needed to never leak my financial details&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;That last bullet is why I chose to write everything from scratch. &lt;strong&gt;There are numerous tools for downloading and processing financial transactions, but I don&#039;t trust any of them&lt;/strong&gt;. There&#039;s no way I&#039;d ever share my bank password with anything other than my bank&#039;s login form (in an up-to-date browser). Frankly, I&#039;m surprised tools even exist that ask to store bank passwords--that&#039;s basically painting a huge target on your back for hackers. Users&#039; financial credentials should be treated like radioactive waste!&lt;/p&gt;
&lt;p&gt;In the end, I wrote (from scratch, using only Python&#039;s standard library--to avoid any credential-stealing package install scripts):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A QFX/OFX parser&lt;/li&gt;
&lt;li&gt;A naive Bayes classifier&lt;/li&gt;
&lt;li&gt;A text interface that dumps everything into a comma-separated value (CSV) file (for Excel import)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;qfx-parser&quot;&gt;QFX Parser&lt;/h2&gt;
&lt;p&gt;QFX is a file format for financial transactions that is the same as OFX (&lt;a href=&quot;https://en.wikipedia.org/wiki/Open_Financial_Exchange&quot;&gt;Open Financial Exchange&lt;/a&gt;), but digitally signed by Intuit (cue eyeroll). The &lt;a href=&quot;https://pypi.org/project/ofxtools/&quot;&gt;ofxtools&lt;/a&gt; Python package can parse OFX files, but, as noted previously, I&#039;m paranoid, so I decided to write my own parser from scratch.&lt;/p&gt;
&lt;p&gt;Newer revisions of OFX are based on XML, but sadly I needed to be able to parse older, SGML-based versions of OFX. I have come to dislike SGML because, it seems, you can&#039;t just parse any old SGML file since &lt;strong&gt;SGML doesn&#039;t always require closing tags&lt;/strong&gt;. People like to dunk on XML&#039;s verbose syntax, but SGML reveals an even worse world where you require the schema for each file in order to know whether or not closing tags are required. This might not be a big deal for an event-based parser, but I wanted a simpler programming interface, using XPath or something like it (because I&#039;m lazy).&lt;/p&gt;
&lt;p&gt;Aggravatingly, &lt;strong&gt;OFX has a lot of &amp;quot;self-closing&amp;quot; tags&lt;/strong&gt;. In the end, I got a copy of the &lt;a href=&quot;https://github.com/libofx/libofx/blob/master/dtd/ofx160.dtd&quot;&gt;OFX 1.6 schema (DTD)&lt;/a&gt;, parsed it, and produced a gigantic list of self-closing tags, then I wrote some code to insert the &amp;quot;missing&amp;quot; closing tags, so that I could parse the resulting file as XML, using Python&#039;s built-in &lt;code&gt;xml.etree.ElementTree&lt;/code&gt; XML parser. By the way, SGML DTDs identify self-closing elements using this un-self-explanatory string: &lt;code&gt;- O&lt;/code&gt; -- good luck searching for that!&lt;/p&gt;
&lt;p&gt;Here&#039;s the fragile (i.e. it only works on this particular DTD) AWK script for finding self-closing tags:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-awk&quot;&gt;&lt;span class=&quot;hl-regex&quot;&gt;/^&amp;lt;!ELEMENT [A-Z]+.*[ \t][Oo][ \t].*/&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;quot;\&amp;quot;%s\&amp;quot;, &amp;quot;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-variable&quot;&gt;$2&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The good news is, armed with &amp;quot;XML-ified&amp;quot; (all tags explicitly closed) QFX/OFX, Python can easily parse all the transactions (&lt;code&gt;&amp;lt;stmttrn&amp;gt;&lt;/code&gt;&#039;s, as they are called):&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;hl-keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;hl-function&quot;&gt;parseTransactions&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;hl-comment&quot;&gt;# Remove header and convert to XML tree&lt;/span&gt;
    &lt;span class=&quot;hl-identifier&quot;&gt;str&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;re&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;sub&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;quot;^.*?&amp;lt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;quot;&amp;lt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hl-number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;flags&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;re&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;DOTALL&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;hl-identifier&quot;&gt;str&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-function&quot;&gt;sgml2xml&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;hl-identifier&quot;&gt;tree&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;ElementTree&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;fromstring&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;hl-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;parseTransaction&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;transaction&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;transaction&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;tree&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;findall&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;quot;.//stmttrn&amp;quot;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;bayes-classifier&quot;&gt;Bayes classifier&lt;/h2&gt;
&lt;p&gt;Once I had a list of transactions, including their date, amount, and a terse description, I needed some way to classify transactions as e.g. &amp;quot;food&amp;quot;, &amp;quot;gas&amp;quot;, &amp;quot;entertainment&amp;quot;, etc. Previously, I was just mentally assigning them to groups and typing a corresponding prefix into an Excel sheet. It was very tedious.&lt;/p&gt;
&lt;p&gt;This time, &lt;strong&gt;I&#039;m automatically classifying transactions&lt;/strong&gt;, keeping a few aspects in mind:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I wanted to be able to double-check classifications--and fix them, if needed&lt;/li&gt;
&lt;li&gt;I wanted the classifications to become more accurate over time&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Armed with Wikipedia&#039;s description of a &lt;a href=&quot;https://en.wikipedia.org/wiki/Naive_Bayes_classifier&quot;&gt;naive Bayes classifier&lt;/a&gt;, I was able to implement something that worked... at first. Other than an unfortunate typo in one equation, I spent most of my time debugging an issue where it kept misclassifying &amp;quot;food&amp;quot; and &amp;quot;gas&amp;quot; items.&lt;/p&gt;
&lt;h3 id=&quot;where-i-buy-food-and-gas&quot;&gt;Where I buy food and gas&lt;/h3&gt;
&lt;p&gt;I feel comfortable disclosing that I often buy both food and gas from the same store (in separate transactions). The transactions&#039; description fields look like this:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Food transaction: &lt;code&gt;&amp;lt;store&amp;gt; &amp;lt;city&amp;gt; ...&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Gas transaction: &lt;code&gt;&amp;lt;store&amp;gt; fuel &amp;lt;city&amp;gt; ...&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As a human, the obvious rule for transactions at that store is &amp;quot;&lt;code&gt;fuel&lt;/code&gt; implies &#039;gas&#039;, otherwise &#039;food&#039;&amp;quot;. But this is cutting-edge AI, so I&#039;m not planning to write any prescriptive rules (also: &lt;a href=&quot;http://www.incompleteideas.net/IncIdeas/BitterLesson.html&quot;&gt;The Bitter Lesson&lt;/a&gt;).&lt;/p&gt;
&lt;h3 id=&quot;multinomial-naive-bayes&quot;&gt;Multinomial naive Bayes&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;I didn&#039;t realize the implications of it at the time&lt;/strong&gt;, but I initially wrote a regularized &lt;a href=&quot;https://en.wikipedia.org/wiki/Naive_Bayes_classifier#Multinomial_naive_Bayes&quot;&gt;multinomial naive Bayes model&lt;/a&gt; where the input is pairs of words and their frequencies (allegedly often used for document classification). For each pair, the probability that word implies a given class is computed, and then those probabilities are multiplied. I won&#039;t explain the &amp;quot;regularization&amp;quot; part because it&#039;s not relevant here.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;The problem is that the multinomial model doesn&#039;t explicitly account for &amp;quot;absent&amp;quot; words&lt;/strong&gt;. My training data included tons of instances of the store&#039;s name, but they were split between &amp;quot;food&amp;quot; and &amp;quot;gas&amp;quot; (more &amp;quot;food&amp;quot; than &amp;quot;gas&amp;quot;). The word &amp;quot;fuel&amp;quot; only appeared on &amp;quot;gas&amp;quot; training data, but its effect wasn&#039;t strong enough to overpower the &amp;quot;store name implies &#039;food&#039;!&amp;quot; rule that the classifier learned.&lt;/p&gt;
&lt;p&gt;(I might also argue that the real root of this issue was the &amp;quot;naive&amp;quot; part of &amp;quot;naive Bayes classifier&amp;quot; -- clearly, the rule I, as a human, devised shows that each word is &lt;em&gt;not&lt;/em&gt; independent. But I wanted to stick with the simple and well-trodden path of a naive Bayes classifier, since, you know, it seemed popular.)&lt;/p&gt;
&lt;h3 id=&quot;bernoulli-naive-bayes&quot;&gt;Bernoulli naive Bayes&lt;/h3&gt;
&lt;p&gt;I had figured out the problem, but I didn&#039;t have a solution: how do I ensure that the &lt;em&gt;absence&lt;/em&gt; of &amp;quot;fuel&amp;quot; implies &amp;quot;food&amp;quot; and the presence of &amp;quot;fuel&amp;quot; implies &amp;quot;gas&amp;quot;? Back on Wikipedia, I found the answer: &lt;strong&gt;for short texts like this, don&#039;t worry about frequencies and instead compute a probability for the &lt;em&gt;presence or absence&lt;/em&gt; of &lt;em&gt;every&lt;/em&gt; word (absence is &lt;code&gt;1 - P(present)&lt;/code&gt;)&lt;/strong&gt;. This is the &lt;a href=&quot;https://en.wikipedia.org/wiki/Naive_Bayes_classifier#Bernoulli_naive_Bayes&quot;&gt;Bernoulli naive Bayes model&lt;/a&gt;, and it has worked great for my purposes because it provides a clear signal that &amp;quot;fuel&amp;quot; implies a &amp;quot;gas&amp;quot; classification and lack of &amp;quot;fuel&amp;quot; implies something else.&lt;/p&gt;
&lt;h3 id=&quot;learning-and-persisting&quot;&gt;Learning and persisting&lt;/h3&gt;
&lt;p&gt;With a working classifier, I needed to persist its &amp;quot;learnings&amp;quot; across runs. Python&#039;s large standard library is convenient (other than everything having weird names). &lt;strong&gt;Python has a built-in &lt;a href=&quot;https://docs.python.org/3/library/shelve.html&quot;&gt;shelve&lt;/a&gt; library the can serialize and deserialize Python objects to/from a file&lt;/strong&gt;. This made persisting and updating my classifier trivial:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;hl-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;shelve&lt;/span&gt;
&lt;span class=&quot;hl-keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;classifier&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;Classifier&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;parse&lt;/span&gt;

&lt;span class=&quot;hl-keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;shelve&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;quot;data&amp;quot;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;shelf&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;hl-identifier&quot;&gt;classifier&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;shelf&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;quot;classifier&amp;quot;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-function&quot;&gt;Classifier&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;hl-comment&quot;&gt;# Automaticaly classify transactions&lt;/span&gt;
    &lt;span class=&quot;hl-comment&quot;&gt;# Allow mis-classifications to be fixed&lt;/span&gt;

    &lt;span class=&quot;hl-comment&quot;&gt;# Persist classifier&lt;/span&gt;
    &lt;span class=&quot;hl-identifier&quot;&gt;shelf&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;quot;classifier&amp;quot;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;classifier&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This part of the project took much &lt;em&gt;less&lt;/em&gt; time than I anticipated. Thanks, Python!&lt;/p&gt;
&lt;h2 id=&quot;user-interface&quot;&gt;User interface&lt;/h2&gt;
&lt;p&gt;To keep things simple, I implemented a text-based interface, mostly based on Python&#039;s &lt;code&gt;prompt()&lt;/code&gt; function. All the classified data was written out to a CSV file using Python&#039;s &lt;code&gt;csv.writer&lt;/code&gt; class, for easy import into Excel (although, annoyingly, I had to deal with line ending nonsense--how is that not handled by default!?).&lt;/p&gt;
&lt;h1 id=&quot;result&quot;&gt;Result&lt;/h1&gt;
&lt;p&gt;It took longer than I had expected (or hoped), but the final result has been great. I&#039;ve mostly automated the tedious parts of tracking my expenses, while only trusting Python&#039;s standard library.&lt;/p&gt;
&lt;p&gt;In summary, what did I learn?&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I prefer XML over SGML because XML is regular and generally has broader support&lt;/li&gt;
&lt;li&gt;The Bernoulli naive Bayes model works better than multinomial on very short text, especially when some words show up in multiple classes&lt;/li&gt;
&lt;li&gt;Python&#039;s &lt;code&gt;shelve&lt;/code&gt; library is unbelievably convenient&lt;/li&gt;
&lt;li&gt;The best way to avoid wasting time choosing a GUI framework is to just punt and use a line-based text interface (like the good old days)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;(But mostly this was an excuse to write a piece of software that actually improves my life--while also giving Python another try.)&lt;/p&gt;
</content>
</entry>
<entry>
<title>The smallest embeddable scripting language, part 1</title>
<id>https://log.schemescape.com/posts/static-site-generators/smallest-scripting-language.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/static-site-generators/smallest-scripting-language.html"/>
<updated>2025-07-29T00:00:00.000Z</updated>
<summary type="text">My search for a small, simple embeddedable scripting language.</summary>
<content type="html">&lt;h1 id=&quot;background&quot;&gt;Background&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;I like small software&lt;/strong&gt; because I hate bloat. Sadly, bloat is pervasive in this era of Chrome-powered text editors.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I also like extensible software&lt;/strong&gt; because it lets you add the features you actually use without bloating the vanilla version for everyone else.&lt;/p&gt;
&lt;p&gt;As an example, take a look at &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/smallest-static-site-generator.html&quot;&gt;my &amp;lt; 1 MB static site generator&lt;/a&gt;. &lt;strong&gt;It&#039;s ~40 times smaller than &lt;a href=&quot;https://gohugo.io/&quot;&gt;Hugo&lt;/a&gt;&lt;/strong&gt;, yet it has features that Hugo doesn&#039;t conveniently support (e.g. preserving relative Markdown links and categorizing posts based on directory). (To be fair, it also lacks zillions of features that Hugo supports--but which I don&#039;t need.)&lt;/p&gt;
&lt;p&gt;At the heart of small and extensible software lies some sort of flexble configuration/extension scheme. In theory, something declarative would be preferable, but, &lt;strong&gt;in practice, this usually involves an embedded (and, yes, Turing-complete) scripting language&lt;/strong&gt;.&lt;/p&gt;
&lt;h1 id=&quot;goal&quot;&gt;Goal&lt;/h1&gt;
&lt;p&gt;Getting to the point, I want to find the smallest comfortable scripting language that can be easily embedded into minimal software. When I say &amp;quot;smallest&amp;quot;, I mean:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Small number of orthogonal language features (to make it easy to learn)&lt;/li&gt;
&lt;li&gt;Small implementation code size (to ensure it doesn&#039;t work against my goal of producing small software)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I&#039;ll admit that optimizing for code size in this era of terabyte drives doesn&#039;t seem important on the surface. However, I find that &lt;strong&gt;a small implementation size is a convenient proxy for these more virtuous aspects&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Simpler and easier to understand implementation&lt;/li&gt;
&lt;li&gt;Few or zero third-party dependencies&lt;/li&gt;
&lt;li&gt;Smaller surface area for bugs&lt;/li&gt;
&lt;li&gt;And sometimes improved portability, especially with older/slower platforms&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Oh, and even more unreasonably, I want the scripting language&#039;s &lt;em&gt;implementation language&lt;/em&gt; to also be simple and portable, so I&#039;m only looking at C-based implementations.&lt;/p&gt;
&lt;h1 id=&quot;the-contenders&quot;&gt;The contenders&lt;/h1&gt;
&lt;p&gt;After some unscientific research, these are the languages that looked most promising to me:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.lua.org/&quot;&gt;Lua&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;JavaScript (&lt;a href=&quot;https://bellard.org/quickjs/&quot;&gt;QuickJS&lt;/a&gt;, &lt;a href=&quot;https://github.com/svaarala/duktape&quot;&gt;Duktape&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;Python (&lt;a href=&quot;https://micropython.org/&quot;&gt;MicroPython&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.tcl-lang.org/&quot;&gt;Tcl&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Lisp (&lt;a href=&quot;https://tinyscheme.sourceforge.net/home.html&quot;&gt;TinyScheme&lt;/a&gt;, &lt;a href=&quot;https://github.com/yuriy-chumak/OL&quot;&gt;Otus Lisp&lt;/a&gt;, &lt;a href=&quot;https://github.com/owl-lisp/owl&quot;&gt;Owl Lisp&lt;/a&gt;, &lt;a href=&quot;https://ccrma.stanford.edu/software/snd/snd/s7.html&quot;&gt;s7&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://janet-lang.org/&quot;&gt;Janet&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://wren.io/&quot;&gt;Wren&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Obviously, Python and JavaScript are the most popular languages in the list, but both languages are big--and getting bigger every day! Also, it&#039;s unclear how helpful their ecosystems would be when I&#039;m planning to pull in smaller and less broadly supported implementations like MicroPython and QuickJS.&lt;/p&gt;
&lt;p&gt;Lua is arguably the king of embedded scripting languages, but I feel like a simpler language in the vein of Lisp or Scheme could be both smaller and more capable.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;/strong&gt;: After publishing this, there were &lt;a href=&quot;https://lobste.rs/s/hzr1ke/smallest_embeddable_scripting_language&quot;&gt;some suggestions on Lobsters&lt;/a&gt; for additional languages that might fit the bill:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://jim.tcl-lang.org/home/doc/www/www/index.html&quot;&gt;Jim&lt;/a&gt; (Tcl)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.compuphase.com/pawn/pawn.htm&quot;&gt;Pawn&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://berry-lang.github.io/&quot;&gt;Berry&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://craftinginterpreters.com/the-lox-language.html&quot;&gt;Lox&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/zevv/zForth&quot;&gt;zForth&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;others&quot;&gt;Others&lt;/h2&gt;
&lt;p&gt;There are also a few languages that don&#039;t quite fit what I&#039;m looking for right now:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://beyondloom.com/decker/lil.html&quot;&gt;lil&lt;/a&gt;: bonus points for sporting an awk implementation, but, without mutable data structures, I struggled to get acceptable performance&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/rxi/fe&quot;&gt;fe&lt;/a&gt;: only supports ~4000 cons cells&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.squirrel-lang.org/&quot;&gt;Squirrel&lt;/a&gt;: implemented in C++ and I&#039;m only looking at languages that are implemented in C&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://mruby.org/&quot;&gt;mruby&lt;/a&gt; (Ruby): uses a build system I wasn&#039;t familiar with&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;code-size-data&quot;&gt;Code size data&lt;/h1&gt;
&lt;p&gt;As a first pass, here are the sizes of size-optimized (&lt;code&gt;-Os&lt;/code&gt; and stripped) REPL executables:&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;Implementation&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;Language&lt;/th&gt;
&lt;th align=&quot;right&quot;&gt;Size&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;zForth&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Forth&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;25 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Lox&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Lox&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;40 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;TinyScheme&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Scheme&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;75 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Wren&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Wren&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;160 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Lua 5.2&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Lua&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;175 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Berry&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Berry&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;240 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Jim&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Tcl&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;325 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Duktape&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;JavaScript&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;350 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Pawn (&lt;code&gt;pawncc&lt;/code&gt;)&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Pawn&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;380 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Otus Lisp&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Scheme&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;500 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;QuickJS&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;JavaScript&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;700 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Owl Lisp&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Scheme&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;700 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Janet&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Janet&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;850 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;s7&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Scheme&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;1500 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;Tcl&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Tcl&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;1700 KB&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;MicroPython&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;Python&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;?&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Note: I didn&#039;t actually build MicroPython myself because its source code is &amp;gt; 100 MB (!). The homepage claims a 256 KB binary size, but I can&#039;t confirm that figure. I also didn&#039;t build mruby since it seemed to require Ruby for bootstrapping.&lt;/p&gt;
&lt;h1 id=&quot;analysis&quot;&gt;Analysis&lt;/h1&gt;
&lt;h2 id=&quot;lua&quot;&gt;Lua&lt;/h2&gt;
&lt;p&gt;An impressive showing by Lua, considering this includes the full (albeit still small) standard library! I have numerous complaints with Lua (conflating arrays with dictionaries, verbose syntax, and, yes, one-based indexing), but Lua&#039;s tiny code size is amazing! Even throwing in JIT compilation (via &lt;a href=&quot;https://luajit.org/&quot;&gt;LuaJIT&lt;/a&gt;) and parsing expression grammars (via &lt;a href=&quot;https://www.inf.puc-rio.br/~roberto/lpeg/&quot;&gt;LPeg&lt;/a&gt;), the binary is still tiny.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Honestly, Lua&#039;s &amp;quot;bang for your buck&amp;quot; is going to be hard to beat.&lt;/strong&gt; No wonder it&#039;s so popular!&lt;/p&gt;
&lt;h2 id=&quot;zforth&quot;&gt;zForth&lt;/h2&gt;
&lt;p&gt;Not surprising (given Forth&#039;s minimalist roots), but zForth is the smallest embeddable scripting language. Unfortuantely for me, despite how much I admire Forth&#039;s minimalism, I haven&#039;t to date been able to rewire my brain to comfortably read and write concatenative languages. &lt;strong&gt;If I was working on a microcontroller with only a few kilobytes of RAM (&lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/../vintage-computing/blazin-forth.html&quot;&gt;or a Commodore 64&lt;/a&gt;), I would happily use Forth&lt;/strong&gt;. But, for now, I&#039;m lucky enough to assume the presence of an operating system, text editor, and (at least) tens of megabytes of RAM, so I will ashamedly pass on zForth.&lt;/p&gt;
&lt;h2 id=&quot;lox&quot;&gt;Lox&lt;/h2&gt;
&lt;p&gt;Despite knowing about Wren, I didn&#039;t think to include Lox (by the same author) in my original research. Somehow it manages to be smaller than even the smallest Scheme! Unfortunately, as far as I can tell, the only reason it manages to be so tiny is that it has essentially no standard library--just a single &lt;code&gt;clock()&lt;/code&gt; function. Regardless, the tiny VM is impressive, so if you really need a minimal scripting language and you&#039;re comfortable building your own standard library, Lox could be promising.&lt;/p&gt;
&lt;h2 id=&quot;tinyscheme&quot;&gt;TinyScheme&lt;/h2&gt;
&lt;p&gt;The only embeddable language implementation that handily beats Lua in terms of code size is TinyScheme. Unfortunately, the ecosystem for TinyScheme is practically nonexistent--it&#039;s not even mentioned in &lt;a href=&quot;https://get.scheme.org/&quot;&gt;the big list of Scheme implementations on scheme.org&lt;/a&gt;! &lt;strong&gt;There &lt;em&gt;is&lt;/em&gt; an interesting runtime for TinyScheme named &lt;a href=&quot;http://www.geonius.com/software/tsion/&quot;&gt;TSION&lt;/a&gt; that is based on an I/O event loop that ends up around 280 KB in total&lt;/strong&gt;. Honestly, that&#039;s impressive enough that I should try building something with it.&lt;/p&gt;
&lt;h2 id=&quot;wren&quot;&gt;Wren&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;To my surprise, Wren manages to be smaller than Lua!&lt;/strong&gt; I don&#039;t enjoy the ceremony of its strict object-oriented nature, but I suspect it might result in more orderly code than classless languages like Lua and (original) JavaScript.&lt;/p&gt;
&lt;p&gt;My main concern with Wren, however, is that the classes that make up pretty much everything are fairly rigid--you can&#039;t just add properties whenever you feel like it. This sounds like a great design for something like a game where you have neat and tidy objects and interfaces, but for extensibility, configuration, and prototyping I&#039;m drawn more towards Lua and JavaScript&#039;s more flexible data types--despite how messy they can get. Of course, if Wren&#039;s rigid types can prevent things from blowing up at run-time as frequently as happens in Lua and JavaScript, it might be a good trade-off.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I&#039;ll need to play with Wren some more to form an actual opinion.&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;javascript&quot;&gt;JavaScript&lt;/h2&gt;
&lt;p&gt;As much as I like the good parts of modern JavaScript, the language as a whole has a lot of cruft that probably adds unnecessary bulk to implementations (e.g. block scoping, two-byte characters, the &lt;code&gt;arguments&lt;/code&gt; object). Ignoring old features, the language is also evolving at a feverish pace. I &lt;em&gt;do&lt;/em&gt; like object destrucuring and template literals, though. For now, I&#039;m setting aside the wild world of JavaScript.&lt;/p&gt;
&lt;h2 id=&quot;other-schemes-and-tcl&quot;&gt;Other Schemes (and Tcl)&lt;/h2&gt;
&lt;p&gt;I&#039;m surprised at how big the other Scheme implementations are. The main draw of Scheme for me is its simplicity, yet somehow most Schemes are JavaScript-sized. Same story for Tcl.&lt;/p&gt;
&lt;h2 id=&quot;janet&quot;&gt;Janet&lt;/h2&gt;
&lt;p&gt;And now we come to Janet. &lt;strong&gt;Janet feels like a more batteries-included Lua, with Lisp/Clojure-inspired syntax&lt;/strong&gt;. Sure it&#039;s a bit heftier, but it packs:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Parsing expression grammars&lt;/li&gt;
&lt;li&gt;Immutable data structures&lt;/li&gt;
&lt;li&gt;Macros&lt;/li&gt;
&lt;li&gt;Destructuring&lt;/li&gt;
&lt;li&gt;Multithreading&lt;/li&gt;
&lt;li&gt;Networking&lt;/li&gt;
&lt;li&gt;An event loop&lt;/li&gt;
&lt;li&gt;And more!&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I don&#039;t actually like the Clojure-inspired not-quite-as-regular-as-a-real-Lisp syntax, and I know from experience that any sort of math equations are hard to read and write in prefix notation.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;But Janet throws in practically everything you might want from a &amp;quot;small&amp;quot; language and is still as small as many Scheme implementations!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Obviously, Lisps aren&#039;t popular, but their regular syntax becomes soothing after a while. The consistent sytnax also supports structural editing more simply than other languages (not to mention live editing!). And sometimes it just seems like Lisps attract developers who care about clarity in written code.&lt;/p&gt;
&lt;p&gt;So I&#039;m a bit torn. Janet has a lot of what I want, but I can&#039;t shake the feeling that it has &lt;em&gt;too many&lt;/em&gt; features for someone who&#039;s claiming to be looking for the smallest comfortable embeddedable scripting language.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Similar to Wren and TinyScheme, I&#039;m going to need to spend some more time with Janet.&lt;/strong&gt;&lt;/p&gt;
&lt;h1 id=&quot;end-of-part-1&quot;&gt;End of part 1&lt;/h1&gt;
&lt;p&gt;Now I will abruptly end this post after only considering code size because I honestly haven&#039;t spent enough time with some of the languages to be able to comment on their level of &amp;quot;comfort&amp;quot; (or, rather, my level of comfort with using &lt;em&gt;them&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I suspect that the ultimate answer will be the one that is already staring me in the face: Lua.&lt;/strong&gt; Despite this, I&#039;d like to explore other options a bit more, just in case I&#039;m missing something truly special.&lt;/p&gt;
</content>
</entry>
<entry>
<title>Syntax highlighting for 150 languages in &lt; 200 KB</title>
<id>https://log.schemescape.com/posts/static-site-generators/luasmith-syntax-highlighting.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/static-site-generators/luasmith-syntax-highlighting.html"/>
<updated>2025-06-25T00:00:00.000Z</updated>
<summary type="text">It&#039;s not bloat if I actually use it, right?</summary>
<content type="html">&lt;p&gt;After &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/smallest-static-site-generator.html&quot;&gt;creating a (formerly) 270 KB static site generator&lt;/a&gt; and &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/extending-luasmith.html&quot;&gt;adding internal link-checking with minimal bloat&lt;/a&gt;, the feature creep continues: &lt;a href=&quot;https://github.com/jaredkrinke/luasmith&quot;&gt;luasmith&lt;/a&gt; now supports syntax highlighting for ~150 languages, thanks to &lt;a href=&quot;https://orbitalquark.github.io/scintillua/&quot;&gt;Scintillua&lt;/a&gt;--&lt;strong&gt;and it only increased the gzipped download by about 180 KB&lt;/strong&gt;!&lt;/p&gt;
&lt;p&gt;This post describes my path to adding lightweight and customizable syntax highlighting to luasmith.&lt;/p&gt;
&lt;h1 id=&quot;research&quot;&gt;Research&lt;/h1&gt;
&lt;h2 id=&quot;initial-research&quot;&gt;Initial research&lt;/h2&gt;
&lt;p&gt;My initial research on existing well-supported solutions was fruitless:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://highlightjs.org/&quot;&gt;highlight.js&lt;/a&gt; is what I used in &lt;a href=&quot;https://github.com/jaredkrinke/md2blog&quot;&gt;md2blog&lt;/a&gt;, but it required JavaScript (or at least a JS regular expression engine?) so it couldn&#039;t be trivially integrated into Lua-based luasmith&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://tree-sitter.github.io/tree-sitter/&quot;&gt;Tree-sitter&lt;/a&gt; is the undisputed king of high performance syntax highlighting, but it didn&#039;t appear to provide an interpreter (instead relying on code generation and a C compiler) -- and, honestly, it seemed like overkill for coloring a few code samples on my tiny site&lt;/li&gt;
&lt;li&gt;Most other highlighters were implemented in JavaScript, Rust, or Go, which, like highlight.js, would significantly complicate luasmith&#039;s dependency tree and build process&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;What I wanted was something either Lua-native or small but easily extensible.&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;lpeg-and-scintillua&quot;&gt;LPeg and Scintillua&lt;/h2&gt;
&lt;p&gt;The most obvious starting point for parsing in Lua is &lt;a href=&quot;https://www.inf.puc-rio.br/~roberto/lpeg/&quot;&gt;LPeg&lt;/a&gt;, from the same folks who created Lua. While investigating LPeg-based highlighters, I ran across &lt;a href=&quot;https://orbitalquark.github.io/scintillua/&quot;&gt;Scintillua&lt;/a&gt;, which supports an impressive number of languages with a minimalist approach--it&#039;s even apparently used in the lightweight &lt;a href=&quot;https://github.com/martanne/vis&quot;&gt;vis&lt;/a&gt; editor.&lt;/p&gt;
&lt;p&gt;Investigating further, I found that &lt;a href=&quot;https://orbitalquark.github.io/scintillua/api.html&quot;&gt;Scintillua was well documented&lt;/a&gt; and a sample grammar from the documentation was easy to understand. Here&#039;s that sample grammar, for reference:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-lua&quot;&gt;&lt;span class=&quot;hl-keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;
&lt;span class=&quot;hl-keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;S&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lpeg&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lpeg&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;S&lt;/span&gt;

&lt;span class=&quot;hl-keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;add_rule&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;keyword&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;KEYWORD&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;word_match&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;KEYWORD&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;add_rule&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;custom&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;custom&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;apos;quux&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;add_rule&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;identifier&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;IDENTIFIER&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;word&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;add_rule&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;string&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;STRING&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;&amp;quot;&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;add_rule&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;comment&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;COMMENT&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;to_eol&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;#&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;add_rule&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;number&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;NUMBER&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;number&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;add_rule&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;operator&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;OPERATOR&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-function&quot;&gt;S&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;+-*/%^=&amp;lt;&amp;gt;,.()[]{}&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;add_fold_point&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;OPERATOR&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;apos;{&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;apos;}&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;set_word_list&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;KEYWORD&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;foo&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;apos;bar&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;apos;baz&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;hl-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Given that Scintillua used one tenth the code of highlight.js and was Lua-native and well documented, it was exactly what I was looking for.&lt;/strong&gt;&lt;/p&gt;
&lt;h1 id=&quot;implementation&quot;&gt;Implementation&lt;/h1&gt;
&lt;h2 id=&quot;highlighting-code-blocks&quot;&gt;Highlighting code blocks&lt;/h2&gt;
&lt;p&gt;For maximum efficiency, I would have hooked syntax highlighting directly into &lt;a href=&quot;https://github.com/mity/md4c&quot;&gt;md4c&lt;/a&gt; (the Markdown parser luasmith uses), so that it would syntax-highlight code as it is parsed. That might have required creating a callback mechanism for md4c, leading to Lua-calling-into-C-calling-into-Lua messiness.&lt;/p&gt;
&lt;p&gt;In pursuit of relentless &lt;del&gt;laziness&lt;/del&gt; simplicity, I instead used &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/extending-luasmith.html&quot;&gt;the trivial HTML parser I previous created for link-checking&lt;/a&gt; to find &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; and &lt;code&gt;&amp;lt;code&amp;gt;&lt;/code&gt; blocks with &lt;code&gt;language-*&lt;/code&gt; CSS classes on them, and funneled those into Scintillua. This resulted in maybe a page of simple Lua code, as opposed to probably a few hundred lines of tricky C-Lua integration code in the &amp;quot;optimal&amp;quot; implementation. &lt;strong&gt;I guess the &amp;quot;efficiency&amp;quot; I optimized for was &amp;quot;time to produce a working tool, with acceptable performance&amp;quot;, rather than strict runtime performance&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Aside: given that this approach used HTML as input, it would be trivial to use it to create a tool that adds syntax highlighting to hand-authored HTML files, or even a tool that adds syntax highlighting as &lt;code&gt;&amp;lt;b&amp;gt;&lt;/code&gt;, &lt;code&gt;&amp;lt;i&amp;gt;&lt;/code&gt;, etc. tags instead of &lt;code&gt;&amp;lt;span&amp;gt;&lt;/code&gt;&#039;s, so that text mode browsers like Lynx or w3m could enjoy the fun!&lt;/p&gt;
&lt;h2 id=&quot;loading-grammars&quot;&gt;Loading grammars&lt;/h2&gt;
&lt;p&gt;Rather than ship a zip with 100+ Lua files from Scintillua, I decided to embed all those scripts directly into the executable (with the ability to override them, as needed). &lt;strong&gt;This allowed me to ship a single static binary&lt;/strong&gt; (my preferred packaging method for one-off tools).&lt;/p&gt;
&lt;p&gt;The only trick was that Scintillua, in its library form, implemented its own file search and load system based on probing files with Lua&#039;s &lt;code&gt;loadfile&lt;/code&gt; function. I ended up wrapping &lt;code&gt;loadfile&lt;/code&gt; with some code to detect Scintillua&#039;s calls and point them at the embedded strings (which are lazily loaded into Lua). In general, I dislike Lua&#039;s file-loading infrastructure, but I understand that they&#039;re limited by the C standard library--specifically, its lack of file enumeration support.&lt;/p&gt;
&lt;h2 id=&quot;result&quot;&gt;Result&lt;/h2&gt;
&lt;p&gt;In the end, adding in LPeg, Scintillua, almost all its grammars, and glue code only added around 175 KB to the (gzip-compressed) tarball (a 67% increase--not as bad as I originally feared). Even better, syntax highlighting for my blog only increased the generation time by around 50% (roughly 1 millisecond per page, on my 2013 laptop).&lt;/p&gt;
&lt;p&gt;Finally, I had a small and simple static site generator that did what I wanted!&lt;/p&gt;
&lt;h1 id=&quot;bonus-authoring-an-etlua-grammar&quot;&gt;Bonus: authoring an etlua grammar&lt;/h1&gt;
&lt;p&gt;One aspect of Scintillua that hooked me was that adding new grammars simply required writing some Lua code, using the LPeg library. I had not actually used LPeg before, but &lt;a href=&quot;https://www.inf.puc-rio.br/~roberto/lpeg/&quot;&gt;its documentation&lt;/a&gt; was easy to understand (and there&#039;s also &lt;a href=&quot;https://leafo.net/guides/parsing-expression-grammars.html&quot;&gt;a great LPeg tutorial on leafo.net&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;Given that luasmith uses &lt;a href=&quot;https://github.com/leafo/etlua&quot;&gt;etlua&lt;/a&gt; for templates, I thought it would be fun to write a syntax highlighter for etlua.&lt;/p&gt;
&lt;h2 id=&quot;structure&quot;&gt;Structure&lt;/h2&gt;
&lt;p&gt;Scintillua&#039;s documentation provides &lt;a href=&quot;https://orbitalquark.github.io/scintillua/api.html#embedded-lexers&quot;&gt;information and examples for embedding one parser within another&lt;/a&gt;. In the case of etlua, I&#039;m assuming Lua code will always be embedded in HTML, so an etlua parser should simply be an HTML parser with Lua embedded between &lt;code&gt;&amp;lt;%&lt;/code&gt; ... &lt;code&gt;%&amp;gt;&lt;/code&gt; tags. The author of Scintillua even pointed out to me that there&#039;s already a very similar parser: &lt;a href=&quot;https://github.com/orbitalquark/scintillua/blob/default/lexers/rhtml.lua&quot;&gt;RHTML&lt;/a&gt; (Ruby in HTML).&lt;/p&gt;
&lt;h2 id=&quot;implementation-1&quot;&gt;Implementation&lt;/h2&gt;
&lt;p&gt;Using the RHTML parser as a starting point, it was simply a matter of including the appropriate start and end tags (note: LPeg uses Lua metatables for repurposing arithmetic operations as parsing expression grammar building blocks, e.g. &lt;code&gt;^-1&lt;/code&gt; means &amp;quot;at most one&amp;quot;, &lt;code&gt;*&lt;/code&gt; means &amp;quot;concatenation&amp;quot;, and &lt;code&gt;+&lt;/code&gt; means &amp;quot;alternation/or&amp;quot; -- and &lt;code&gt;lpeg.P(...)&lt;/code&gt; just matches string literals). Here&#039;s the trivial parser:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-lua&quot;&gt;&lt;span class=&quot;hl-keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;
&lt;span class=&quot;hl-keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;S&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lpeg&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lpeg&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;S&lt;/span&gt;

&lt;span class=&quot;hl-comment&quot;&gt;-- Base on the existing HTML parser&lt;/span&gt;
&lt;span class=&quot;hl-keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;inherit&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;html&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;hl-comment&quot;&gt;-- Embed the existing Lua parser&lt;/span&gt;
&lt;span class=&quot;hl-keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lua&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;lua&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;hl-comment&quot;&gt;-- Specify `&amp;lt;%` and `%&amp;gt;` (and highlight the tags as &amp;quot;preprocessor directives&amp;quot;)&lt;/span&gt;
&lt;span class=&quot;hl-keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;start_rule&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;PREPROCESSOR&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;apos;&amp;lt;%&amp;apos;&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;=&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;hl-function&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;-&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;hl-number&quot;&gt;-1&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;hl-keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;end_rule&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;tag&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lexer&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;PREPROCESSOR&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-function&quot;&gt;P&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;apos;-&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;^&lt;/span&gt;&lt;span class=&quot;hl-number&quot;&gt;-1&lt;/span&gt; &lt;span class=&quot;hl-operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;apos;%&amp;gt;&amp;apos;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;hl-comment&quot;&gt;-- Highlight contained code as Lua&lt;/span&gt;
&lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;embed&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;lua&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;start_rule&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;end_rule&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;hl-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;lex&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;result-1&quot;&gt;Result&lt;/h2&gt;
&lt;p&gt;Finally, here is an example of a highlighted etlua template:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-etlua&quot;&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;ul&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hl-preprocessor&quot;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;item&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;hl-function&quot;&gt;ipairs&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-function&quot;&gt;sortBy&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;items&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-string&quot;&gt;&amp;quot;date&amp;quot;&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;hl-preprocessor&quot;&gt;-%&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hl-tag&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;li&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;hl-attribute&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;hl-string&quot;&gt;&amp;quot;&amp;lt;%= item.path %&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hl-preprocessor&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;hl-identifier&quot;&gt;item&lt;/span&gt;&lt;span class=&quot;hl-operator&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;hl-identifier&quot;&gt;title&lt;/span&gt; &lt;span class=&quot;hl-preprocessor&quot;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;li&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hl-preprocessor&quot;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&quot;hl-keyword&quot;&gt;end&lt;/span&gt; &lt;span class=&quot;hl-preprocessor&quot;&gt;-%&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hl-tag&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;ul&lt;/span&gt;&lt;span class=&quot;hl-tag&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Notice that &lt;code&gt;for i, item in ipairs(...)&lt;/code&gt; is highlighted as Lua code, while the surrounding HTML is highlighted as HTML. Of course, this also reveals a limitation of Sctinllua&#039;s nesting approach in that the &lt;code&gt;item.path&lt;/code&gt; Lua code that&#039;s inside an HTML attribute is just treated as part of the HTML attribute, i.e. a string. Not perfect, but also not a big deal for, essentially, ornamentation.&lt;/p&gt;
&lt;p&gt;Overall, it works pretty well, while remaining small and simple.&lt;/p&gt;
&lt;h1 id=&quot;further-reading&quot;&gt;Further reading&lt;/h1&gt;
&lt;p&gt;If a minimal, Lua-based static site generator sounds good to you, &lt;a href=&quot;https://github.com/jaredkrinke/luasmith&quot;&gt;give luasmith a look&lt;/a&gt;. Note that it&#039;s still &amp;quot;alpha&amp;quot; quality, and is likely to remain that way unless it miraculously becomes internet famous.&lt;/p&gt;
&lt;p&gt;Example sites are here:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://log.schemescape.com/&quot;&gt;This blog&lt;/a&gt; (&lt;a href=&quot;https://github.com/jaredkrinke/log&quot;&gt;source&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://jaredkrinke.github.io/til/&quot;&gt;List of small things I&#039;ve learned&lt;/a&gt; (&lt;a href=&quot;https://github.com/jaredkrinke/til&quot;&gt;source&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note: The latter repository contains &lt;a href=&quot;https://github.com/jaredkrinke/til/blob/main/readme.lua&quot;&gt;a simple self-contained luasmith &amp;quot;template&amp;quot; (script) for generating its README file&lt;/a&gt;.&lt;/p&gt;
</content>
</entry>
<entry>
<title>luasmith gets link-checking and improved Atom feeds</title>
<id>https://log.schemescape.com/posts/static-site-generators/extending-luasmith.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/static-site-generators/extending-luasmith.html"/>
<updated>2025-06-01T00:00:00.000Z</updated>
<summary type="text">Feature creep has set in for my ~270 KB static site generator, luasmith.</summary>
<content type="html">&lt;p&gt;Recently, I created &lt;a href=&quot;https://github.com/jaredkrinke/luasmith&quot;&gt;luasmith&lt;/a&gt;, &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/smallest-static-site-generator.html&quot;&gt;a ~270 KB static site generator&lt;/a&gt;, with a focus on being small and simple. Obviously, I am now recklessly stuffing it with features.&lt;/p&gt;
&lt;h1 id=&quot;bloat&quot;&gt;&amp;quot;Bloat&amp;quot;&lt;/h1&gt;
&lt;p&gt;The initial version of luasmith lacked some functionality I valued from &lt;a href=&quot;https://jaredkrinke.github.io/md2blog/&quot;&gt;md2blog&lt;/a&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Checking for broken internal links (including hashes/fragments/anchors)&lt;/li&gt;
&lt;li&gt;Including post content directly within the Atom feed&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Now, the latest release of luasmith includes these features, and there&#039;s good news from a bloat perspective:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;These additions &lt;strong&gt;only added ~3 KB to the (compressed) size of the release&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Generating my blog still takes &amp;lt; 200 ms&lt;/strong&gt;, on an old laptop (though it &lt;em&gt;is&lt;/em&gt; ~20% slower, in relative terms)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;why-now-how&quot;&gt;Why now? How?&lt;/h1&gt;
&lt;p&gt;The reason luasmith didn&#039;t originally include these features, despite their utility, is that they require &lt;strong&gt;additional parsing&lt;/strong&gt; (well... you could maybe hook into the Markdown parser, but, besides tight coupling, it wouldn&#039;t work outside of Markdown). For link-checking, it&#039;s obvious why parsing is required. For Atom feed content, the reason is that most RSS/Atom readers don&#039;t support adjusting relative links using &lt;a href=&quot;https://www.w3.org/TR/xmlbase/&quot;&gt;xml:base&lt;/a&gt;, so relative links from e.g. &lt;code&gt;posts/topic/foo.html&lt;/code&gt; won&#039;t work without modification when viewed from &lt;code&gt;posts/feed.xml&lt;/code&gt; (which is in a different directory). (My solution is to rewrite relative links.)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Rather than pull in some heavyweight parsing library, I decided to roll my own minimal HTML parser/transformer: &lt;a href=&quot;https://github.com/jaredkrinke/chtml&quot;&gt;chtml&lt;/a&gt;&lt;/strong&gt;. It&#039;s probably deficient and definitely poorly documented, but it seems to work.&lt;/p&gt;
&lt;h2 id=&quot;lua&quot;&gt;Lua&lt;/h2&gt;
&lt;p&gt;Once again, I&#039;ve found C and Lua to be a comfortable combination. I wasn&#039;t looking forward to writing string manipulation code in C, but I had no need to fear--I just pushed all string manipulation into the somewhat safer world of Lua. Problem &lt;del&gt;solved&lt;/del&gt; avoided!&lt;/p&gt;
&lt;p&gt;Having said that, &lt;strong&gt;I&#039;m still trying to decide how I &lt;em&gt;really&lt;/em&gt; feel about Lua&lt;/strong&gt;. On the one hand, I like that I can easily integrate C code, leading to a process where I write performance-critical code in C and everything else in Lua. This combination provides both convenience and performance. &lt;em&gt;But&lt;/em&gt; I am starting to wonder if it would make more sense to just write &lt;em&gt;everything&lt;/em&gt; in a more featureful language and then rely on a JIT to make things fast. Yes, I&#039;m talking about TypeScript/JavaScript and Node.js. &lt;strong&gt;It frustrates me to pull in such a huge engineering effort (V8), just to make my own developer life a bit more convenient&lt;/strong&gt;... but I can see why businesses are constantly making that choice. Of course, I also dislike these businesses&#039; bloated results, so I don&#039;t necessarily &lt;em&gt;agree&lt;/em&gt; with their logic. Like I said: still pondering.&lt;/p&gt;
&lt;h1 id=&quot;the-last-biggest-challenge&quot;&gt;The last, biggest challenge&lt;/h1&gt;
&lt;p&gt;Annoyingly, I&#039;m still not at the point where I can fully replace md2blog because I like build-time syntax highlighting for code blocks. md2blog uses &lt;a href=&quot;https://highlightjs.org/&quot;&gt;highlight.js&lt;/a&gt; for syntax highlighting, and it was super convenient to integrate with Node and Deno. But luasmith is built on C and Lua instead of JavaScript, so highlight.js doesn&#039;t really have a place to plug in. Embedding QuickJS just for highlight.js would contradict my simplicity goal, so I need a different solution. Sadly, most syntax highlighting solutions seem to be based on JavaScript. Or Rust, which I am also avoiding for this side project, due to complexity. It&#039;s almost certainly misguided, but, &lt;strong&gt;for hobbies, I&#039;d like to stick to a software stack that I feel like I can at least ever have a hope of understanding in its entirety&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Maybe some day I will work up the nerve to integrate &lt;a href=&quot;https://github.com/tree-sitter/tree-sitter&quot;&gt;Tree-sitter&lt;/a&gt; and a bunch of associated grammars, to add syntax highlighting (bringing luasmith into build-time featuer parity with md2blog), but I&#039;m sure that will massively increase the size and (internal) complexity of luasmith. Or perhaps I can write an optional, external tool that is purpose-built for syntax highlighting. We&#039;ll see...&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update&lt;/strong&gt;: Syntax highlighting &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/luasmith-syntax-highlighting.html&quot;&gt;is now implemlented in luasmith&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;addendum-with-actual-bloat&quot;&gt;Addendum, with actual bloat&lt;/h2&gt;
&lt;p&gt;I learned that Tree-sitter &lt;a href=&quot;https://tree-sitter.github.io/tree-sitter/cli/index.html&quot;&gt;has a command line interface&lt;/a&gt;. Problem solved, right? Let&#039;s install and find out:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ sudo apt install tree-sitter-cli
Reading package lists... Done
...
The following additional packages will be installed:
  binaryen clang-15 emscripten gyp libcares2 libclang-common-15-dev libclang-cpp15t64 libclang-rt-15-dev libclang1-15t64 libjs-d3 libjs-inherits libllvm15t64 libnode-dev libnode109 lld-15 llvm-15 llvm-15-dev llvm-15-linker-tools
  llvm-15-runtime llvm-15-tools node-abbrev node-acorn node-agent-base node-ansi-regex node-ansi-styles node-aproba node-are-we-there-yet node-balanced-match node-brace-expansion node-busboy node-chownr node-cjs-module-lexer node-clone
  node-color-convert node-color-name node-console-control-strings node-core-util-is node-data-uri-to-buffer node-debug node-defaults node-delegates node-encoding node-fancy-log node-fetch node-fs.realpath node-gauge node-glob
  node-graceful-fs node-gyp node-has-unicode node-https-proxy-agent node-iconv-lite node-inflight node-inherits node-isarray node-isexe node-jsonparse node-lru-cache node-minimatch node-minipass node-mkdirp node-ms node-nopt node-npmlog
  node-once node-osenv node-process-nextick-args node-readable-stream node-rimraf node-safe-buffer node-semver node-set-blocking node-signal-exit node-slice-ansi node-string-decoder node-string-width node-strip-ansi node-tar
  node-time-stamp node-undici node-util-deprecate node-wcwidth.js node-which node-wide-align node-wrappy node-xtend node-yallist nodejs nodejs-doc python3-numpy
...
0 upgraded, 91 newly installed, 0 to remove and 75 not upgraded.
Need to get 228 MB of archives.
After this operation, 1,594 MB of additional disk space will be used.
Do you want to continue? [Y/n] n
Abort.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;That&#039;s nearly 1.6 GB of disk space for a Tree-sitter CLI&lt;/strong&gt;. I&#039;m speechless. I guess it&#039;s written in JavaScript for Node.js, so that explains ~100 MB of it. But why does it need LLVM? Emscripten?? NumPy???&lt;/p&gt;
&lt;p&gt;I suspect this is mostly related to Node.js native modules (and perhaps how they&#039;re packaged on Debian, specifically), but... &lt;strong&gt;I just can&#039;t deal with this level of bloat&lt;/strong&gt;.&lt;/p&gt;
</content>
</entry>
</feed>
