<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
<title>Schemescape</title>
<id>https://log.schemescape.com/</id>
<link rel="self" href="https://log.schemescape.com/feed.xml"/>
<link rel="alternate" href="https://log.schemescape.com/"/>
<author>
<name>Schemescape</name>
</author>
<updated>2023-11-15T18:29:10.847Z</updated>

<entry>
<title>Investigating slow file enumeration in SBCL on Windows</title>
<id>https://log.schemescape.com/posts/lisp/sbcl-file-perf-windows.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/lisp/sbcl-file-perf-windows.html"/>
<updated>2023-11-14T00:00:00.000Z</updated>
<summary type="text">Is file enumeration when using SBCL on Windows so slow that it can&apos;t support a fast static site generator? Yes and no.</summary>
<content type="html">&lt;p&gt;While experimenting to see if I could improve upon &lt;a href=&quot;https://log.schemescape.com/posts/lisp/../static-site-generators/speeding-up-rebuilds-4.html&quot;&gt;the performance of md2blog&lt;/a&gt; using Common Lisp (and a fancier design), I noticed that &lt;strong&gt;file enumeration in &lt;a href=&quot;https://www.sbcl.org/&quot;&gt;Steel Bank Common Lisp&lt;/a&gt; (on Windows) was slow&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Spoiler: it can be a &lt;em&gt;lot&lt;/em&gt; faster (for my scenario, at least).&lt;/p&gt;
&lt;h1 id=&quot;the-problem&quot;&gt;The problem&lt;/h1&gt;
&lt;p&gt;Obviously, I shouldn&amp;#39;t be wasting my time building a new static site generator, with precise incremental builds. Also, obviously, I am.&lt;/p&gt;
&lt;p&gt;Since I&amp;#39;ve gotten &lt;a href=&quot;https://log.schemescape.com/posts/lisp/../static-site-generators/speeding-up-rebuilds-4.html#results&quot;&gt;live rebuilds of md2blog down to 50 milliseconds on my desktop&lt;/a&gt;, there&amp;#39;s not a lot of room for inefficiency when trying to improve performance. Unfortunately, my initial experiments using SBCL showed that &lt;strong&gt;just &lt;em&gt;enumerating&lt;/em&gt; files (no processing whatsoever) took up my entire 50 millisecond budget&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;I tried simplifying my code so that it only used built-in directory/pathname functions:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-lisp&quot;&gt;(&lt;span class=&quot;hljs-name&quot;&gt;defparameter&lt;/span&gt; *wildcard-pathname* (&lt;span class=&quot;hljs-name&quot;&gt;make-pathname&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:name&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:wild&lt;/span&gt;
                                                 &lt;span class=&quot;hljs-symbol&quot;&gt;:type&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:wild&lt;/span&gt;))

(&lt;span class=&quot;hljs-name&quot;&gt;defun&lt;/span&gt; enumerate-files (&lt;span class=&quot;hljs-name&quot;&gt;directory&lt;/span&gt;)
  (&lt;span class=&quot;hljs-name&quot;&gt;let&lt;/span&gt; ((&lt;span class=&quot;hljs-name&quot;&gt;items&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;list&lt;/span&gt; directory))
        (&lt;span class=&quot;hljs-name&quot;&gt;files&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;nil&lt;/span&gt;))
    (&lt;span class=&quot;hljs-name&quot;&gt;loop&lt;/span&gt; while items do
      (&lt;span class=&quot;hljs-name&quot;&gt;let&lt;/span&gt; ((&lt;span class=&quot;hljs-name&quot;&gt;item&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;pop&lt;/span&gt; items)))
        (&lt;span class=&quot;hljs-name&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;pathname-name&lt;/span&gt; item)
            (&lt;span class=&quot;hljs-name&quot;&gt;push&lt;/span&gt; item files)
            (&lt;span class=&quot;hljs-name&quot;&gt;loop&lt;/span&gt; for child in (&lt;span class=&quot;hljs-name&quot;&gt;directory&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;merge-pathnames&lt;/span&gt; *wildcard-pathname* item)) do
              (&lt;span class=&quot;hljs-name&quot;&gt;push&lt;/span&gt; child items)))))
    files))
&lt;/code&gt;&lt;/pre&gt;
&lt;h1 id=&quot;investigation&quot;&gt;Investigation&lt;/h1&gt;
&lt;h2 id=&quot;is-it-just-windows&quot;&gt;Is it just Windows?&lt;/h2&gt;
&lt;p&gt;As a sanity check, I ran the same scenario under SBCL on Linux on a &lt;em&gt;much&lt;/em&gt; slower computer (Intel Atom, rotational drive)... but the performance was the same: 50 milliseconds. Could Windows really be so slow that my fancy desktop is as slow as an old netbook?&lt;/p&gt;
&lt;p&gt;No, that can&amp;#39;t be. I can enumerate all these files using &lt;a href=&quot;https://deno.com/&quot;&gt;Deno&lt;/a&gt; in 5 milliseconds (that&amp;#39;s what md2blog does, after all).&lt;/p&gt;
&lt;h2 id=&quot;is-it-just-overhead&quot;&gt;Is it just overhead?&lt;/h2&gt;
&lt;p&gt;So if the problem is &lt;em&gt;not&lt;/em&gt; Windows, maybe the problem is SBCL (or Common Lisp itself). Fortunately, Common Lisp has a built-in &lt;code&gt;time&lt;/code&gt; function to measure time spent in a function.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-lisp&quot;&gt;(&lt;span class=&quot;hljs-name&quot;&gt;time&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;enumerate-files&lt;/span&gt; #p&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;../../log/content/&amp;quot;&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Reports:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-txt&quot;&gt;Evaluation took:
  0.054 seconds of real time
  0.046875 seconds of total run time (0.000000 user, 0.046875 system)
  87.04% CPU
  186,748,133 processor cycles
  425,088 bytes consed
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Hmmm... no &amp;quot;user&amp;quot; time and all &amp;quot;system&amp;quot; time? Blaming the system seems a little suspicious, given that this code runs 10x slower than Deno&amp;#39;s baseline.&lt;/p&gt;
&lt;p&gt;I thought this might be a great time to test out &lt;a href=&quot;http://www.sbcl.org/manual/#Statistical-Profiler&quot;&gt;SBCL&amp;#39;s statistical profiler&lt;/a&gt;, but it turns out it&amp;#39;s &lt;a href=&quot;https://github.com/sbcl/sbcl/blob/a9abb1c41c457e9299b53f75b4196d3014432c9b/contrib/sb-sprof/interface.lisp#L224&quot;&gt;not implemented on Windows&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;is-sbcl-using-the-wrong-api&quot;&gt;Is SBCL using the wrong API?&lt;/h2&gt;
&lt;p&gt;Maybe SBCL is correctly reporting that virtually the entire time is spent in system calls because it&amp;#39;s using an inefficient API?&lt;/p&gt;
&lt;p&gt;After locating a searchable version of its source, I found that SBCL &lt;a href=&quot;https://github.com/sbcl/sbcl/blob/a9abb1c41c457e9299b53f75b4196d3014432c9b/src/code/win32.lisp#L534&quot;&gt;is using FindFirstile&lt;/a&gt;. There &lt;em&gt;is&lt;/em&gt; a &lt;code&gt;FindFirstFileEx&lt;/code&gt; which offers at least one minor optimization, but I don&amp;#39;t see Rust/Deno using it, so that&amp;#39;s probably not the issue.&lt;/p&gt;
&lt;h1 id=&quot;reassessing&quot;&gt;Reassessing&lt;/h1&gt;
&lt;p&gt;SBCL indicates that the operating system is the bottleneck, but it&amp;#39;s calling &lt;code&gt;FindFirstFile&lt;/code&gt;--same as Deno. Maybe there are some &lt;em&gt;other&lt;/em&gt; system calls I didn&amp;#39;t notice?&lt;/p&gt;
&lt;p&gt;Time to just inspect the system and see what&amp;#39;s happening!&lt;/p&gt;
&lt;h2 id=&quot;debugging&quot;&gt;Debugging&lt;/h2&gt;
&lt;p&gt;I don&amp;#39;t recommend this approach, but since I already had WinDbg installed, I attached WinDbg to sbcl.exe and set a breakpoint on everything in kernel32.dll (&lt;code&gt;bm kernel32!*&lt;/code&gt;), let the program run, and kept track of which functions were hit (disabling each breakpoint afterwards).&lt;/p&gt;
&lt;p&gt;These functions sounded relevant:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;FindFirstFileW&lt;/li&gt;
&lt;li&gt;GetFileAttributesExW&lt;/li&gt;
&lt;li&gt;GetLongPathNameW&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I wasn&amp;#39;t familiar with that last one (&lt;code&gt;GetLongPathName&lt;/code&gt;), but apparently it&amp;#39;s for &lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getlongpathnamea&quot;&gt;converting from &amp;quot;short&amp;quot; (DOS-style 8.3) file names (e.g. &amp;quot;progra~1&amp;quot;) to &amp;quot;long&amp;quot; file names&lt;/a&gt;. Honestly, this is the first time I&amp;#39;ve had to think about short file names in at least a decade.&lt;/p&gt;
&lt;p&gt;New question: &lt;strong&gt;which (if any) of these functions is slow?&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;windows-performance-recorderanalyzer&quot;&gt;Windows Performance Recorder/Analyzer&lt;/h2&gt;
&lt;p&gt;In the past, I&amp;#39;ve used &lt;a href=&quot;https://learn.microsoft.com/en-us/windows-hardware/test/wpt/windows-performance-analyzer&quot;&gt;Windows Performance Analyzer&lt;/a&gt; for this sort of problem. Conveniently, &lt;strong&gt;Microsoft now bundles Windows Performance Analyzer (a 15 MB tool) along with a million other things I doubt I&amp;#39;ll ever use in a tidy little 4 GB download&lt;/strong&gt;. I&amp;#39;d think it would be in their best interest to separate these tools in order to reduce the bandwidth needed to deliver basic performance analysis tools, but what do I know?&lt;/p&gt;
&lt;p&gt;Using Windows Performance Recorder&amp;#39;s generic profile, I captured a several second trace of file enumeration via SBCL. Opening the trace and looking at the &amp;quot;CPU Usage (Sampled)&amp;quot; chart (and filtering to &amp;quot;sbcl.exe&amp;quot;--with symbol loading enabled), I see the following sample counts by stack:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-txt&quot;&gt;Line #, Process, Stack, Count
1, sbcl.exe (34020), , 1581
2, , [Root], 1579
3, ,   |- ?!?, 1576
4, ,   |    |- kernel32.dll!GetLongPathNameW, 1299
5, ,   |    |- KernelBase.dll!GetFileAttributesExW, 155
6, ,   |    |- ?!?&amp;lt;itself&amp;gt;, 75
7, ,   |    |- KernelBase.dll!FindNextFileW, 16
8, ,   |    |- KernelBase.dll!FindFirstFileW, 14
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Looks like the vast majority of samples are in &lt;code&gt;GetLongPathName&lt;/code&gt;, with a significant chunk in &lt;code&gt;GetFileAttributesEx&lt;/code&gt;. I&amp;#39;m still not entirely clear why these are necessary. Maybe the Common Lisp spec specifies that &lt;code&gt;DIRECTORY&lt;/code&gt; must return absolute paths? I don&amp;#39;t see anything like that in the &lt;a href=&quot;http://clhs.lisp.se/Body/f_dir.htm&quot;&gt;Common Lisp HyperSpec entry for DIRECTORY&lt;/a&gt;, but I definitely don&amp;#39;t know what I&amp;#39;m talking about, so I&amp;#39;ll just stop speculating.&lt;/p&gt;
&lt;h2 id=&quot;debugging-sbcl-with-itself&quot;&gt;Debugging SBCL with itself&lt;/h2&gt;
&lt;p&gt;While exploring &lt;a href=&quot;https://github.com/sbcl/sbcl/blob/a9abb1c41c457e9299b53f75b4196d3014432c9b/src/code/win32.lisp&quot;&gt;SBCL&amp;#39;s Win32 code&lt;/a&gt;, I decided to try debugging SBCL using itself:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Download a copy of SBCL 2.3.2&amp;#39;s source code&lt;/li&gt;
&lt;li&gt;Open it in Emacs (with SLIME)&lt;/li&gt;
&lt;li&gt;Add a call to &lt;code&gt;BREAK&lt;/code&gt; within a function of interest&lt;/li&gt;
&lt;li&gt;Ctrl+C, Ctrl+C to recompile the function&lt;/li&gt;
&lt;li&gt;Run file enumeration code&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The breakpoint was hit! Of course, after that I tried to remove the breakpoint and recompile, but the recompilation process started hitting breakpoints related to the function of SLIME/SBCL itself. So maybe messing with SBCL&amp;#39;s internals isn&amp;#39;t always a great approach. It&amp;#39;s still neat that you can tinker with SBCL&amp;#39;s internals without any external tools (Emacs+SLIME make it easier, but are not &lt;em&gt;required&lt;/em&gt;).&lt;/p&gt;
&lt;h1 id=&quot;solution&quot;&gt;Solution?&lt;/h1&gt;
&lt;h2 id=&quot;initial-attempt&quot;&gt;Initial attempt&lt;/h2&gt;
&lt;p&gt;As an initial attempt to speed up file enumeration, I decided to just directly call SBCL&amp;#39;s internal Win32 function that uses &lt;code&gt;FindFirstFile&lt;/code&gt;/&lt;code&gt;FindNextFile&lt;/code&gt;. The function is named &lt;code&gt;native-call-with-directory-iterator&lt;/code&gt;, and here&amp;#39;s the (surprisingly readable, other than the convoluted callback convention) definition:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-lisp&quot;&gt;(&lt;span class=&quot;hljs-name&quot;&gt;defun&lt;/span&gt; native-call-with-directory-iterator (&lt;span class=&quot;hljs-name&quot;&gt;function&lt;/span&gt; namestring errorp)
  (&lt;span class=&quot;hljs-name&quot;&gt;declare&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;type&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;or&lt;/span&gt; null string) namestring)
           (&lt;span class=&quot;hljs-name&quot;&gt;function&lt;/span&gt; function))
  (&lt;span class=&quot;hljs-name&quot;&gt;when&lt;/span&gt; namestring
    (&lt;span class=&quot;hljs-name&quot;&gt;with-alien&lt;/span&gt; ((&lt;span class=&quot;hljs-name&quot;&gt;find-data&lt;/span&gt; find-data))
      (&lt;span class=&quot;hljs-name&quot;&gt;with-handle&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;handle&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;syscall&lt;/span&gt; ((&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;FindFirstFile&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;t&lt;/span&gt;) handle
                                     system-string find-data)
                                    (&lt;span class=&quot;hljs-name&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;eql&lt;/span&gt; result invalid-handle)
                                        (&lt;span class=&quot;hljs-name&quot;&gt;if&lt;/span&gt; errorp
                                            (&lt;span class=&quot;hljs-name&quot;&gt;win32-error&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;FindFirstFile&amp;quot;&lt;/span&gt;)
                                            (&lt;span class=&quot;hljs-name&quot;&gt;return&lt;/span&gt;))
                                        result)
                                    (&lt;span class=&quot;hljs-name&quot;&gt;concatenate&lt;/span&gt; &amp;#x27;string
                                                 namestring &lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;*.*&amp;quot;&lt;/span&gt;)
                                    find-data)
                    &lt;span class=&quot;hljs-symbol&quot;&gt;:close-operator&lt;/span&gt; find-close)
        (&lt;span class=&quot;hljs-name&quot;&gt;let&lt;/span&gt; ((&lt;span class=&quot;hljs-name&quot;&gt;more&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;t&lt;/span&gt;))
          (&lt;span class=&quot;hljs-name&quot;&gt;dx-flet&lt;/span&gt; ((&lt;span class=&quot;hljs-name&quot;&gt;one-iter&lt;/span&gt; ()
                      (&lt;span class=&quot;hljs-name&quot;&gt;tagbody&lt;/span&gt;
                       &lt;span class=&quot;hljs-symbol&quot;&gt;:next&lt;/span&gt;
                         (&lt;span class=&quot;hljs-name&quot;&gt;when&lt;/span&gt; more
                           (&lt;span class=&quot;hljs-name&quot;&gt;let&lt;/span&gt; ((&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;decode-system-string&lt;/span&gt;
                                        (&lt;span class=&quot;hljs-name&quot;&gt;slot&lt;/span&gt; find-data &amp;#x27;long-name)))
                                 (&lt;span class=&quot;hljs-name&quot;&gt;attributes&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;slot&lt;/span&gt; find-data &amp;#x27;attributes)))
                             (&lt;span class=&quot;hljs-name&quot;&gt;setf&lt;/span&gt; more
                                   (&lt;span class=&quot;hljs-name&quot;&gt;syscall&lt;/span&gt; ((&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;FindNextFile&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;t&lt;/span&gt;) lispbool
                                             handle find-data) result
                                             handle find-data))
                             (&lt;span class=&quot;hljs-name&quot;&gt;cond&lt;/span&gt; ((&lt;span class=&quot;hljs-name&quot;&gt;equal&lt;/span&gt; name &lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;) (&lt;span class=&quot;hljs-name&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:next&lt;/span&gt;))
                                   ((&lt;span class=&quot;hljs-name&quot;&gt;equal&lt;/span&gt; name &lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;..&amp;quot;&lt;/span&gt;) (&lt;span class=&quot;hljs-name&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:next&lt;/span&gt;))
                                   (&lt;span class=&quot;hljs-name&quot;&gt;t&lt;/span&gt;
                                    (&lt;span class=&quot;hljs-name&quot;&gt;return-from&lt;/span&gt; one-iter
                                      (&lt;span class=&quot;hljs-name&quot;&gt;values&lt;/span&gt; name
                                              (&lt;span class=&quot;hljs-name&quot;&gt;attribute-file-kind&lt;/span&gt;
                                               attributes))))))))))
            (&lt;span class=&quot;hljs-name&quot;&gt;funcall&lt;/span&gt; function #&amp;#x27;one-iter)))))))
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Interestingly, the callback receives both the file system item&amp;#39;s name, as well as its &amp;quot;kind&amp;quot; (&lt;code&gt;:file&lt;/code&gt; or &lt;code&gt;:directory&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Here&amp;#39;s my sloppy code (note to self: make it more obvious which variables are &amp;quot;namestrings&amp;quot; versus &amp;quot;pathnames&amp;quot;):&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-lisp&quot;&gt;(&lt;span class=&quot;hljs-name&quot;&gt;defun&lt;/span&gt; for-each-item-in-directory (&lt;span class=&quot;hljs-name&quot;&gt;function&lt;/span&gt; directory)
  &lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;Calls FUNCTION with (string, (or :file :directory)) for each item in DIRECTORY&amp;quot;&lt;/span&gt;
  (&lt;span class=&quot;hljs-name&quot;&gt;declare&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;type&lt;/span&gt; function function))
  (&lt;span class=&quot;hljs-name&quot;&gt;sb-win32&lt;/span&gt;:&lt;span class=&quot;hljs-symbol&quot;&gt;:native-call-with-directory-iterator&lt;/span&gt;
   (&lt;span class=&quot;hljs-name&quot;&gt;lambda&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;next&lt;/span&gt;)
     (&lt;span class=&quot;hljs-name&quot;&gt;declare&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;type&lt;/span&gt; function next))
     (&lt;span class=&quot;hljs-name&quot;&gt;loop&lt;/span&gt; for (&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt; kind) = (&lt;span class=&quot;hljs-name&quot;&gt;multiple-value-list&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;funcall&lt;/span&gt; next))
           while name
           do (&lt;span class=&quot;hljs-name&quot;&gt;funcall&lt;/span&gt; function name kind)))
   (&lt;span class=&quot;hljs-name&quot;&gt;namestring&lt;/span&gt; directory)
   &lt;span class=&quot;hljs-literal&quot;&gt;nil&lt;/span&gt;))

(&lt;span class=&quot;hljs-name&quot;&gt;defun&lt;/span&gt; enumerate-files (&lt;span class=&quot;hljs-name&quot;&gt;directory&lt;/span&gt;)
  (&lt;span class=&quot;hljs-name&quot;&gt;declare&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;type&lt;/span&gt; pathname directory))
  (&lt;span class=&quot;hljs-name&quot;&gt;let&lt;/span&gt; ((&lt;span class=&quot;hljs-name&quot;&gt;items&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;list&lt;/span&gt; directory))
        (&lt;span class=&quot;hljs-name&quot;&gt;files&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;nil&lt;/span&gt;))
    (&lt;span class=&quot;hljs-name&quot;&gt;loop&lt;/span&gt; while items do
      (&lt;span class=&quot;hljs-name&quot;&gt;let&lt;/span&gt; ((&lt;span class=&quot;hljs-name&quot;&gt;item&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;pop&lt;/span&gt; items)))
        (&lt;span class=&quot;hljs-name&quot;&gt;declare&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;type&lt;/span&gt; pathname item))
        (&lt;span class=&quot;hljs-name&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;pathname-name&lt;/span&gt; item)
            (&lt;span class=&quot;hljs-name&quot;&gt;push&lt;/span&gt; item files)
            (&lt;span class=&quot;hljs-name&quot;&gt;for-each-item-in-directory&lt;/span&gt;
             (&lt;span class=&quot;hljs-name&quot;&gt;lambda&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;name&lt;/span&gt; kind)
               (&lt;span class=&quot;hljs-name&quot;&gt;push&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;merge-pathnames&lt;/span&gt;
                      (&lt;span class=&quot;hljs-name&quot;&gt;ecase&lt;/span&gt; kind
                        (&lt;span class=&quot;hljs-symbol&quot;&gt;:file&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;parse-namestring&lt;/span&gt; name))
                        (&lt;span class=&quot;hljs-symbol&quot;&gt;:directory&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;make-pathname&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:directory&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;list&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:relative&lt;/span&gt; name))))
                      item)
                     items))
             item))))
    files))
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And now, the moment of truth when I run this modified function:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-txt&quot;&gt;Evaluation took:
  0.002 seconds of real time
  0.015625 seconds of total run time (0.000000 user, 0.015625 system)
  800.00% CPU
  7,000,104 processor cycles
  65,200 bytes consed
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;That&amp;#39;s a 27x speedup!&lt;/strong&gt; And, other than returning relative paths instead of absolute paths (a detail which doesn&amp;#39;t currently matter to me), the output looks the same. Even better, there might be more opportunities for improvement in my scenario:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I&amp;#39;ll likely need the &amp;quot;last modified&amp;quot; time of each time, but it looks like &lt;code&gt;FindFirstFile&lt;/code&gt; already provides that value&lt;/li&gt;
&lt;li&gt;There is a &lt;code&gt;FindFirstFileEx&lt;/code&gt;, with some (Windows 7+) optimization flags&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Of course, to do all this &lt;em&gt;correctly&lt;/em&gt; (i.e. portably), I should use CFFI instead of SBCL-internal functions. But I don&amp;#39;t know how to do that yet.&lt;/p&gt;
&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;Reducing file enumeration down to 2 milliseconds gives me some breathing room in my 50-ish millisecond budget. This is fortunate in the sense that I might end up with something useful, but unfortunate in the sense that I can no longer be satisfied with immediately discarding this project as obviously infeasible.&lt;/p&gt;
&lt;p&gt;Looks like I&amp;#39;ve got some more work to do...&lt;/p&gt;
</content>
</entry>
<entry>
<title>Building the fastest static site generator... or not</title>
<id>https://log.schemescape.com/posts/static-site-generators/speeding-up-rebuilds-4.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/static-site-generators/speeding-up-rebuilds-4.html"/>
<updated>2023-11-08T00:00:00.000Z</updated>
<summary type="text">This is a personal anecdote about the struggle to avoid over-engineering a static site generator.</summary>
<content type="html">&lt;p&gt;Well, I did it.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I have successfully staved off the urge (at least temporarily) to create &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/pre-markdown.html&quot;&gt;yet&lt;/a&gt; &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/md2blog-design.html&quot;&gt;another&lt;/a&gt; static site generator&lt;/strong&gt; by instead making &lt;a href=&quot;https://jaredkrinke.github.io/md2blog/&quot;&gt;md2blog&lt;/a&gt; (my zero-config dev blog generator) &lt;em&gt;just fast enough&lt;/em&gt; for my workflow that it seems pointless to bother improving upon its performance.&lt;/p&gt;
&lt;p&gt;Spoiler: adding trivial caching and bypassing the file system shrunk live rebuild times by ~80%--down to &lt;strong&gt;50 milliseconds&lt;/strong&gt; on my (decade old) desktop computer. Updates now appear in roughly the amount of time it takes me to shift the focus of my eyes from my text editor to the adjacent browser.&lt;/p&gt;
&lt;h1 id=&quot;background&quot;&gt;Background&lt;/h1&gt;
&lt;p&gt;Possibly as a reaction to &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/../game-development/web-game-on-steam-for-linux-2.html&quot;&gt;releasing a piece of software based on Electron&lt;/a&gt;, I&amp;#39;ve been playing with a &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/../programming-languages/minimal-dev-env-4.html&quot;&gt;minimal development environment, running on an old netbook&lt;/a&gt;. Unfortunately, my static site generator was taking roughly 6 seconds (on the netbook) to perform live rebuilds of my site (~90 pages), and I&amp;#39;m generally not patient with poorly optimized software.&lt;/p&gt;
&lt;p&gt;Fortunately, after &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/speeding-up-rebuilds-3.html&quot;&gt;a few tweaks&lt;/a&gt;, I was able to reduce that time down to around 900 milliseconds. Sub-second updates are acceptable (impressive, even--on a netbook), but I couldn&amp;#39;t shake the feeling that it could be &lt;em&gt;a lot&lt;/em&gt; faster.&lt;/p&gt;
&lt;h1 id=&quot;plans-for-a-new-static-site-generator&quot;&gt;Plans for a new static site generator&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;The most obvious way to speed up rebuilds of a static site is to avoid doing unnecessary work&lt;/strong&gt;. Given that &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/speeding-up-rebuilds.html&quot;&gt;a previous experiment of mine&lt;/a&gt; showed it was only necessary to rebuild roughly 5 pages when updating (or adding) a single blog post, I started making plans for an extensible static site generator (similar to &lt;a href=&quot;https://github.com/jaredkrinke/goldsmith&quot;&gt;Goldsmith&lt;/a&gt;/&lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/metalsmith.html&quot;&gt;Metalsmith&lt;/a&gt;) &lt;em&gt;with an accurate dependency graph&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Since I&amp;#39;m &lt;a href=&quot;https://log.schemescape.com/posts/static-site-generators/../programming-languages/learning-lisp-in-2023.html&quot;&gt;learning Lisp&lt;/a&gt;, I started planning to rebuild md2blog in Common Lisp. With an accurate dependency graph, compilation to native code, and the ability to process Markdown/syntax highlighting in parallel, I was fairly certain I could significantly improve live rebuild times.&lt;/p&gt;
&lt;p&gt;Additionally, Common Lisp would trivially allow for beautiful s-expression-based templates, interactive debugging and introspection, and even automatic detection of pipeline/code updates.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I could build the most extensible--and fastest--static site generator ever!&lt;/strong&gt;&lt;/p&gt;
&lt;h1 id=&quot;or-i-could-do-something-else&quot;&gt;Or I could do something else&lt;/h1&gt;
&lt;p&gt;But I already have a perfectly functional (and tolerably fast) static site generator. &lt;strong&gt;And I&amp;#39;m (nearly) the only user&lt;/strong&gt;. Is it really a good use of my time to build the same thing, just faster and in Lisp? It would certainly be educational, and a great way to learn Common Lisp, but finding Common Lisp libraries for Markdown processing, syntax highlighting, JSON validation, cache storage, and file system monitoring sounds... daunting.&lt;/p&gt;
&lt;p&gt;I still maintain that static site generators are a perfect first project for learning a programming language (and its ecosystem). It forces you to interact with the file system, understand data flows, find relevant libraries, and maybe even build a web server. In the end, you can produce a fast and efficient web site.&lt;/p&gt;
&lt;p&gt;But I&amp;#39;ve already done this at least four times and I&amp;#39;m probably past the point of diminishing returns. Is this a project that&amp;#39;s really worth spending a few weeks of my spare time on?&lt;/p&gt;
&lt;p&gt;Analogous to speeding up a static site generator, &lt;strong&gt;the most obvious way to speed up a &lt;em&gt;software project&lt;/em&gt; is to avoid doing unnecessary work&lt;/strong&gt; (i.e. avoid starting over from scratch). So I refocused my efforts on wringing maximal performance from md2blog, while staying within its existing design constraints.&lt;/p&gt;
&lt;h2 id=&quot;an-epiphany-around-caching&quot;&gt;An epiphany around caching&lt;/h2&gt;
&lt;p&gt;What if, instead of making a really smart cache, I made a really dumb one?&lt;/p&gt;
&lt;p&gt;While planning a scheme for reliably caching the results of arbitrary steps in the processing pipeline (specifically, deciding between simply using files&amp;#39; &amp;quot;last modified time&amp;quot; vs. using their actual content--or a hash--to detect changes), I realized that &lt;strong&gt;most of the challenges evaporated if I scoped the cache a single run of the tool&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;As noted in a previous post, my primary performance-sensitive workflow is:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Run md2blog as a live-reloading server&lt;/li&gt;
&lt;li&gt;Edit a blog post&lt;/li&gt;
&lt;li&gt;Hit Ctrl+S in my text editor&lt;/li&gt;
&lt;li&gt;Wait for updated content to render in my browser&lt;/li&gt;
&lt;li&gt;Go to 2&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I.e. &lt;strong&gt;it&amp;#39;s all one run of md2blog&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;As an experiment, I added a trivial in-memory Markdown cache and found that this One Weird Trick removed plugin processing as the primary bottleneck. The largest remaining bottleneck was the file system itself (writing out all the file contents to disk).&lt;/p&gt;
&lt;h2 id=&quot;an-epiphany-around-the-file-system&quot;&gt;An epiphany around the file system&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Why am I even waiting on the file system?&lt;/strong&gt; md2blog reads in files and then all subsequent processing is done in memory. Since I&amp;#39;m already running my own web server, &lt;strong&gt;I can just serve HTTP requests straight out of memory&lt;/strong&gt; while files are written to disk in the background!&lt;/p&gt;
&lt;p&gt;That removed the final obvious bottleneck.&lt;/p&gt;
&lt;h1 id=&quot;results&quot;&gt;Results&lt;/h1&gt;
&lt;p&gt;Here&amp;#39;s a table of approximate &amp;quot;live rebuild&amp;quot; times from:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;md2blog 1.1.1: no optimizations whatsoever&lt;/li&gt;
&lt;li&gt;md2blog 1.2.0: syntax highlighting cached and link-checking moved to the background&lt;/li&gt;
&lt;li&gt;md2blog 1.2.2 (new): Markdown cached and file system output moved to the background&lt;/li&gt;
&lt;/ul&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;md2blog version&lt;/th&gt;
&lt;th align=&quot;right&quot;&gt;Netbook (ms)&lt;/th&gt;
&lt;th align=&quot;right&quot;&gt;Desktop (ms)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;v1.1.1&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;6000&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;1200&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;v1.2.0&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;900&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;190&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;v1.2.2&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;200&lt;/td&gt;
&lt;td align=&quot;right&quot;&gt;50&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;As noted in the spoiler, on my desktop computer (with an 11 year-old processor), updates appear almost instantaneously (fortunately, my site has simple HTML and no JavaScript, so rendering is also fast).&lt;/p&gt;
&lt;p&gt;I&amp;#39;m fairly certain this is still &lt;em&gt;not&lt;/em&gt; the fastest static site generator in existence. Maybe the fastest full-featured, JavaScript-based one? Regardless, it is clearly &lt;em&gt;fast enough&lt;/em&gt;--at least for now.&lt;/p&gt;
</content>
</entry>
<entry>
<title>Building a browser-based app without JavaScript, part 2</title>
<id>https://log.schemescape.com/posts/web-development/interactive-browser-app-without-js-2.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/web-development/interactive-browser-app-without-js-2.html"/>
<updated>2023-10-26T00:00:00.000Z</updated>
<summary type="text">Yes, you can build real-time, interactive browser-based apps without JavaScript. But I wouldn&apos;t suggest using this particular approach.</summary>
<content type="html">&lt;p&gt;In the &lt;a href=&quot;https://log.schemescape.com/posts/web-development/interactive-browser-app-without-js.html&quot;&gt;last post&lt;/a&gt;, I brainstormed ideas for creating a real-time, interactive browser-based app without using JavaScript (or WebAssembly).&lt;/p&gt;
&lt;p&gt;In this post, I&amp;#39;ll describe a proof-of-concept that I created for &lt;a href=&quot;https://itch.io/jam/autumn-lisp-game-jam-2023&quot;&gt;Lisp Game Jam (Autumn 2023)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;You can play the game here: &lt;a href=&quot;https://foo.schemescape.com/&quot;&gt;https://foo.schemescape.com/&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Source code is here: &lt;a href=&quot;https://github.com/jaredkrinke/cl-stuff/tree/main/foolander&quot;&gt;https://github.com/jaredkrinke/cl-stuff/tree/main/foolander&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;recap&quot;&gt;Recap&lt;/h1&gt;
&lt;p&gt;The most difficult adjective to support without JavaScript is &amp;quot;real-time&amp;quot;. In some cases, &lt;a href=&quot;https://speckyboy.com/pure-css-games/&quot;&gt;CSS itself might be enough&lt;/a&gt; (although I truly hope CSS is not bloated enough for implementing a snake game!).&lt;/p&gt;
&lt;p&gt;If you don&amp;#39;t need real-time feedback, you can probably get by with regular &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Learn/Forms/Your_first_form&quot;&gt;HTML forms&lt;/a&gt;, &lt;a href=&quot;https://en.wikipedia.org/wiki/Push_technology#Long_polling&quot;&gt;long-polling&lt;/a&gt;, or even &lt;a href=&quot;https://en.wikipedia.org/wiki/Meta_refresh&quot;&gt;meta refresh&lt;/a&gt;. But if you need immediate feedback for both user input and server state updates, avoiding JavaScript can be tricky.&lt;/p&gt;
&lt;p&gt;Here&amp;#39;s what I came up with:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Chunked_transfer_encoding&quot;&gt;HTTP 1.1 chunked transfer encoding&lt;/a&gt;, for progressively appending HTML/CSS&lt;/li&gt;
&lt;li&gt;HTML forms (inside an &lt;code&gt;&amp;lt;iframe&amp;gt;&lt;/code&gt;), for providing input (without reloading the main page)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I don&amp;#39;t know if this is the best approach (in fact, I doubt it), but it is &lt;em&gt;an&lt;/em&gt; approach that is &amp;quot;good enough&amp;quot; for my terrible game.&lt;/p&gt;
&lt;h1 id=&quot;architecture&quot;&gt;Architecture&lt;/h1&gt;
&lt;p&gt;The architecture for my game is pretty simple:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;There&amp;#39;s a table of cells for the game board, each addressable via CSS (I used a class, but probably should have used an id)&lt;/li&gt;
&lt;li&gt;This is all pushed as an initial chunk, with the stream kept open (and without closing the &lt;code&gt;&amp;lt;body&amp;gt;&lt;/code&gt; and &lt;code&gt;&amp;lt;html&amp;gt;&lt;/code&gt; tags)&lt;/li&gt;
&lt;li&gt;As the game runs, I modify the color of the table cells by pushing additional CSS rules in additional &lt;code&gt;&amp;lt;style&amp;gt;&lt;/code&gt; chunks&lt;/li&gt;
&lt;li&gt;I also &amp;quot;overwrite&amp;quot; some HTML by defaulting one class to not being shown, with a &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/CSS/:last-of-type&quot;&gt;&lt;code&gt;:last-of-type&lt;/code&gt;&lt;/a&gt; override to show the most recently written element only&lt;/li&gt;
&lt;li&gt;Input is handled via HTTP post (with a &amp;quot;session id&amp;quot; string) using an HTML form inside an &lt;code&gt;&amp;lt;iframe&amp;gt;&lt;/code&gt; (relegating the &amp;quot;entire page reloads&amp;quot; problem to a frame)&lt;/li&gt;
&lt;li&gt;The form&amp;#39;s submission button has an &amp;quot;&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/accesskey&quot;&gt;access key&lt;/a&gt;&amp;quot; for keyboard-only control--this could be useful for games with multiple buttons, although it requires holding down modifier keys (which vary widely based on operating system and browser)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;examples&quot;&gt;Examples&lt;/h1&gt;
&lt;h2 id=&quot;table&quot;&gt;Table&lt;/h2&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;table&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;tbody&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;tr&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;td&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;s29_0&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hljs-symbol&quot;&gt;&amp;amp;nbsp;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;td&lt;/span&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;hljs-comment&quot;&gt;&amp;lt;!-- Row 29, column 0 --&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;td&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;s29_1&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hljs-symbol&quot;&gt;&amp;amp;nbsp;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;td&lt;/span&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;hljs-comment&quot;&gt;&amp;lt;!-- Row 29, column 1 --&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;td&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;s29_2&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hljs-symbol&quot;&gt;&amp;amp;nbsp;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;td&lt;/span&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;hljs-comment&quot;&gt;&amp;lt;!-- etc. --&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;td&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;s29_3&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hljs-symbol&quot;&gt;&amp;amp;nbsp;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;td&lt;/span&gt;&amp;gt;&lt;/span&gt;
...
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;tr&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;tbody&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;table&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;game-board-visual-updates&quot;&gt;Game board visual updates&lt;/h2&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;language-css&quot;&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.s9_12&lt;/span&gt; { &lt;span class=&quot;hljs-attribute&quot;&gt;background-color&lt;/span&gt;: yellow }&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;hljs-comment&quot;&gt;&amp;lt;!-- Change row 9, col 12 to yellow --&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;language-css&quot;&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.s6_12&lt;/span&gt; { &lt;span class=&quot;hljs-attribute&quot;&gt;background-color&lt;/span&gt;: blue }&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note: I should have used ids instead of classes (since they&amp;#39;re unique elements). Also, I could have consolidated multiple same-frame updates into a single &lt;code&gt;&amp;lt;style&amp;gt;&lt;/code&gt; tag.&lt;/p&gt;
&lt;h2 id=&quot;overwriting-the-last-bit-of-html-the-score&quot;&gt;&amp;quot;Overwriting&amp;quot; the last bit of HTML (the score)&lt;/h2&gt;
&lt;pre&gt;&lt;code class=&quot;language-css&quot;&gt;&lt;span class=&quot;hljs-selector-class&quot;&gt;.score&lt;/span&gt; { &lt;span class=&quot;hljs-attribute&quot;&gt;display&lt;/span&gt;: none }
&lt;span class=&quot;hljs-selector-class&quot;&gt;.score&lt;/span&gt;&lt;span class=&quot;hljs-selector-pseudo&quot;&gt;:last-of-type&lt;/span&gt; { &lt;span class=&quot;hljs-attribute&quot;&gt;display&lt;/span&gt;: block }
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;score&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;Score: 0&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;hljs-comment&quot;&gt;&amp;lt;!-- Initial score --&amp;gt;&lt;/span&gt;
...
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;score&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;Score: 1&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;hljs-comment&quot;&gt;&amp;lt;!-- Later, this score is shown instead --&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;input-frame&quot;&gt;Input frame&lt;/h2&gt;
&lt;p&gt;My game only uses a single button, but multiple buttons are easy to support using distinct forms with hidden inputs. In fact, I used multiple buttons until I decided to simplify at the very end.&lt;/p&gt;
&lt;p&gt;Parent page:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;iframe&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;src&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;controls?id=cbecixentpsc&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;iframe&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Frame body:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;form&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;action&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;action&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;method&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;post&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-comment&quot;&gt;&amp;lt;!-- This id links input to an active instance of the game --&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;hidden&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;cbecixentpsc&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;value&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;cbecixentpsc&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;

&lt;span class=&quot;hljs-comment&quot;&gt;&amp;lt;!-- This was for supporting multiple buttons --&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;hidden&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;action&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;value&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;clockwise&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;

&lt;span class=&quot;hljs-comment&quot;&gt;&amp;lt;!-- The actual submit button that is shown in-game --&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;&lt;span class=&quot;hljs-name&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;submit&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;value&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;â†»&amp;quot;&lt;/span&gt; &lt;span class=&quot;hljs-attr&quot;&gt;accesskey&lt;/span&gt;=&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;e&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;hljs-tag&quot;&gt;&amp;lt;/&lt;span class=&quot;hljs-name&quot;&gt;form&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The &lt;code&gt;id&lt;/code&gt; parameter is tracked on the server to link input to a particular HTTP request (which runs an entire round of the game).&lt;/p&gt;
&lt;h1 id=&quot;analysis&quot;&gt;Analysis&lt;/h1&gt;
&lt;p&gt;Give the game a try! If your latency isn&amp;#39;t too high, then it&amp;#39;s somewhat playable.&lt;/p&gt;
&lt;p&gt;Of course, I wouldn&amp;#39;t recommend this approach because it has a number of drawbacks:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;As noted, latency is a problem because &lt;em&gt;every user input event&lt;/em&gt; is a new HTTP post -- this is a nontrivial amount of overhead&lt;/li&gt;
&lt;li&gt;Also, successive button presses are slow because the entire input frame has to be reloaded&lt;/li&gt;
&lt;li&gt;The server can&amp;#39;t handle too many concurrent players because each game holds an HTTP request open for the entire length of the game (I&amp;#39;m using a web server that dedicates a thread to each request, although many web servers don&amp;#39;t do this anymore)&lt;/li&gt;
&lt;li&gt;Updating the game board requires evaluating CSS rules, which is obviously less efficient than just drawing, say, a canvas square&lt;/li&gt;
&lt;li&gt;&amp;quot;Normal&amp;quot; keyboard input doesn&amp;#39;t really work since HTML can only use access keys (which require holding down some combination of Ctrl/Shift/Alt/Meta/Command)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;But it &lt;em&gt;does&lt;/em&gt; (mostly) work! And it gave me an excuse to mess around with Lisp and participate in a game jam.&lt;/p&gt;
&lt;p&gt;Overall, I&amp;#39;m calling this a success since it answered my original question... even if it&amp;#39;s not a technique I&amp;#39;d recommend.&lt;/p&gt;
&lt;h1 id=&quot;addendum&quot;&gt;Addendum&lt;/h1&gt;
&lt;h2 id=&quot;achievement-not-unlocked&quot;&gt;Achievement &lt;em&gt;not&lt;/em&gt; unlocked&lt;/h2&gt;
&lt;p&gt;Unfortunately, I wasn&amp;#39;t able to achieve one secret goal I had in mind: getting the game to run in a minimalist, no-JavaScript browser, like &lt;a href=&quot;https://dillo.org/&quot;&gt;Dillo&lt;/a&gt;. Apparently Dillo doesn&amp;#39;t support inline frames, so the control scheme doesn&amp;#39;t really work (unless you have another window open to the frame). Additionally, Dillo didn&amp;#39;t seem to like my &amp;quot;streaming CSS&amp;quot; approach--the entire game board just remained its initial blue color.&lt;/p&gt;
&lt;p&gt;Oh well. At least I tried.&lt;/p&gt;
&lt;h2 id=&quot;nginx&quot;&gt;nginx&lt;/h2&gt;
&lt;p&gt;In order to support HTTPS using nginx, I had to tweak a couple of nginx settings. I&amp;#39;m noting them down here for reference:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&lt;span class=&quot;hljs-attribute&quot;&gt;proxy_http_version&lt;/span&gt; &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;.&lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt;; &lt;span class=&quot;hljs-comment&quot;&gt;# nginx default is 1.0, but chunking is a 1.1 feature&lt;/span&gt;
&lt;span class=&quot;hljs-attribute&quot;&gt;proxy_buffering&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;off&lt;/span&gt;; &lt;span class=&quot;hljs-comment&quot;&gt;# Necessary to ensure chunks are forwarded as soon as received&lt;/span&gt;
&lt;span class=&quot;hljs-attribute&quot;&gt;gzip&lt;/span&gt; &lt;span class=&quot;hljs-literal&quot;&gt;off&lt;/span&gt;; &lt;span class=&quot;hljs-comment&quot;&gt;# This is actually the default, chunking only worked with gzip disabled&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
</content>
</entry>
<entry>
<title>Building a browser-based app without JavaScript</title>
<id>https://log.schemescape.com/posts/web-development/interactive-browser-app-without-js.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/web-development/interactive-browser-app-without-js.html"/>
<updated>2023-10-19T00:00:00.000Z</updated>
<summary type="text">Can I build an interactive (and ideally real-time) browser-based app without using JavaScript?</summary>
<content type="html">&lt;p&gt;For &lt;a href=&quot;https://log.schemescape.com/posts/web-development/../game-development/lisp-game-jam-2.html&quot;&gt;Lisp Game Jam (Spring 2023)&lt;/a&gt;, I built a browser-based word scramble game without (technically) writing a single line of JavaScript. But that&amp;#39;s a little bit misleading since &lt;a href=&quot;https://parenscript.common-lisp.dev/&quot;&gt;Parenscript&lt;/a&gt; transpiled my Common Lisp code into JavaScript at build time, so JavaScript was still used at run-time.&lt;/p&gt;
&lt;p&gt;Lately, I&amp;#39;ve gotten to wondering: &lt;strong&gt;how interactive of an application can be built for the browser &lt;em&gt;without any JavaScript whatsoever&lt;/em&gt;?&lt;/strong&gt; (N.B. WebAssembly doesn&amp;#39;t help since WebAssembly modules are loaded using JavaScript.)&lt;/p&gt;
&lt;p&gt;For the record, my motivation is two-part:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Mostly, I&amp;#39;m just curious if such a thing is possible&lt;/li&gt;
&lt;li&gt;But additionally, I find it slightly horrifying that browsing the web today requires multiple gigabytes of RAM--and I attribute much of that bloat to the operating system-sized browser runtime (and associated sandboxing) that supports &lt;del&gt;ad delivery&lt;/del&gt; JavaScript&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;aside&quot;&gt;Aside&lt;/h2&gt;
&lt;p&gt;Unrelated to this project, I&amp;#39;d like to mention a service I ran across recently: &lt;a href=&quot;https://sourcehut.org/&quot;&gt;SourceHut&lt;/a&gt;. It provides project hosting with two notable (and tangentially related to this article) features:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;All features work without JavaScript&lt;/li&gt;
&lt;li&gt;Many features work without an &lt;em&gt;account&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I&amp;#39;ll admit I&amp;#39;m a little jealous that I didn&amp;#39;t come up with this idea myself. It seems like the sort of thing the software development world needs these days.&lt;/p&gt;
&lt;p&gt;But back to the task at hand...&lt;/p&gt;
&lt;h1 id=&quot;html-forms-to-the-rescue&quot;&gt;HTML forms &lt;del&gt;to the rescue!&lt;/del&gt;&lt;/h1&gt;
&lt;p&gt;The World Wide Web worked fine prior to JavaScript. I&amp;#39;m not sure when HTML forms were added to the HTML &amp;quot;standard&amp;quot;, but for the sake of argument, I&amp;#39;m assuming that forms existed prior to JavaScript being widely supported. Using form submission, it&amp;#39;s possible for browsers to have a two-way communication channel with a web site, so interactive web applications clearly don&amp;#39;t &lt;em&gt;require&lt;/em&gt; JavaScript.&lt;/p&gt;
&lt;p&gt;Having said that, form submission reloads the entire web page, so the experience is decidedly seamful. Additionally, form submission is user-initiated, so there&amp;#39;s no way for the application to update its UI in the absence of user input.&lt;/p&gt;
&lt;p&gt;Can we do better?&lt;/p&gt;
&lt;h1 id=&quot;potential-solution-chunked-transfer-encoding-and-frames&quot;&gt;Potential solution: chunked transfer encoding and frames&lt;/h1&gt;
&lt;p&gt;I&amp;#39;m not sure where I first heard the story, but there are tales of browser-based, JavaScript-free chat apps that use &lt;a href=&quot;https://en.wikipedia.org/wiki/Chunked_transfer_encoding&quot;&gt;chunked transfer encoding&lt;/a&gt; to append to an HTML page, along with an &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTML/Element/frame&quot;&gt;HTML frame element&lt;/a&gt; that uses form submission to trigger the transfer of said &lt;del&gt;appendages&lt;/del&gt; chunks that are appended to the page.&lt;/p&gt;
&lt;p&gt;It&amp;#39;s unclear to me what the motivation was behind these apps. Did they predate JavaScript? Did they need to support unscriptable browsers? Did their users frequently have JavaScript disabled (perhaps for privacy or security reasons)?&lt;/p&gt;
&lt;p&gt;Regardless, I see no obvious reason why this approach wouldn&amp;#39;t work for building an interactive web app without JavaScript. Who knows, it might even be possible to use some fancy CSS rules to make it appear as though part of a page is being updated instead of just appended to.&lt;/p&gt;
&lt;h1 id=&quot;so-does-it-work&quot;&gt;So does it work?&lt;/h1&gt;
&lt;p&gt;I don&amp;#39;t know! But I&amp;#39;m planning to find out, so stay tuned...&lt;/p&gt;
</content>
</entry>
<entry>
<title>Creating Windows-style paths (backslash-separated) from pathnames in Common Lisp</title>
<id>https://log.schemescape.com/posts/lisp/pathnames-on-windows.html</id>
<link rel="alternate" href="https://log.schemescape.com/posts/lisp/pathnames-on-windows.html"/>
<updated>2023-10-04T00:00:00.000Z</updated>
<summary type="text">I spent far too long trying to figure out how to do this, so I&apos;m documenting it here, in case anyone else has trouble finding the answer.</summary>
<content type="html">&lt;p&gt;Use &lt;code&gt;uiop/filesystem:native-namestring&lt;/code&gt;. That&amp;#39;s the answer.&lt;/p&gt;
&lt;p&gt;The rest of this post is just additional context/whining.&lt;/p&gt;
&lt;h1 id=&quot;background&quot;&gt;Background&lt;/h1&gt;
&lt;p&gt;Common Lisp was born in an era of surprising file system diversity. Nowadays, Windows is mocked for using something other than a forward slash as a path separator, but old Macs used colons and I&amp;#39;ve seen references to &lt;code&gt;&amp;gt;&lt;/code&gt; being used on more exotic platforms.&lt;/p&gt;
&lt;p&gt;Common Lisp handles this difference (and many other differences that never even occurred to me, such as types and versions) by abstracting everything into a platform-independent concept called a &lt;a href=&quot;http://www.ai.mit.edu/projects/iiip/doc/CommonLISP/HyperSpec/Body/glo_p.html#pathname&quot;&gt;pathname&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;example-pathname&quot;&gt;Example pathname&lt;/h2&gt;
&lt;p&gt;Here&amp;#39;s how to create a (relative) pathname for &amp;quot;the directory &amp;#39;foo&amp;#39;, which is located in the parent directory&amp;quot;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-lisp&quot;&gt; (&lt;span class=&quot;hljs-name&quot;&gt;make-pathname&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:directory&lt;/span&gt; &amp;#x27;(&lt;span class=&quot;hljs-symbol&quot;&gt;:relative&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:up&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;the-problem&quot;&gt;The problem&lt;/h2&gt;
&lt;p&gt;While working on a tiny Common Lisp project, my program needed to run a command in a subprocess (using &lt;code&gt;uiop:run-program&lt;/code&gt;) with a directory passed as an argument. &lt;strong&gt;I had assumed that &lt;code&gt;format&lt;/code&gt;-ing a pathname on Windows would result in a Windows-compatible string&lt;/strong&gt; (or at least that &lt;code&gt;namestring&lt;/code&gt; would), e.g. &amp;quot;..\foo\&amp;quot; for the example code above.&lt;/p&gt;
&lt;p&gt;For reasons I won&amp;#39;t yet understand, &lt;strong&gt;this is &lt;em&gt;not&lt;/em&gt; how things work on SBCL&lt;/strong&gt;! Instead, forward slashes are used: &amp;quot;../foo/&amp;quot;. This works fine for some programs (including Git, apparently), but I doubt it&amp;#39;s robust in general, considering some (mostly old) Windows programs use the forward slash to indicate command-line flags (instead of using a hyphen).&lt;/p&gt;
&lt;h2 id=&quot;but-why&quot;&gt;But why?&lt;/h2&gt;
&lt;p&gt;I thought the point of pathnames was to support a platform-independent notion of a file path/name, so it&amp;#39;s not clear to me why they don&amp;#39;t &lt;code&gt;format&lt;/code&gt; by default into a form that&amp;#39;s compatible with the host environment.&lt;/p&gt;
&lt;p&gt;Even more surprising, after spending way too much time browsing the &lt;a href=&quot;http://www.ai.mit.edu/projects/iiip/doc/CommonLISP/HyperSpec/FrontMatter/index.html&quot;&gt;Common Lisp HyperSpec&lt;/a&gt;, I couldn&amp;#39;t even find anything in Common Lisp&amp;#39;s standard library for this scenario. Why can I create and manipulate pathnames but not actually pass them to the operating system? That&amp;#39;s a serious question--if you know the answer, please tell me!&lt;/p&gt;
&lt;h1 id=&quot;uiop-to-the-rescue&quot;&gt;UIOP to the rescue&lt;/h1&gt;
&lt;p&gt;Given that (ANSI) Common Lisp hasn&amp;#39;t been updated since 1994, I don&amp;#39;t see this situation changing, but the good news is that Common Lisp implementations fill in this gap and &lt;a href=&quot;https://asdf.common-lisp.dev/uiop.html&quot;&gt;UIOP&lt;/a&gt; abstracts away the implementations&amp;#39; different approaches/naming schemes.&lt;/p&gt;
&lt;p&gt;So that leads us to the solution: &lt;code&gt;uiop/filesystem:native-namestring&lt;/code&gt;. Example:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-lisp&quot;&gt; (&lt;span class=&quot;hljs-name&quot;&gt;uiop/filesystem&lt;/span&gt;&lt;span class=&quot;hljs-symbol&quot;&gt;:native-namestring&lt;/span&gt; (&lt;span class=&quot;hljs-name&quot;&gt;make-pathname&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:directory&lt;/span&gt; &amp;#x27;(&lt;span class=&quot;hljs-symbol&quot;&gt;:relative&lt;/span&gt; &lt;span class=&quot;hljs-symbol&quot;&gt;:up&lt;/span&gt; &lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;foo&amp;quot;&lt;/span&gt;)))
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Result:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&lt;span class=&quot;hljs-string&quot;&gt;&amp;quot;..&lt;span class=&quot;hljs-subst&quot;&gt;\\&lt;/span&gt;foo&lt;span class=&quot;hljs-subst&quot;&gt;\\&lt;/span&gt;&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Problem solved!&lt;/p&gt;
&lt;p&gt;The only lingering question for me is: why is &lt;code&gt;native-namestring&lt;/code&gt; in &lt;code&gt;uiop/filesystem&lt;/code&gt; instead of &lt;code&gt;uiop/pathname&lt;/code&gt;?&lt;/p&gt;
</content>
</entry>
</feed>
