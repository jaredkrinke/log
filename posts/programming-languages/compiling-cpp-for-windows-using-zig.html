<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Testing out Zig... for C/C++ code... on Windows</title>
<meta name="description" content="Can Zig save me from downloading multi-gigabyte SDKs just to build Windows programs?" />
<meta name="keywords" content="zig" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link rel="stylesheet" href="../../css/style.css" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Testing out Zig... for C/C++ code... on Windows",
  "abstract": "Can Zig save me from downloading multi-gigabyte SDKs just to build Windows programs?",
  "keywords": "programming-languages,zig",
  "datePublished": "2022-08-13"
}
</script>
</head>
<body>
<header>
<h1><a href="../../index.html">Schemescape</a></h1>
<p>Development log of a life-long coder</p>

<nav>
<strong>Topics:&nbsp;</strong>
<ul>
<li><a href="../../posts/programming-languages/index.html">programming-languages</a></li>
<li><a href="../../posts/zig/index.html">zig</a></li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h1><a href="../../posts/programming-languages/compiling-cpp-for-windows-using-zig.html">Testing out Zig... for C/C++ code... on Windows</a></h1>
<p><time datetime="2022-08-13">August 13, 2022</time></p>
</header>
<p>I briefly played around with Zig's C/C++ compiler in the past. It's a tidy ~60 MB download that can magically even cross-compile. I haven't worked up the nerve to investigate the Zig <em>programming language</em>, but its built-in C/C++ compiler impressed me.</p>
<p>Now how far can I push it?</p>
<h2 id="aside-toolchain-bloat">Aside: toolchain bloat</h2>
<p>A good way to discourage me from testing out your software is to require a gigabyte (or more) download (and no, providing an installer that obscures the massive download is not a solution).</p>
<p>The chief offender of inexplicably enormous downloads is, unfortunately, anything related to compiling software for Windows. Want to use the free edition of Microsoft Visual C? That will be at least 3 GB. How about a more modern language like C#? That's 5 GB. Even non-Visual Studio C/C++ compilers tend to be hundreds of megabytes.</p>
<h1 id="hello-zig-c">Hello, <del>Zig</del> C!</h1>
<p>First, here's a trivial &quot;hello world&quot; program:</p>
<pre><code class="language-c"><span class="hl-preprocessor">#include</span> <span class="hl-string">&lt;stdio.h&gt;</span>

<span class="hl-type">int</span> <span class="hl-function">main</span><span class="hl-operator">(</span><span class="hl-type">int</span> <span class="hl-identifier">argc</span><span class="hl-operator">,</span> <span class="hl-keyword">const</span> <span class="hl-type">char</span><span class="hl-operator">*</span><span class="hl-operator">*</span> <span class="hl-identifier">argv</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-function">printf</span><span class="hl-operator">(</span><span class="hl-string">&quot;Hello, C!&quot;</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">return</span> <span class="hl-number">0</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span>
</code></pre>
<p>Here's the result:</p>
<pre><code>&gt; zig cc hello-c.c -o hello-c.exe

&gt; hello-c.exe
Hello, C!
</code></pre>
<p>Success!</p>
<h2 id="making-the-binary-more-portable">Making the binary more portable</h2>
<p>According to ziglearn.org, <a href="https://ziglearn.org/chapter-3/#cross-compilation">Zig targets the host's specific CPU by default</a>. If you plan to distribute programs built with Zig, you'll probably want to choose a more generic architecture, e.g. <code>i386</code> or <code>x86_64</code>:</p>
<pre><code>&gt; zig cc -target i386-windows-gnu hello-c.c -o hello-c.exe 
</code></pre>
<h1 id="hello-win32">Hello, Win32!</h1>
<p>That last exercise was somewhat trivial, although I'm still impressed at how easy it was to get started with Zig's compiler (just unzip--no installation or SDK required).</p>
<p>But I want to be able to call Win32 APIs from my programs. Is Zig up to that task?</p>
<p>Here's a trivial program to pop up a message box:</p>
<pre><code class="language-c"><span class="hl-preprocessor">#include</span> <span class="hl-string">&lt;windows.h&gt;</span>

<span class="hl-type">int</span> <span class="hl-function">main</span><span class="hl-operator">(</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-function">MessageBox</span><span class="hl-operator">(</span><span class="hl-constant">NULL</span><span class="hl-operator">,</span> <span class="hl-string">&quot;Hello there!&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;From Zig land!&quot;</span><span class="hl-operator">,</span> <span class="hl-identifier">MB_OK</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">return</span> <span class="hl-number">0</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span>
</code></pre>
<p>Build command:</p>
<pre><code>&gt; zig cc -target i386-windows-gnu hello-win32.c -o hello-win32.exe 

&gt; hello-win32.exe
</code></pre>
<p>Sure enough, a message box appeared!</p>
<p>At this point, I'm impressed, but it remains to be seen if Zig's magic will work beyond trivial examples like this.</p>
<h1 id="hello-c-and-winmain">Hello, C++ and WinMain!</h1>
<p>Time to throw in some C++ and create an actual Window:</p>
<pre><code class="language-cpp"><span class="hl-preprocessor">#include</span> <span class="hl-string">&lt;windows.h&gt;</span>
<span class="hl-preprocessor">#include</span> <span class="hl-string">&lt;stdlib.h&gt;</span>
<span class="hl-preprocessor">#include</span> <span class="hl-string">&lt;string&gt;</span>
<span class="hl-preprocessor">#include</span> <span class="hl-string">&lt;tchar.h&gt;</span>

<span class="hl-keyword">static</span> <span class="hl-identifier">TCHAR</span> <span class="hl-identifier">szWindowClass</span><span class="hl-operator">[</span><span class="hl-operator">]</span> <span class="hl-operator">=</span> <span class="hl-function">_T</span><span class="hl-operator">(</span><span class="hl-string">&quot;DesktopApp&quot;</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-keyword">static</span> <span class="hl-identifier">TCHAR</span> <span class="hl-identifier">szTitle</span><span class="hl-operator">[</span><span class="hl-operator">]</span> <span class="hl-operator">=</span> <span class="hl-function">_T</span><span class="hl-operator">(</span><span class="hl-string">&quot;Hello, Windows!&quot;</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

<span class="hl-identifier">LRESULT</span> <span class="hl-identifier">CALLBACK</span> <span class="hl-function">WndProc</span><span class="hl-operator">(</span><span class="hl-identifier">HWND</span><span class="hl-operator">,</span> <span class="hl-identifier">UINT</span><span class="hl-operator">,</span> <span class="hl-identifier">WPARAM</span><span class="hl-operator">,</span> <span class="hl-identifier">LPARAM</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

<span class="hl-type">int</span> <span class="hl-identifier">CALLBACK</span> <span class="hl-function">WinMain</span><span class="hl-operator">(</span><span class="hl-identifier">HINSTANCE</span> <span class="hl-identifier">hInstance</span><span class="hl-operator">,</span> <span class="hl-identifier">HINSTANCE</span> <span class="hl-identifier">hPrevInstance</span><span class="hl-operator">,</span> <span class="hl-identifier">LPSTR</span> <span class="hl-identifier">lpCmdLine</span><span class="hl-operator">,</span> <span class="hl-type">int</span> <span class="hl-identifier">nCmdShow</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-identifier">WNDCLASSEX</span> <span class="hl-identifier">wcex</span><span class="hl-operator">;</span>

    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">cbSize</span> <span class="hl-operator">=</span> <span class="hl-keyword">sizeof</span><span class="hl-operator">(</span><span class="hl-identifier">WNDCLASSEX</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">style</span> <span class="hl-operator">=</span> <span class="hl-identifier">CS_HREDRAW</span> <span class="hl-operator">|</span> <span class="hl-identifier">CS_VREDRAW</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">lpfnWndProc</span> <span class="hl-operator">=</span> <span class="hl-identifier">WndProc</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">cbClsExtra</span> <span class="hl-operator">=</span> <span class="hl-number">0</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">cbWndExtra</span> <span class="hl-operator">=</span> <span class="hl-number">0</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">hInstance</span> <span class="hl-operator">=</span> <span class="hl-identifier">hInstance</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">hIcon</span> <span class="hl-operator">=</span> <span class="hl-function">LoadIcon</span><span class="hl-operator">(</span><span class="hl-identifier">hInstance</span><span class="hl-operator">,</span> <span class="hl-identifier">IDI_APPLICATION</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">hCursor</span> <span class="hl-operator">=</span> <span class="hl-function">LoadCursor</span><span class="hl-operator">(</span><span class="hl-identifier">NULL</span><span class="hl-operator">,</span> <span class="hl-identifier">IDC_ARROW</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">hbrBackground</span> <span class="hl-operator">=</span> <span class="hl-operator">(</span><span class="hl-identifier">HBRUSH</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-identifier">COLOR_WINDOW</span> <span class="hl-operator">+</span> <span class="hl-number">1</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">lpszMenuName</span> <span class="hl-operator">=</span> <span class="hl-identifier">NULL</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">lpszClassName</span> <span class="hl-operator">=</span> <span class="hl-identifier">szWindowClass</span><span class="hl-operator">;</span>
    <span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">hIconSm</span> <span class="hl-operator">=</span> <span class="hl-function">LoadIcon</span><span class="hl-operator">(</span><span class="hl-identifier">wcex</span><span class="hl-operator">.</span><span class="hl-identifier">hInstance</span><span class="hl-operator">,</span> <span class="hl-identifier">IDI_APPLICATION</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

    <span class="hl-keyword">if</span> <span class="hl-operator">(</span><span class="hl-operator">!</span><span class="hl-function">RegisterClassEx</span><span class="hl-operator">(</span><span class="hl-operator">&amp;</span><span class="hl-identifier">wcex</span><span class="hl-operator">)</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
        <span class="hl-function">MessageBox</span><span class="hl-operator">(</span><span class="hl-identifier">NULL</span><span class="hl-operator">,</span> <span class="hl-function">_T</span><span class="hl-operator">(</span><span class="hl-string">&quot;Call to RegisterClassEx failed!&quot;</span><span class="hl-operator">)</span><span class="hl-operator">,</span> <span class="hl-function">_T</span><span class="hl-operator">(</span><span class="hl-string">&quot;Test app&quot;</span><span class="hl-operator">)</span><span class="hl-operator">,</span> <span class="hl-identifier">NULL</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-keyword">return</span> <span class="hl-number">1</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>

    <span class="hl-identifier">HWND</span> <span class="hl-identifier">hWnd</span> <span class="hl-operator">=</span> <span class="hl-function">CreateWindow</span><span class="hl-operator">(</span><span class="hl-identifier">szWindowClass</span><span class="hl-operator">,</span> <span class="hl-identifier">szTitle</span><span class="hl-operator">,</span> <span class="hl-identifier">WS_OVERLAPPEDWINDOW</span><span class="hl-operator">,</span> <span class="hl-identifier">CW_USEDEFAULT</span><span class="hl-operator">,</span> <span class="hl-identifier">CW_USEDEFAULT</span><span class="hl-operator">,</span> <span class="hl-number">1200</span><span class="hl-operator">,</span> <span class="hl-number">900</span><span class="hl-operator">,</span> <span class="hl-identifier">NULL</span><span class="hl-operator">,</span> <span class="hl-identifier">NULL</span><span class="hl-operator">,</span> <span class="hl-identifier">hInstance</span><span class="hl-operator">,</span> <span class="hl-identifier">NULL</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">if</span> <span class="hl-operator">(</span><span class="hl-operator">!</span><span class="hl-identifier">hWnd</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
        <span class="hl-function">MessageBox</span><span class="hl-operator">(</span><span class="hl-identifier">NULL</span><span class="hl-operator">,</span>
            <span class="hl-function">_T</span><span class="hl-operator">(</span><span class="hl-string">&quot;Call to CreateWindow failed!&quot;</span><span class="hl-operator">)</span><span class="hl-operator">,</span>
            <span class="hl-function">_T</span><span class="hl-operator">(</span><span class="hl-string">&quot;Test app&quot;</span><span class="hl-operator">)</span><span class="hl-operator">,</span>
            <span class="hl-identifier">NULL</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

        <span class="hl-keyword">return</span> <span class="hl-number">1</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>

    <span class="hl-function">ShowWindow</span><span class="hl-operator">(</span><span class="hl-identifier">hWnd</span><span class="hl-operator">,</span> <span class="hl-identifier">nCmdShow</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-function">UpdateWindow</span><span class="hl-operator">(</span><span class="hl-identifier">hWnd</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

    <span class="hl-identifier">MSG</span> <span class="hl-identifier">msg</span><span class="hl-operator">;</span>
    <span class="hl-keyword">while</span> <span class="hl-operator">(</span><span class="hl-function">GetMessage</span><span class="hl-operator">(</span><span class="hl-operator">&amp;</span><span class="hl-identifier">msg</span><span class="hl-operator">,</span> <span class="hl-identifier">NULL</span><span class="hl-operator">,</span> <span class="hl-number">0</span><span class="hl-operator">,</span> <span class="hl-number">0</span><span class="hl-operator">)</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
        <span class="hl-function">TranslateMessage</span><span class="hl-operator">(</span><span class="hl-operator">&amp;</span><span class="hl-identifier">msg</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-function">DispatchMessage</span><span class="hl-operator">(</span><span class="hl-operator">&amp;</span><span class="hl-identifier">msg</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>

    <span class="hl-keyword">return</span> <span class="hl-operator">(</span><span class="hl-type">int</span><span class="hl-operator">)</span><span class="hl-identifier">msg</span><span class="hl-operator">.</span><span class="hl-identifier">wParam</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span>

<span class="hl-identifier">LRESULT</span> <span class="hl-identifier">CALLBACK</span> <span class="hl-function">WndProc</span><span class="hl-operator">(</span><span class="hl-identifier">HWND</span> <span class="hl-identifier">hWnd</span><span class="hl-operator">,</span> <span class="hl-identifier">UINT</span> <span class="hl-identifier">message</span><span class="hl-operator">,</span> <span class="hl-identifier">WPARAM</span> <span class="hl-identifier">wParam</span><span class="hl-operator">,</span> <span class="hl-identifier">LPARAM</span> <span class="hl-identifier">lParam</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">switch</span> <span class="hl-operator">(</span><span class="hl-identifier">message</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">case</span> <span class="hl-identifier">WM_DESTROY</span><span class="hl-operator">:</span>
        <span class="hl-function">PostQuitMessage</span><span class="hl-operator">(</span><span class="hl-number">0</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-keyword">break</span><span class="hl-operator">;</span>

    <span class="hl-keyword">default</span><span class="hl-operator">:</span>
        <span class="hl-keyword">return</span> <span class="hl-function">DefWindowProc</span><span class="hl-operator">(</span><span class="hl-identifier">hWnd</span><span class="hl-operator">,</span> <span class="hl-identifier">message</span><span class="hl-operator">,</span> <span class="hl-identifier">wParam</span><span class="hl-operator">,</span> <span class="hl-identifier">lParam</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-keyword">break</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>

    <span class="hl-keyword">return</span> <span class="hl-number">0</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span>
</code></pre>
<p>And now to build and test:</p>
<pre><code>&gt; zig c++ -target i386-windows-gnu hello-window.cpp -o hello-window.exe

&gt; hello-window.exe
</code></pre>
<p>This popped up a window that I could close.</p>
<p>Based on functionality, this is a fairly trivial example, but based on the number of lines of code in the included header files, I actually wasn't expecting this to work on the first try.</p>
<p>It's not yet clear to me how much of the Windows SDK Zig ships with, but it's at least enough to create a real window.</p>
<h1 id="hello-webview2">Hello, WebView2?</h1>
<p>Given that <a href="https://docs.microsoft.com/en-us/microsoft-edge/webview2/">WebView2</a> isn't a part of the standard Windows SDK, I'm almost certain that this won't work out of the box, but I'm going to give it a try anyway.</p>
<p>I'm going to work off of the <a href="https://docs.microsoft.com/en-us/microsoft-edge/webview2/get-started/win32">WebView2 for Win32 tutorial</a>. The code is fairly lengthy, so I'm not going to duplicate it here.</p>
<p>After trying to compile the sample, I finally managed to stump Zig:</p>
<pre><code>&gt; zig c++ -target i386-windows-gnu hello-webview2.cpp -o hello-webview2.exe
hello-webview2.cpp:5:10: fatal error: 'wil/com.h' file not found
#include &lt;wil/com.h&gt;
         ^~~~~~~~~~~
1 error generated.
</code></pre>
<p>The sample code uses <a href="https://github.com/microsoft/wil">WIL</a>, and regardless of whether that's part of the Windows SDK, Zig doesn't ship with it. I'll try cloning the repository, but you could also download the NuGet package and unzip it (<code>.nupkg</code> files are just Zip files).</p>
<p>Second attempt, this time with WIL:</p>
<pre><code>&gt; zig c++ -target i386-windows-gnu hello-webview2.cpp -I..\wil\include -o hello-webview2.exe
In file included from hello-webview2.cpp:5:
..\wil\include\wil/com.h:14:10: fatal error: 'WeakReference.h' file not found
#include &lt;WeakReference.h&gt;
         ^~~~~~~~~~~~~~~~~
1 error generated.
</code></pre>
<p>Alright, <code>WeakReference.h</code> is part of <a href="https://docs.microsoft.com/en-us/cpp/cppcx/wrl/windows-runtime-cpp-template-library-wrl?view=msvc-170">WRL</a>, which is actually part of the Windows SDK. Zig doesn't appear to ship with WRL (and I'm not even sure that it <em>should</em>).</p>
<p>I suspect I don't actually <em>need</em> WIL or WRL, but proceeding without them might not be the best use of time, because instantiating WebView2 appears to be an COM-based asynchronous operation, and I don't want to reimplement a large chunk of WIL, WRL, or even COM just to avoid using the Windows SDK and Visual Studio.</p>
<p>Ok, fine, Visual Studio Installer. You win this round.</p>

<footer>
<p>&crarr; <a href="../../index.html">Back to home</a></p>
</footer>
</article>
</main>

</body>
</html>
