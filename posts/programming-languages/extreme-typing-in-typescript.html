<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Extreme Typing in TypeScript</title>
<meta name="description" content="Here&#039;s how to compare poker hands entirely within TypeScript&#039;s type system." />
<meta name="keywords" content="100-languages" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link rel="stylesheet" href="../../css/style.css" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Extreme Typing in TypeScript",
  "abstract": "Here's how to compare poker hands entirely within TypeScript's type system.",
  "keywords": "programming-languages,100-languages",
  "datePublished": "2024-06-05"
}
</script>
</head>
<body>
<header>
<h1><a href="../../index.html">Schemescape</a></h1>
<p>Development log of a life-long coder</p>

<nav>
<strong>Topics:&nbsp;</strong>
<ul>
<li><a href="../../posts/programming-languages/index.html">programming-languages</a></li>
<li><a href="../../posts/100-languages/index.html">100-languages</a></li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h1><a href="../../posts/programming-languages/extreme-typing-in-typescript.html">Extreme Typing in TypeScript</a></h1>
<p><time datetime="2024-06-05">June 5, 2024</time></p>
</header>
<p><strong>TypeScript brought sanity to the JavaScript world</strong>, standardizing how JavaScript APIs are documented. TypeScript's gradual typing system has shown that <strong>a little bit of typing can go a long way</strong> towards increasing productivity.</p>
<p>So if <em>a little bit</em> of typing is a good thing, then <em>more</em> must be better, right?</p>
<p>Welcome to <strong>Extreme Typing</strong>.</p>
<h1 id="extreme-typing">Extreme Typing</h1>
<p>Extreme Typing is about <strong>using the type system available to you <em>to the fullest extent permitted by law</em></strong>. In fact, it's about <em>only</em> using the type system. For everything.</p>
<p>In the context of TypeScript, this means that you can finally enjoy the modern wonder of TypeScript <strong>without ever having to deal with that crusty, clumsy, old language called JavaScript</strong>. Yes, today in TypeScript, it is possible to do the following <em>without ever having to touch JavaScript</em>:</p>
<ul>
<li>Perform arithmetic</li>
<li>Apply logic</li>
<li>Parse strings</li>
</ul>
<h1 id="extremely-typed-poker">Extremely typed poker</h1>
<p>For my most recent <a href="100-languages.html">programming language experiment</a>, I tackled <a href="https://projecteuler.net/problem=54">Project Euler problem 54</a> (&quot;Poker Hands&quot;), entirely from the comfort of TypeScript's type system.</p>
<p>The problem encodes 1,000 rounds of Poker and the goal is to determine how many hands the first player wins (following the rules of Poker). Here's a line of sample input:</p>
<pre><code>2D 9C AS AH AC 3D 6D 7D TD QD
</code></pre>
<p>Separating the two hands and moving the cards around, this yields <code>AS AH AC 9C 2D</code> vs. <code>QD TD 7D 6D 3D</code>, i.e. the first player has 3 aces and the second player has a flush. The second player wins.</p>
<p><strong>So how can we decode and evaluate 1,000 rounds of Poker using only types?</strong></p>
<h2 id="overview">Overview</h2>
<p>I settled on the following process:</p>
<ol>
<li>Split text into lines</li>
<li>Parse all 10 cards on each line</li>
<li>Group cards by rank and suit</li>
<li>Determine the (ahem) type (and tie-breakers) of each poker hand</li>
<li>Compare the two hands to identify the winner</li>
<li>Count the number of first player wins</li>
<li>Finally, batch the input to avoid tripping TypeScript's recursion depth limits</li>
</ol>
<p>Details follow.</p>
<h2 id="splitting-lines">Splitting lines</h2>
<p>Apparently, <strong>it is now possible to parse strings within TypeScript's type system</strong>. Given that it's <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-5.html#tail-recursion-elimination-on-conditional-types">mentioned in the official docs</a>, I assume it's supported. Note that I don't fully understand the limitations of this approach. It's certainly not magic.</p>
<p>In my case, I knew ahead of time the set of all possible characters in the input file, so I was able to define a type that is the union of all possible characters:</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">RanksDescending</span> <span class="hl-operator">=</span> <span class="hl-operator">[</span><span class="hl-string">&quot;A&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;K&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;Q&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;J&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;T&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;9&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;8&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;7&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;6&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;5&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;4&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;3&quot;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;2&quot;</span><span class="hl-operator">]</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">Rank</span> <span class="hl-operator">=</span> <span class="hl-identifier">RanksDescending</span><span class="hl-operator">[</span><span class="hl-type">number</span><span class="hl-operator">]</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">Suit</span> <span class="hl-operator">=</span> <span class="hl-string">&quot;C&quot;</span> <span class="hl-operator">|</span> <span class="hl-string">&quot;D&quot;</span> <span class="hl-operator">|</span> <span class="hl-string">&quot;H&quot;</span> <span class="hl-operator">|</span> <span class="hl-string">&quot;S&quot;</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">NonNewline</span> <span class="hl-operator">=</span> <span class="hl-identifier">Rank</span> <span class="hl-operator">|</span> <span class="hl-identifier">Suit</span> <span class="hl-operator">|</span> <span class="hl-string">&quot; &quot;</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">Character</span> <span class="hl-operator">=</span> <span class="hl-string">&quot;\n&quot;</span> <span class="hl-operator">|</span> <span class="hl-identifier">NonNewline</span><span class="hl-operator">;</span>
</code></pre>
<p>Armed with these types, it's possible to <strong>accumulate strings character-by-character, breaking on <code>\n</code></strong> (and using tail calls, as described in the previous link):</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">SplitLines</span><span class="hl-operator">&lt;</span><span class="hl-identifier">Input</span> <span class="hl-keyword">extends</span> <span class="hl-type">string</span><span class="hl-operator">,</span> <span class="hl-identifier">Line</span> <span class="hl-keyword">extends</span> <span class="hl-type">string</span><span class="hl-operator">,</span> <span class="hl-identifier">Output</span> <span class="hl-keyword">extends</span> <span class="hl-type">string</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">Input</span> <span class="hl-keyword">extends</span> <span class="hl-string">&quot;&quot;</span>
        <span class="hl-operator">?</span> <span class="hl-operator">[</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">Output</span><span class="hl-operator">,</span> <span class="hl-identifier">Line</span><span class="hl-operator">]</span> <span class="hl-comment">// Done reading input; add final line</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">Input</span> <span class="hl-keyword">extends</span> <span class="hl-string">`${infer C extends Character}${infer Rest}`</span>
            <span class="hl-operator">?</span> <span class="hl-identifier">C</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">NonNewline</span>
                <span class="hl-operator">?</span> <span class="hl-identifier">SplitLines</span><span class="hl-operator">&lt;</span><span class="hl-identifier">Rest</span><span class="hl-operator">,</span> <span class="hl-string">`${Line}${C}`</span><span class="hl-operator">,</span> <span class="hl-identifier">Output</span><span class="hl-operator">&gt;</span> <span class="hl-comment">// Not a newline: accumulate into Line</span>
                <span class="hl-operator">:</span> <span class="hl-identifier">SplitLines</span><span class="hl-operator">&lt;</span><span class="hl-identifier">Rest</span><span class="hl-operator">,</span> <span class="hl-string">&quot;&quot;</span><span class="hl-operator">,</span> <span class="hl-operator">[</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">Output</span><span class="hl-operator">,</span> <span class="hl-identifier">Line</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-comment">// Newline: reset accumulator; add Line to Output</span>
            <span class="hl-operator">:</span> <span class="hl-type">never</span><span class="hl-operator">;</span>
</code></pre>
<p>Each line can then be processed individually.</p>
<h2 id="parsing-cards">Parsing cards</h2>
<p>Parsing cards <strong>arguably uses TypeScript features as intended</strong> (to read in two characters):</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">Card</span> <span class="hl-operator">=</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-identifier">Rank</span><span class="hl-operator">,</span> <span class="hl-identifier">suit</span><span class="hl-operator">:</span> <span class="hl-identifier">Suit</span> <span class="hl-operator">}</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">S</span> <span class="hl-keyword">extends</span> <span class="hl-type">string</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">S</span> <span class="hl-keyword">extends</span> <span class="hl-string">`${infer CardRank extends Rank}${infer CardSuit extends Suit}`</span>
        <span class="hl-operator">?</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-identifier">CardRank</span><span class="hl-operator">,</span> <span class="hl-identifier">suit</span><span class="hl-operator">:</span> <span class="hl-identifier">CardSuit</span> <span class="hl-operator">}</span>
        <span class="hl-operator">:</span> <span class="hl-type">never</span><span class="hl-operator">;</span>
</code></pre>
<p>I let the next two steps leak into my &quot;parse lines&quot; code, so ignore <code>DataFromHand</code> and <code>EvaluationFromData</code> in this code to read 10 cards (5 for each hand):</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">ProcessLine</span><span class="hl-operator">&lt;</span><span class="hl-identifier">L</span> <span class="hl-keyword">extends</span> <span class="hl-type">string</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">L</span> <span class="hl-keyword">extends</span> <span class="hl-string">`${infer A1} ${infer A2} ${infer A3} ${infer A4} ${infer A5} ${infer B1} ${infer B2} ${infer B3} ${infer B4} ${infer B5}`</span>
        <span class="hl-operator">?</span> <span class="hl-operator">[</span>
            <span class="hl-identifier">EvaluationFromData</span><span class="hl-operator">&lt;</span><span class="hl-identifier">DataFromHand</span><span class="hl-operator">&lt;</span><span class="hl-operator">[</span><span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A1</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A2</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A3</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A4</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A5</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>
            <span class="hl-identifier">EvaluationFromData</span><span class="hl-operator">&lt;</span><span class="hl-identifier">DataFromHand</span><span class="hl-operator">&lt;</span><span class="hl-operator">[</span><span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">B1</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">B2</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">B3</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">B4</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">ParseCard</span><span class="hl-operator">&lt;</span><span class="hl-identifier">B5</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>
        <span class="hl-operator">]</span>
        <span class="hl-operator">:</span> <span class="hl-type">never</span><span class="hl-operator">;</span>
</code></pre>
<p>With that, parsing is complete: each line is now two hands of five cards.</p>
<h2 id="grouping-cards">Grouping cards</h2>
<p><strong>Grouping cards by rank and suit got a bit hairy</strong>. In fact, I had to rewrite the &quot;is this a flush?&quot; check a few times because certain approaches would silently fail when referenced from other types (it's possible these are bugs in the TypeScript compiler, but opening an &quot;I can't run poker in the type system&quot; bug would likely be a waste of everyone's time).</p>
<p>Regardless, my approach was to <strong>walk an ordered array of ranks and then count cards matching that rank</strong>, removing &quot;empty&quot; (count of zero) ranks at the end. This involved a few utility types for selecting (&quot;keeping&quot;) items from an array and counting the number of items in an array (ignore the unary number part--I'll get to that in due time).</p>
<p>Using the examples hands from earlier, the result is something like:</p>
<ul>
<li>First player: 3 aces, 1 nine, 1 two</li>
<li>Second player: 1 queen, 1 ten, 1 seven, 1 six, 1 three</li>
</ul>
<p>Relevant code:</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">Equal</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">B</span> <span class="hl-operator">?</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">A</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span> <span class="hl-operator">:</span> <span class="hl-keyword">false</span> <span class="hl-operator">:</span> <span class="hl-keyword">false</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">ArrayLength</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-type">any</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">UnaryToNumber</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-type">any</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">,</span> <span class="hl-identifier">Item</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-identifier">infer</span> <span class="hl-identifier">First</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">infer</span> <span class="hl-identifier">Rest</span><span class="hl-operator">]</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">First</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Item</span>
            <span class="hl-operator">?</span> <span class="hl-operator">[</span><span class="hl-identifier">First</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">Rest</span><span class="hl-operator">,</span> <span class="hl-identifier">Item</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span>
            <span class="hl-operator">:</span> <span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">Rest</span><span class="hl-operator">,</span> <span class="hl-identifier">Item</span><span class="hl-operator">&gt;</span>
        <span class="hl-operator">:</span> <span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">Hand</span> <span class="hl-operator">=</span> <span class="hl-identifier">Card</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">RankCount</span> <span class="hl-operator">=</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-identifier">Rank</span><span class="hl-operator">,</span> <span class="hl-identifier">count</span><span class="hl-operator">:</span> <span class="hl-type">number</span> <span class="hl-operator">}</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">Data</span> <span class="hl-operator">=</span> <span class="hl-operator">{</span> <span class="hl-identifier">counts</span><span class="hl-operator">:</span> <span class="hl-identifier">RankCount</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">,</span> <span class="hl-identifier">flush</span><span class="hl-operator">:</span> <span class="hl-keyword">boolean</span> <span class="hl-operator">}</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">CountRank</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Hand</span><span class="hl-operator">,</span> <span class="hl-identifier">R</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-identifier">R</span><span class="hl-operator">,</span> <span class="hl-identifier">count</span><span class="hl-operator">:</span> <span class="hl-identifier">ArrayLength</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">,</span> <span class="hl-identifier">CardOfRank</span><span class="hl-operator">&lt;</span><span class="hl-identifier">R</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span> <span class="hl-operator">}</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">CountRanksRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Hand</span><span class="hl-operator">,</span> <span class="hl-identifier">R</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">,</span> <span class="hl-identifier">Result</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">RankCount</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">R</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-identifier">infer</span> <span class="hl-identifier">First</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">infer</span> <span class="hl-identifier">Rest</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-identifier">CountRanksRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">,</span> <span class="hl-identifier">Rest</span><span class="hl-operator">,</span> <span class="hl-operator">[</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">Result</span><span class="hl-operator">,</span> <span class="hl-identifier">CountRank</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">,</span> <span class="hl-identifier">First</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">:</span> <span class="hl-identifier">Result</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">CountRanks</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Hand</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">CountRanksRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">,</span> <span class="hl-identifier">RanksDescending</span><span class="hl-operator">,</span> <span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">SortedRankCounts</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Hand</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">CountRanks</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">count</span><span class="hl-operator">:</span> <span class="hl-operator">(</span><span class="hl-number">1</span> <span class="hl-operator">|</span> <span class="hl-number">2</span> <span class="hl-operator">|</span> <span class="hl-number">3</span> <span class="hl-operator">|</span> <span class="hl-number">4</span><span class="hl-operator">)</span> <span class="hl-operator">}</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
</code></pre>
<p>Why &quot;keep&quot; counts of 1 through 4 instead of removing counts of 0? Because this approach worked and removing zeroes didn't. <strong>I don't know why</strong> (especially since it worked when used directly--just not when referenced transitively).</p>
<p>Next, I also needed to track whether a hand was a flush or not (N.B. checking all five cards' suits for equality also didn't work unless directly referenced--still no idea why):</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">Or</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-keyword">true</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span> <span class="hl-operator">:</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-keyword">true</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span> <span class="hl-operator">:</span> <span class="hl-keyword">false</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">Or4</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span><span class="hl-operator">,</span> <span class="hl-identifier">C</span><span class="hl-operator">,</span> <span class="hl-identifier">D</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">Or</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-identifier">Or</span><span class="hl-operator">&lt;</span><span class="hl-identifier">B</span><span class="hl-operator">,</span> <span class="hl-identifier">Or</span><span class="hl-operator">&lt;</span><span class="hl-identifier">C</span><span class="hl-operator">,</span> <span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">FlushOfSuit</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Hand</span><span class="hl-operator">,</span> <span class="hl-identifier">S</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Suit</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">Equal</span><span class="hl-operator">&lt;</span><span class="hl-number">5</span><span class="hl-operator">,</span> <span class="hl-identifier">ArrayLength</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">suit</span><span class="hl-operator">:</span> <span class="hl-identifier">S</span> <span class="hl-operator">}</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">Flush</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Hand</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">Or4</span><span class="hl-operator">&lt;</span><span class="hl-identifier">FlushOfSuit</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">,</span> <span class="hl-string">&quot;C&quot;</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">FlushOfSuit</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">,</span> <span class="hl-string">&quot;S&quot;</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">FlushOfSuit</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">,</span> <span class="hl-string">&quot;H&quot;</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">FlushOfSuit</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">,</span> <span class="hl-string">&quot;D&quot;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
</code></pre>
<p>Final output type for this stage:</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">DataFromHand</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Hand</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-operator">{</span> <span class="hl-identifier">counts</span><span class="hl-operator">:</span> <span class="hl-identifier">SortedRankCounts</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">flush</span><span class="hl-operator">:</span> <span class="hl-identifier">Flush</span><span class="hl-operator">&lt;</span><span class="hl-identifier">H</span><span class="hl-operator">&gt;</span> <span class="hl-operator">}</span><span class="hl-operator">;</span>
</code></pre>
<h2 id="analyzing-hands">Analyzing hands</h2>
<p>Armed with the sorted ranks and counts of cards (along with a flag indicating a flush), it was possible to start identifying the &quot;types&quot; (pun intended) of poker hands.</p>
<p>Here are a few simple examples that just see how many ranks have a count of N:</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">And</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-keyword">true</span> <span class="hl-operator">?</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-keyword">true</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span> <span class="hl-operator">:</span> <span class="hl-keyword">false</span> <span class="hl-operator">:</span> <span class="hl-keyword">false</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">RankCountOfCount</span><span class="hl-operator">&lt;</span><span class="hl-identifier">C</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-operator">{</span> <span class="hl-identifier">count</span><span class="hl-operator">:</span> <span class="hl-identifier">C</span> <span class="hl-operator">}</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">IsFourOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">Equal</span><span class="hl-operator">&lt;</span><span class="hl-number">1</span><span class="hl-operator">,</span> <span class="hl-identifier">ArrayLength</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">RankCountsFromData</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">RankCountOfCount</span><span class="hl-operator">&lt;</span><span class="hl-number">4</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">IsTwoPair</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">Equal</span><span class="hl-operator">&lt;</span><span class="hl-number">2</span><span class="hl-operator">,</span> <span class="hl-identifier">ArrayLength</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">RankCountsFromData</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">RankCountOfCount</span><span class="hl-operator">&lt;</span><span class="hl-number">2</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">HasThreeOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">Equal</span><span class="hl-operator">&lt;</span><span class="hl-number">1</span><span class="hl-operator">,</span> <span class="hl-identifier">ArrayLength</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">RankCountsFromData</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">RankCountOfCount</span><span class="hl-operator">&lt;</span><span class="hl-number">3</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">HasOnePair</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">Equal</span><span class="hl-operator">&lt;</span><span class="hl-number">1</span><span class="hl-operator">,</span> <span class="hl-identifier">ArrayLength</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">RankCountsFromData</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">RankCountOfCount</span><span class="hl-operator">&lt;</span><span class="hl-number">2</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">IsFullHouse</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">And</span><span class="hl-operator">&lt;</span><span class="hl-identifier">HasThreeOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">HasOnePair</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
</code></pre>
<p>Identifying straights seemed tricky, so I just hard-coded them all:</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">IsStraight</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-operator">{</span> <span class="hl-identifier">counts</span><span class="hl-operator">:</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">DataCounts</span> <span class="hl-operator">}</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;A&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;5&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;4&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;3&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;2&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;6&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;5&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;4&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;3&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;2&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;7&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;6&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;5&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;4&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;3&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;8&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;7&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;6&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;5&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;4&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;9&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;8&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;7&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;6&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;5&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;T&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;9&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;8&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;7&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;6&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;J&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;T&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;9&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;8&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;7&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;Q&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;J&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;T&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;9&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;8&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;K&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;Q&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;J&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;T&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;9&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">DataCounts</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;A&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;K&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;Q&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;J&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-string">&quot;T&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-keyword">true</span>
        <span class="hl-operator">:</span> <span class="hl-keyword">false</span>
    <span class="hl-operator">:</span> <span class="hl-keyword">false</span><span class="hl-operator">;</span>
</code></pre>
<p>But I also needed to supply tie-breakers, so here are some utilities for retrieving the (previously sorted) rank(s) of cardinality N:</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">RankForNOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">,</span> <span class="hl-identifier">N</span> <span class="hl-keyword">extends</span> <span class="hl-type">number</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">RankCountsFromData</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">RankCountOfCount</span><span class="hl-operator">&lt;</span><span class="hl-identifier">N</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">R</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span> <span class="hl-operator">}</span><span class="hl-operator">]</span> <span class="hl-operator">?</span> <span class="hl-identifier">R</span> <span class="hl-operator">:</span> <span class="hl-type">never</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">RanksForNsOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">,</span> <span class="hl-identifier">N</span> <span class="hl-keyword">extends</span> <span class="hl-type">number</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">RanksFromRankCounts</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ArrayKeep</span><span class="hl-operator">&lt;</span><span class="hl-identifier">RankCountsFromData</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">RankCountOfCount</span><span class="hl-operator">&lt;</span><span class="hl-identifier">N</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
</code></pre>
<p>And I needed to handle the fact that aces can be low <em>or</em> high in a straight:</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">C</span><span class="hl-operator">,</span> <span class="hl-identifier">T</span><span class="hl-operator">,</span> <span class="hl-identifier">F</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">C</span> <span class="hl-keyword">extends</span> <span class="hl-keyword">true</span> <span class="hl-operator">?</span> <span class="hl-identifier">T</span> <span class="hl-operator">:</span> <span class="hl-identifier">F</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">RankForStraight</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-operator">{</span> <span class="hl-identifier">counts</span><span class="hl-operator">:</span> <span class="hl-operator">[</span><span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">FirstRank</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">rank</span><span class="hl-operator">:</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">SecondRank</span> <span class="hl-operator">}</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">infer</span> <span class="hl-identifier">Rest</span><span class="hl-operator">]</span> <span class="hl-operator">}</span>
        <span class="hl-comment">// Note the special case for straights that *begin* with an ace</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">And</span><span class="hl-operator">&lt;</span><span class="hl-identifier">Equal</span><span class="hl-operator">&lt;</span><span class="hl-identifier">FirstRank</span><span class="hl-operator">,</span> <span class="hl-string">&quot;A&quot;</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">Equal</span><span class="hl-operator">&lt;</span><span class="hl-identifier">SecondRank</span><span class="hl-operator">,</span> <span class="hl-string">&quot;5&quot;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-string">&quot;5&quot;</span><span class="hl-operator">,</span> <span class="hl-identifier">FirstRank</span><span class="hl-operator">&gt;</span>
        <span class="hl-operator">:</span> <span class="hl-type">never</span><span class="hl-operator">;</span>
</code></pre>
<p>Finally, here's the closest to a lookup table I was able to create:</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">EvaluationFromData</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Data</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">IsStraightFlush</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>  <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-string">&quot;straightFlush&quot;</span><span class="hl-operator">,</span>    <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-operator">[</span><span class="hl-identifier">RankForStraight</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span> <span class="hl-operator">}</span><span class="hl-operator">,</span>
    <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">IsFourOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>    <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-string">&quot;fourOfAKind&quot;</span><span class="hl-operator">,</span>      <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-operator">[</span><span class="hl-identifier">RankForNOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">4</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span> <span class="hl-operator">}</span><span class="hl-operator">,</span>
    <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">IsFullHouse</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>      <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-string">&quot;fullHouse&quot;</span><span class="hl-operator">,</span>        <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-operator">[</span><span class="hl-identifier">RankForNOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">3</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">RankForNOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">2</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span> <span class="hl-operator">}</span><span class="hl-operator">,</span>
    <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">IsFlush</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>          <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-string">&quot;flush&quot;</span><span class="hl-operator">,</span>            <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-identifier">RanksForNsOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">1</span><span class="hl-operator">&gt;</span> <span class="hl-operator">}</span><span class="hl-operator">,</span>
    <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">IsStraight</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>       <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-string">&quot;straight&quot;</span><span class="hl-operator">,</span>         <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-operator">[</span><span class="hl-identifier">RankForStraight</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span> <span class="hl-operator">}</span><span class="hl-operator">,</span>
    <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">HasThreeOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>  <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-string">&quot;threeOfAKind&quot;</span><span class="hl-operator">,</span>     <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-operator">[</span><span class="hl-identifier">RankForNOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">3</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span> <span class="hl-operator">}</span><span class="hl-operator">,</span>
    <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">IsTwoPair</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>        <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-string">&quot;twoPair&quot;</span><span class="hl-operator">,</span>          <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-operator">[</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">RanksForNsOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">2</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-identifier">RankForNOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">1</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span> <span class="hl-operator">}</span><span class="hl-operator">,</span>
    <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">HasOnePair</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>       <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-string">&quot;pair&quot;</span><span class="hl-operator">,</span>             <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-operator">[</span><span class="hl-identifier">RankForNOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">2</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">RanksForNsOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">1</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span> <span class="hl-operator">}</span><span class="hl-operator">,</span>
    <span class="hl-comment">/* High card */</span>         <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-string">&quot;highCard&quot;</span><span class="hl-operator">,</span>         <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-identifier">RanksForNsOfAKind</span><span class="hl-operator">&lt;</span><span class="hl-identifier">D</span><span class="hl-operator">,</span> <span class="hl-number">1</span><span class="hl-operator">&gt;</span> <span class="hl-operator">}</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
</code></pre>
<p>The output of this stage is the &quot;type&quot; of the hand (two pair, flush, high card, etc.) and any tie-breakers that might be needed.</p>
<h2 id="comparing-hands">Comparing hands</h2>
<p>Similar to sorting ranks, both ranks and poker hand &quot;types&quot; are compared relatively by walking the ordered array until a &quot;winner&quot; is found. <strong>Despite sounding very simple, it took an entire page of code</strong>:</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">GreaterRankRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">,</span> <span class="hl-identifier">R</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">R</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-identifier">infer</span> <span class="hl-identifier">First</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">infer</span> <span class="hl-identifier">Rest</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">]</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">First</span>
            <span class="hl-operator">?</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">First</span>
                <span class="hl-operator">?</span> <span class="hl-keyword">false</span>     <span class="hl-comment">// A = B</span>
                <span class="hl-operator">:</span> <span class="hl-keyword">true</span>      <span class="hl-comment">// A &gt; B</span>
            <span class="hl-operator">:</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">First</span>
                <span class="hl-operator">?</span> <span class="hl-keyword">false</span>     <span class="hl-comment">// A &lt; B</span>
                <span class="hl-operator">:</span> <span class="hl-identifier">GreaterRankRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span><span class="hl-operator">,</span> <span class="hl-identifier">Rest</span><span class="hl-operator">&gt;</span> <span class="hl-comment">// Neither A nor B match; try next lower rank</span>
        <span class="hl-operator">:</span> <span class="hl-keyword">false</span><span class="hl-operator">;</span> <span class="hl-comment">// Probably should have used `never` here</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">GreaterRank</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">GreaterRankRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span><span class="hl-operator">,</span> <span class="hl-identifier">RanksDescending</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">GreaterRanks</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-identifier">infer</span> <span class="hl-identifier">ARank</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">infer</span> <span class="hl-identifier">ARest</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">]</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-identifier">infer</span> <span class="hl-identifier">BRank</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">infer</span> <span class="hl-identifier">BRest</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">]</span>
            <span class="hl-operator">?</span> <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">GreaterRank</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ARank</span><span class="hl-operator">,</span> <span class="hl-identifier">BRank</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>
                <span class="hl-keyword">true</span><span class="hl-operator">,</span>       <span class="hl-comment">// A &gt; B</span>
                <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">GreaterRank</span><span class="hl-operator">&lt;</span><span class="hl-identifier">BRank</span><span class="hl-operator">,</span> <span class="hl-identifier">ARank</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>
                    <span class="hl-keyword">false</span><span class="hl-operator">,</span>  <span class="hl-comment">// A &lt; B</span>
                    <span class="hl-identifier">GreaterRanks</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ARest</span><span class="hl-operator">,</span> <span class="hl-identifier">BRest</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span> <span class="hl-comment">// A = B</span>
            <span class="hl-operator">:</span> <span class="hl-type">never</span>
        <span class="hl-operator">:</span> <span class="hl-keyword">false</span><span class="hl-operator">;</span> <span class="hl-comment">// No more tie-breakers; treat as &quot;not a win for A&quot;</span>

<span class="hl-comment">// Basically the same as GreaterRankRecursive</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">BetterHandType</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">HandType</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">HandType</span><span class="hl-operator">,</span> <span class="hl-identifier">H</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">HandType</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">H</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-identifier">infer</span> <span class="hl-identifier">First</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">infer</span> <span class="hl-identifier">Rest</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">HandType</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">]</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">First</span>
            <span class="hl-operator">?</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">First</span>
                <span class="hl-operator">?</span> <span class="hl-keyword">false</span>
                <span class="hl-operator">:</span> <span class="hl-keyword">true</span>
            <span class="hl-operator">:</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">First</span>
                <span class="hl-operator">?</span> <span class="hl-keyword">false</span>
                <span class="hl-operator">:</span> <span class="hl-identifier">BetterHandType</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span><span class="hl-operator">,</span> <span class="hl-identifier">Rest</span><span class="hl-operator">&gt;</span>
        <span class="hl-operator">:</span> <span class="hl-keyword">false</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">BetterEvaluation</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Evaluation</span><span class="hl-operator">,</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Evaluation</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">AH</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">HandType</span><span class="hl-operator">,</span> <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">AT</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span> <span class="hl-operator">}</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">B</span> <span class="hl-keyword">extends</span> <span class="hl-operator">{</span> <span class="hl-identifier">handType</span><span class="hl-operator">:</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">BH</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">HandType</span><span class="hl-operator">,</span> <span class="hl-identifier">tieBreakers</span><span class="hl-operator">:</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">BT</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Rank</span><span class="hl-operator">[</span><span class="hl-operator">]</span> <span class="hl-operator">}</span>
            <span class="hl-operator">?</span> <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">BetterHandType</span><span class="hl-operator">&lt;</span><span class="hl-identifier">AH</span><span class="hl-operator">,</span> <span class="hl-identifier">BH</span><span class="hl-operator">,</span> <span class="hl-identifier">HandTypesDescending</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>
                <span class="hl-keyword">true</span><span class="hl-operator">,</span>       <span class="hl-comment">// A has the better hand type</span>
                <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">BetterHandType</span><span class="hl-operator">&lt;</span><span class="hl-identifier">BH</span><span class="hl-operator">,</span> <span class="hl-identifier">AH</span><span class="hl-operator">,</span> <span class="hl-identifier">HandTypesDescending</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>
                    <span class="hl-keyword">false</span><span class="hl-operator">,</span>  <span class="hl-comment">// B has the better hand type</span>
                    <span class="hl-identifier">GreaterRanks</span><span class="hl-operator">&lt;</span><span class="hl-identifier">AT</span><span class="hl-operator">,</span> <span class="hl-identifier">BT</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span> <span class="hl-comment">// Same hand types; compare tie-breakers</span>
            <span class="hl-operator">:</span> <span class="hl-type">never</span>
        <span class="hl-operator">:</span> <span class="hl-type">never</span><span class="hl-operator">;</span>
</code></pre>
<h2 id="counting-wins">Counting wins</h2>
<p>Counting involves numbers, and <strong>I didn't see an obvious way to perform arithmetic in TypeScript's type system</strong>. So I had to (<a href="100-languages-2.html">once again</a>) implement my own arithmetic. Fortunately, I was able to simply use a unary encoding based on array length (this works for values up to ~500):</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">UnaryZero</span> <span class="hl-operator">=</span> <span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">UnaryNumber</span> <span class="hl-operator">=</span> <span class="hl-type">any</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">UnaryToNumber</span><span class="hl-operator">&lt;</span><span class="hl-identifier">T</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">UnaryNumber</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">T</span> <span class="hl-keyword">extends</span> <span class="hl-operator">{</span> <span class="hl-identifier">length</span><span class="hl-operator">:</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">L</span> <span class="hl-keyword">extends</span> <span class="hl-type">number</span> <span class="hl-operator">}</span> <span class="hl-operator">?</span> <span class="hl-identifier">L</span> <span class="hl-operator">:</span> <span class="hl-type">never</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">UnaryIncrement</span><span class="hl-operator">&lt;</span><span class="hl-identifier">T</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">UnaryNumber</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-operator">[</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">T</span><span class="hl-operator">,</span> <span class="hl-type">any</span><span class="hl-operator">]</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">UnaryOne</span> <span class="hl-operator">=</span> <span class="hl-identifier">UnaryIncrement</span><span class="hl-operator">&lt;</span><span class="hl-identifier">UnaryZero</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
</code></pre>
<p>I tracked wins in an array of (unary) zeroes (losses) or ones (wins):</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">ScoreRound</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Evaluation</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-identifier">infer</span> <span class="hl-identifier">First</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Evaluation</span><span class="hl-operator">,</span> <span class="hl-identifier">infer</span> <span class="hl-identifier">Second</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Evaluation</span><span class="hl-operator">]</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">If</span><span class="hl-operator">&lt;</span><span class="hl-identifier">BetterEvaluation</span><span class="hl-operator">&lt;</span><span class="hl-identifier">First</span><span class="hl-operator">,</span> <span class="hl-identifier">Second</span><span class="hl-operator">&gt;</span><span class="hl-operator">,</span>
            <span class="hl-identifier">UnaryOne</span><span class="hl-operator">,</span>
            <span class="hl-identifier">UnaryZero</span><span class="hl-operator">&gt;</span>
        <span class="hl-operator">:</span> <span class="hl-type">never</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">ScoreRoundsRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Evaluation</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">,</span> <span class="hl-identifier">S</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">UnaryNumber</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-identifier">infer</span> <span class="hl-identifier">Line</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Evaluation</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">infer</span> <span class="hl-identifier">Rest</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Evaluation</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">]</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">ScoreRoundsRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">Rest</span><span class="hl-operator">,</span> <span class="hl-operator">[</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">S</span><span class="hl-operator">,</span> <span class="hl-identifier">ScoreRound</span><span class="hl-operator">&lt;</span><span class="hl-identifier">Line</span><span class="hl-operator">&gt;</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">S</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">ScoreRounds</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">Evaluation</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">ScoreRoundsRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
</code></pre>
<h2 id="batching">Batching</h2>
<p>Sadly, I wasn't able to solve the entire problem in one go because <strong>TypeScript (even with tail call elimination) has limits on recursion depth</strong>. My solution was to process batches of 25 lines at a time (40 batches in total), and then simply sum the sub-scores from each batch.</p>
<p>N.B. I used JavaScript to split the input file into batches. Sorry! I am a fraud.</p>
<pre><code class="language-typescript"><span class="hl-keyword">type</span> <span class="hl-identifier">UnarySumRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">UnaryNumber</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">,</span> <span class="hl-identifier">S</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">UnaryNumber</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span>
    <span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-operator">[</span><span class="hl-identifier">infer</span> <span class="hl-identifier">T</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">UnaryNumber</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">infer</span> <span class="hl-identifier">Rest</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">UnaryNumber</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">]</span>
        <span class="hl-operator">?</span> <span class="hl-identifier">UnarySumRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">Rest</span><span class="hl-operator">,</span> <span class="hl-operator">[</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">T</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-identifier">S</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span>
        <span class="hl-operator">:</span> <span class="hl-identifier">S</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">UnarySum</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span> <span class="hl-keyword">extends</span> <span class="hl-identifier">UnaryNumber</span><span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">UnarySumRecursive</span><span class="hl-operator">&lt;</span><span class="hl-identifier">A</span><span class="hl-operator">,</span> <span class="hl-identifier">UnaryZero</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">ScoreBlock</span><span class="hl-operator">&lt;</span><span class="hl-identifier">S</span> <span class="hl-keyword">extends</span> <span class="hl-type">string</span><span class="hl-operator">&gt;</span> <span class="hl-operator">=</span> <span class="hl-identifier">UnarySum</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ScoreRounds</span><span class="hl-operator">&lt;</span><span class="hl-identifier">ProcessLines</span><span class="hl-operator">&lt;</span><span class="hl-identifier">SplitLines</span><span class="hl-operator">&lt;</span><span class="hl-identifier">S</span><span class="hl-operator">,</span> <span class="hl-string">&quot;&quot;</span><span class="hl-operator">,</span> <span class="hl-operator">[</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>

<span class="hl-keyword">type</span> <span class="hl-identifier">t1</span> <span class="hl-operator">=</span> <span class="hl-identifier">ScoreBlock</span><span class="hl-operator">&lt;</span><span class="hl-string">&quot;8C TS KC 9H 4S 7D 2S 5D 3S AC\n5C AD 5D AC 9C 7C 5H 8D TD KS\n ...&quot;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">t2</span> <span class="hl-operator">=</span> <span class="hl-identifier">ScoreBlock</span><span class="hl-operator">&lt;</span><span class="hl-string">&quot;5H 6H 2S KS 3D 5D JD 7H JS 8H\nKH 4H AS JS QS QC TC 6D 7C KS\n ...&quot;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-keyword">type</span> <span class="hl-identifier">CorrectAnswer</span> <span class="hl-operator">=</span> <span class="hl-identifier">UnaryToNumber</span><span class="hl-operator">&lt;</span><span class="hl-identifier">UnarySum</span><span class="hl-operator">&lt;</span><span class="hl-operator">[</span><span class="hl-identifier">t1</span><span class="hl-operator">,</span> <span class="hl-identifier">t2</span><span class="hl-operator">,</span> <span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">,</span> <span class="hl-identifier">t40</span><span class="hl-operator">]</span><span class="hl-operator">&gt;</span><span class="hl-operator">&gt;</span><span class="hl-operator">;</span>
</code></pre>
<p>In the end, I just needed to hover over the <code>CorrectAnswer</code> type in my editor and (eventually), it showed me the correct answer.</p>
<h2 id="on-the-command-line">On the command line</h2>
<p>It's also possible to have <code>tsc</code> emit the answer by forcing a type-checking error by supplying a known-incorrect value:</p>
<pre><code class="language-typescript"><span class="hl-keyword">const</span> <span class="hl-identifier">guess</span><span class="hl-operator">:</span> <span class="hl-identifier">CorrectAnswer</span> <span class="hl-operator">=</span> <span class="hl-number">42</span><span class="hl-operator">;</span> <span class="hl-comment">// Definitely not correct!</span>
</code></pre>
<p>Running <code>tsc</code> produces the following output (<strong>spoiler alert!</strong>):</p>
<pre><code>error TS2322: Type '42' is not assignable to type '376'.
</code></pre>
<h1 id="conclusion">Conclusion</h1>
<p><strong>Extreme Typing: it's a thing!</strong></p>
<p>Resources:</p>
<ul>
<li><a href="https://github.com/jaredkrinke/100-languages/blob/main/src/p54.ts">Source code for my solution</a></li>
<li><a href="https://www.learningtypescript.com/articles/extreme-explorations-of-typescripts-type-system">Extreme Explorations of TypeScript's Type System</a></li>
<li><a href="https://github.com/arielhs/ts-arithmetic">Type Level Arithmetic</a></li>
</ul>

<footer>
<p>&crarr; <a href="../../index.html">Back to home</a></p>
</footer>
</article>
</main>

</body>
</html>
