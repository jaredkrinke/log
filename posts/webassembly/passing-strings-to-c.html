<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Passing strings to and from WebAssembly using C</title>
<meta name="description" content="Here&#039;s an example of passing strings to and from a WebAssembly module that is written in C and compiled with Clang and LLVM." />

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link rel="stylesheet" href="../../css/style.css" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Passing strings to and from WebAssembly using C",
  "abstract": "Here's an example of passing strings to and from a WebAssembly module that is written in C and compiled with Clang and LLVM.",
  "keywords": "webassembly",
  "datePublished": "2021-10-05"
}
</script>
</head>
<body>
<header>
<h1><a href="../../index.html">Schemescape</a></h1>
<p>Development log of a life-long coder</p>

<nav>
<strong>Topics:&nbsp;</strong>
<ul>
<li><a href="../../posts/webassembly/index.html">webassembly</a></li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h1><a href="../../posts/webassembly/passing-strings-to-c.html">Passing strings to and from WebAssembly using C</a></h1>
<p><time datetime="2021-10-05">October 5, 2021</time></p>
</header>
<p>As a follow-up to a <a href="trivial-example.html">trivial WebAssembly example in C</a> and <a href="c-standard-library-example.html">an example of using the C standard library in WebAssembly</a>, I'm now investigating passing strings back and forth between the JavaScript host and a WebAssembly module written in C (and compiled with Clang/LLVM).</p>
<p>Links to a library (<strong>new</strong>), the sample code, and a live demo are at <a href="#links">the end of the post</a>.</p>
<h1 id="passing-a-string-from-javascript-to-c">Passing a string from JavaScript to C</h1>
<p>Recall that WebAssembly <a href="https://webassembly.github.io/spec/core/syntax/types.html">doesn't have a string type</a>. How can a C function receive a string when compiled to WebAssembly?</p>
<h2 id="pass-in-by-directly-populating-linear-memory">Pass in by directly populating linear memory</h2>
<p>Also known as: failed attempt #1.</p>
<ol>
<li>Add a null character onto the end of the string</li>
<li>Use the browser's TextEncoder API to convert a string to a byte sequence</li>
<li>Write the buffer into linear memory</li>
<li>Pass the address of the null-terminated string to C code</li>
<li>C code can read the string as a null-terminated UTF-8 string</li>
</ol>
<p>Obviously, this limits strings to fit in linear memory (where I assume the maximum size is 2^32-1), and requiring a null terminator means embedded nulls aren't supported. I don't think these will be a problem for me personally.</p>
<p>I gave this approach a try, but there were several problems with it.</p>
<p>The <a href="https://lld.llvm.org/WebAssembly.html">LLVM WebAssembly documentation</a> hints at it, but inspecting the output of a trivial C program compiled to WebAssembly shows that LLVM's WebAssembly linker uses linear memory for both the stack and the heap. This makes sense, of course--memory has to come from somewhere. I couldn't find LLVM documentation to definitively confirm this, but <a href="https://surma.dev/things/c-to-webassembly/">I've read that the WebAssembly stack grows downward and has a default size of only 64 KB</a> (customizable with the <code>-z stacksize=&lt;value&gt;</code> option). The heap follows the stack by default.</p>
<p>This means that you don't really have a place to stuff in your encoded string. I also didn't see a way to use a separate memory for passing in data to C functions.</p>
<p>The fundamental problem with this approach is that the C-based WebAssembly module needs complete control over its memory, and there doesn't appear to be a way to access a different memory from C code, as compiled with Clang and LLVM's WebAssembly linker. There are likely libraries (probably with hand-written WebAssembly) to enable this, but I'd like a simple solution.</p>
<h2 id="pass-on-the-stack">Pass on the stack</h2>
<p>Also known as: very limited approach #2.</p>
<p>Probably not a good idea because you're limited based on the maximum stack size (mentioned above), but theoretically you could pass in a string on the stack by having your JavaScript code implement whatever calling convention is used by Clang/LLVM for WebAssembly (modifying the stack pointer as a <a href="https://github.com/WebAssembly/mutable-global">mutable global</a>). This seems tedious and not worth the effort unless you have strings that you know will be much smaller than the maximum stack size (or you tell LLVM's WebAssembly linker to grow the stack upwards (although then you're limiting your heap size, which is probably even more unexpected to most non-embedded C code that's laying around).</p>
<p>I won't dwell on this idea any more since I want to use the default memory layout.</p>
<h2 id="pass-in-via-the-heap">Pass in via the heap</h2>
<p>Also known as: successful attempt #3.</p>
<p>Here's a new idea: let the C code control its entire address space, but expose functions to let JavaScript allocate some memory.</p>
<ol>
<li>Expose <code>allocate</code> and <code>deallocate</code> functions (and the memory itself) to let JavaScript allocate and free memory in the heap</li>
<li>Add a null character onto the end of the string</li>
<li>Use the browser's TextEncoder API to convert a string to a byte sequence</li>
<li>Allocate a buffer (in C address space) for the string (using the exported function <code>allocate</code>)</li>
<li>Write the encoded string into the heap allocation</li>
<li>Call C code to read the string as a (normal) null-terminated UTF-8 string</li>
<li>Deallocate/free the string when it's no longer needed (using the exported function <code>deallocate</code>)</li>
</ol>
<p>This approach adds overhead in the form of allocating for every string passed in, but if the ratio of calls to time spent in each call is low enough, this could be tolerable (and you could always optimize the approach to reuse allocations when possible, if needed). Overall, this seems straight forward and robust, so I'm going to try this out.</p>
<h3 id="c-implementation">C implementation</h3>
<p>As an example, I've created a function that counts the number of occurrences of the (lower case) letter &quot;a&quot; in a string. Note that I have to export an allocator and a deallocator.</p>
<pre><code class="language-c"><span class="hl-preprocessor">#include</span> <span class="hl-string">&lt;malloc.h&gt;</span>

<span class="hl-preprocessor">#define</span> <span class="hl-function">WASM_EXPORT_AS</span><span class="hl-operator">(</span><span class="hl-identifier">name</span><span class="hl-operator">)</span> <span class="hl-keyword">__attribute__</span><span class="hl-operator">(</span><span class="hl-operator">(</span><span class="hl-function">export_name</span><span class="hl-operator">(</span><span class="hl-identifier">name</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">)</span>
<span class="hl-preprocessor">#define</span> <span class="hl-function">WASM_EXPORT</span><span class="hl-operator">(</span><span class="hl-identifier">symbol</span><span class="hl-operator">)</span> <span class="hl-function">WASM_EXPORT_AS</span><span class="hl-operator">(</span><span class="hl-default">#</span><span class="hl-identifier">symbol</span><span class="hl-operator">)</span> <span class="hl-identifier">symbol</span>

<span class="hl-comment">// Memory management helpers</span>
<span class="hl-type">void</span><span class="hl-operator">*</span> <span class="hl-function">WASM_EXPORT</span><span class="hl-operator">(</span><span class="hl-identifier">allocate</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-type">unsigned</span> <span class="hl-type">int</span> <span class="hl-identifier">size</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">return</span> <span class="hl-function_builtin">malloc</span><span class="hl-operator">(</span><span class="hl-identifier">size</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span>

<span class="hl-type">void</span> <span class="hl-function">WASM_EXPORT</span><span class="hl-operator">(</span><span class="hl-identifier">deallocate</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-type">void</span><span class="hl-operator">*</span> <span class="hl-identifier">allocation</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-function_builtin">free</span><span class="hl-operator">(</span><span class="hl-identifier">allocation</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span>

<span class="hl-comment">// Example of passing a string in</span>
<span class="hl-type">unsigned</span> <span class="hl-type">int</span> <span class="hl-function">WASM_EXPORT</span><span class="hl-operator">(</span><span class="hl-identifier">count_as</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-keyword">const</span> <span class="hl-type">char</span><span class="hl-operator">*</span> <span class="hl-identifier">string</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-type">unsigned</span> <span class="hl-type">int</span> <span class="hl-identifier">numberOfAs</span> <span class="hl-operator">=</span> <span class="hl-number">0</span><span class="hl-operator">;</span>
    <span class="hl-keyword">while</span> <span class="hl-operator">(</span><span class="hl-operator">*</span><span class="hl-identifier">string</span> <span class="hl-operator">!</span><span class="hl-operator">=</span> <span class="hl-string">&apos;\0&apos;</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
        <span class="hl-keyword">if</span> <span class="hl-operator">(</span><span class="hl-operator">*</span><span class="hl-identifier">string</span> <span class="hl-operator">=</span><span class="hl-operator">=</span> <span class="hl-string">&apos;a&apos;</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
            <span class="hl-operator">+</span><span class="hl-operator">+</span><span class="hl-identifier">numberOfAs</span><span class="hl-operator">;</span>
        <span class="hl-operator">}</span>
        <span class="hl-identifier">string</span><span class="hl-operator">+</span><span class="hl-operator">+</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>
    <span class="hl-keyword">return</span> <span class="hl-identifier">numberOfAs</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span>
</code></pre>
<h3 id="compiling">Compiling</h3>
<p>The build command is unchanged <a href="c-standard-library-example.html#compiling">from the last post</a>:</p>
<pre><code class="language-bash"><span class="hl-identifier">wasi</span><span class="hl-default">-sdk</span><span class="hl-default">/</span><span class="hl-identifier">bin</span><span class="hl-default">/</span><span class="hl-identifier">clang</span> <span class="hl-default">-Os</span> <span class="hl-default">--sysroot</span> <span class="hl-identifier">wasi</span><span class="hl-default">-sdk</span><span class="hl-default">/</span><span class="hl-identifier">share</span><span class="hl-default">/</span><span class="hl-identifier">wasi</span><span class="hl-default">-sysroot</span> <span class="hl-default">-nostartfiles</span> <span class="hl-default">-Wl</span><span class="hl-default">,</span><span class="hl-default">--no-entry</span> <span class="hl-identifier">string</span><span class="hl-default">-example</span><span class="hl-default">.</span><span class="hl-identifier">c</span> <span class="hl-default">-o</span> <span class="hl-identifier">string</span><span class="hl-default">-example</span><span class="hl-default">.</span><span class="hl-identifier">wasm</span>
</code></pre>
<h3 id="javascript-caller">JavaScript caller</h3>
<p>The JavaScript wrapper is more involved than I'd like, but it does work:</p>
<pre><code class="language-javascript"><span class="hl-keyword">import</span> <span class="hl-identifier">fs</span> <span class="hl-identifier">from</span> <span class="hl-string">&quot;fs&quot;</span><span class="hl-operator">;</span>

<span class="hl-operator">(</span><span class="hl-keyword">async</span> <span class="hl-operator">(</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">module</span> <span class="hl-operator">=</span> <span class="hl-keyword">await</span> <span class="hl-type">WebAssembly</span><span class="hl-operator">.</span><span class="hl-function_method">instantiate</span><span class="hl-operator">(</span><span class="hl-keyword">await</span> <span class="hl-identifier">fs</span><span class="hl-operator">.</span><span class="hl-identifier">promises</span><span class="hl-operator">.</span><span class="hl-function_method">readFile</span><span class="hl-operator">(</span><span class="hl-string">&quot;./string-example.wasm&quot;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

    <span class="hl-comment">// String used for testing (from command line or hard-coded)</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">testString</span> <span class="hl-operator">=</span> <span class="hl-identifier">process</span><span class="hl-operator">.</span><span class="hl-identifier">argv</span><span class="hl-operator">[</span><span class="hl-number">2</span><span class="hl-operator">]</span> <span class="hl-operator">?</span><span class="hl-operator">?</span> <span class="hl-string">&quot;How many letter a&apos;s are there in this string? Three!&quot;</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">nullTerminatedString</span> <span class="hl-operator">=</span> <span class="hl-identifier">testString</span> <span class="hl-operator">+</span> <span class="hl-string">&quot;\0&quot;</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">encodedString</span> <span class="hl-operator">=</span> <span class="hl-operator">(</span><span class="hl-keyword">new</span> <span class="hl-function">TextEncoder</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">.</span><span class="hl-function_method">encode</span><span class="hl-operator">(</span><span class="hl-identifier">nullTerminatedString</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">stringAddress</span> <span class="hl-operator">=</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">allocate</span><span class="hl-operator">(</span><span class="hl-identifier">encodedString</span><span class="hl-operator">.</span><span class="hl-identifier">length</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">try</span> <span class="hl-operator">{</span>
        <span class="hl-keyword">const</span> <span class="hl-identifier">destination</span> <span class="hl-operator">=</span> <span class="hl-keyword">new</span> <span class="hl-type">Uint8Array</span><span class="hl-operator">(</span><span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-identifier">memory</span><span class="hl-operator">.</span><span class="hl-identifier">buffer</span><span class="hl-operator">,</span> <span class="hl-identifier">stringAddress</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-identifier">destination</span><span class="hl-operator">.</span><span class="hl-keyword">set</span><span class="hl-operator">(</span><span class="hl-identifier">encodedString</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-keyword">const</span> <span class="hl-identifier">result</span> <span class="hl-operator">=</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">count_as</span><span class="hl-operator">(</span><span class="hl-identifier">stringAddress</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-identifier">console</span><span class="hl-operator">.</span><span class="hl-function_method">log</span><span class="hl-operator">(</span><span class="hl-identifier">result</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span> <span class="hl-keyword">finally</span> <span class="hl-operator">{</span>
        <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">deallocate</span><span class="hl-operator">(</span><span class="hl-identifier">stringAddress</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>
<span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
</code></pre>
<h3 id="result">Result</h3>
<p>Behold the result:</p>
<pre><code class="language-bash"><span class="hl-operator">$</span> <span class="hl-identifier">node</span> <span class="hl-identifier">pass</span><span class="hl-default">-in-string</span><span class="hl-default">.</span><span class="hl-identifier">js</span> <span class="hl-string">&quot;a string that has lots of the letter &apos;a&apos; in it&quot;</span> 
<span class="hl-number">4</span>
</code></pre>
<p>Looks good!</p>
<h3 id="memory-management-helper">Memory management helper</h3>
<p>Having to manually manage memory in JavaScript is error-prone, so I'm going to wrap this code in a helper:</p>
<pre><code class="language-javascript"><span class="hl-keyword">const</span> <span class="hl-identifier">textEncoder</span> <span class="hl-operator">=</span> <span class="hl-keyword">new</span> <span class="hl-function">TextEncoder</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

<span class="hl-keyword">export</span> <span class="hl-keyword">const</span> <span class="hl-identifier">createCString</span> <span class="hl-operator">=</span> <span class="hl-operator">(</span><span class="hl-identifier">module</span><span class="hl-operator">,</span> <span class="hl-identifier">str</span><span class="hl-operator">,</span> <span class="hl-identifier">run</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">nullTerminatedString</span> <span class="hl-operator">=</span> <span class="hl-identifier">str</span> <span class="hl-operator">+</span> <span class="hl-string">&quot;\0&quot;</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">encodedString</span> <span class="hl-operator">=</span> <span class="hl-identifier">textEncoder</span><span class="hl-operator">.</span><span class="hl-function_method">encode</span><span class="hl-operator">(</span><span class="hl-identifier">nullTerminatedString</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">address</span> <span class="hl-operator">=</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">allocate</span><span class="hl-operator">(</span><span class="hl-identifier">encodedString</span><span class="hl-operator">.</span><span class="hl-identifier">length</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">try</span> <span class="hl-operator">{</span>
        <span class="hl-keyword">const</span> <span class="hl-identifier">destination</span> <span class="hl-operator">=</span> <span class="hl-keyword">new</span> <span class="hl-type">Uint8Array</span><span class="hl-operator">(</span><span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-identifier">memory</span><span class="hl-operator">.</span><span class="hl-identifier">buffer</span><span class="hl-operator">,</span> <span class="hl-identifier">address</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-identifier">destination</span><span class="hl-operator">.</span><span class="hl-keyword">set</span><span class="hl-operator">(</span><span class="hl-identifier">encodedString</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-keyword">return</span> <span class="hl-function">run</span><span class="hl-operator">(</span><span class="hl-identifier">address</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span> <span class="hl-keyword">finally</span> <span class="hl-operator">{</span>
        <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">deallocate</span><span class="hl-operator">(</span><span class="hl-identifier">address</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>
<span class="hl-operator">}</span><span class="hl-operator">;</span>
</code></pre>
<p>Note: it would probably be helpful to extend these helpers to support multiple strings/allocations, but I'm not trying to completely reinvent wrapping/binding libraries like Emscripten right now.</p>
<p>Now, the final string passing code is simple:</p>
<pre><code class="language-javascript"><span class="hl-operator">(</span><span class="hl-keyword">async</span> <span class="hl-operator">(</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">module</span> <span class="hl-operator">=</span> <span class="hl-keyword">await</span> <span class="hl-type">WebAssembly</span><span class="hl-operator">.</span><span class="hl-function_method">instantiate</span><span class="hl-operator">(</span><span class="hl-keyword">await</span> <span class="hl-identifier">fs</span><span class="hl-operator">.</span><span class="hl-identifier">promises</span><span class="hl-operator">.</span><span class="hl-function_method">readFile</span><span class="hl-operator">(</span><span class="hl-string">&quot;./string-example.wasm&quot;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

    <span class="hl-comment">// String used for testing (from command line or hard-coded)</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">testString</span> <span class="hl-operator">=</span> <span class="hl-identifier">process</span><span class="hl-operator">.</span><span class="hl-identifier">argv</span><span class="hl-operator">[</span><span class="hl-number">2</span><span class="hl-operator">]</span> <span class="hl-operator">?</span><span class="hl-operator">?</span> <span class="hl-string">&quot;How many letter a&apos;s are there in this string? Three!&quot;</span><span class="hl-operator">;</span>
    <span class="hl-function">createCString</span><span class="hl-operator">(</span><span class="hl-identifier">module</span><span class="hl-operator">,</span> <span class="hl-identifier">testString</span><span class="hl-operator">,</span> <span class="hl-operator">(</span><span class="hl-identifier">stringAddress</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
        <span class="hl-keyword">const</span> <span class="hl-identifier">result</span> <span class="hl-operator">=</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">count_as</span><span class="hl-operator">(</span><span class="hl-identifier">stringAddress</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-identifier">console</span><span class="hl-operator">.</span><span class="hl-function_method">log</span><span class="hl-operator">(</span><span class="hl-identifier">result</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
</code></pre>
<h1 id="returning-a-string-from-c-to-javascript">Returning a string from C to JavaScript</h1>
<p>Here was my initial thinking for returning a dynamic string from C to JavaScript (recorded before I completed the example above):</p>
<ol>
<li>(Assuming a null-terminated UTF-8 string)</li>
<li>Write the string directly into linear memory</li>
<li>Return the address as an (&quot;unsigned&quot;) integer (&quot;unsigned&quot; in quotes because WebAssembly doesn't have a separate unsigned int type)</li>
<li>JavaScript can decode the string using <code>TextDecoder.decode()</code></li>
<li>(Also make sure to export a function to free generated strings)</li>
</ol>
<p>Given that I'm already exposing allocations to JavaScript, I thought this would work, but there's one problem: <code>TextDecoder.decode()</code> doesn't have built-in support for null-terminated strings (nor should it, in my opinion). Potential solutions:</p>
<ol>
<li>Have JavaScript scan for the null terminator</li>
<li>Return the string and its length, possibly by encoding the length into the top half of a 64-bit return value (note: <a href="https://github.com/WebAssembly/design/blob/main/Portability.md#assumptions-for-efficient-execution">WebAssembly is always little endian</a>)</li>
</ol>
<p>I'm going to opt for the first option.</p>
<p>Note that I'm assuming returned strings will be dynamically allocated, because constant strings should really just be provided directly using JavaScript. If the string <em>must</em> come from C code, all you'd need to do is skip the allocation management steps (and hope that the JavaScript code doesn't decide to mutate the string!).</p>
<h2 id="c-implementation-1">C implementation</h2>
<p>Here's some simple code that creates a string with the letter &quot;b&quot; repeated a caller-supplied number of times:</p>
<pre><code class="language-c"><span class="hl-keyword">const</span> <span class="hl-type">char</span><span class="hl-operator">*</span> <span class="hl-function">WASM_EXPORT</span><span class="hl-operator">(</span><span class="hl-identifier">write_bs</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-type">unsigned</span> <span class="hl-type">int</span> <span class="hl-identifier">count</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-comment">// Allocate space for the string, plus a null terminator</span>
    <span class="hl-type">char</span><span class="hl-operator">*</span> <span class="hl-identifier">str</span> <span class="hl-operator">=</span> <span class="hl-operator">(</span><span class="hl-type">char</span><span class="hl-operator">*</span><span class="hl-operator">)</span><span class="hl-function_builtin">malloc</span><span class="hl-operator">(</span><span class="hl-identifier">count</span> <span class="hl-operator">+</span> <span class="hl-number">1</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

    <span class="hl-comment">// Fill in the string and null terminator</span>
    <span class="hl-type">char</span><span class="hl-operator">*</span> <span class="hl-identifier">c</span> <span class="hl-operator">=</span> <span class="hl-identifier">str</span><span class="hl-operator">;</span>
    <span class="hl-keyword">for</span> <span class="hl-operator">(</span><span class="hl-type">unsigned</span> <span class="hl-type">int</span> <span class="hl-identifier">i</span> <span class="hl-operator">=</span> <span class="hl-number">0</span><span class="hl-operator">;</span> <span class="hl-identifier">i</span> <span class="hl-operator">&lt;</span> <span class="hl-identifier">count</span><span class="hl-operator">;</span> <span class="hl-identifier">i</span><span class="hl-operator">+</span><span class="hl-operator">+</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
        <span class="hl-operator">*</span><span class="hl-identifier">c</span> <span class="hl-operator">=</span> <span class="hl-string">&apos;b&apos;</span><span class="hl-operator">;</span>
        <span class="hl-operator">+</span><span class="hl-operator">+</span><span class="hl-identifier">c</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>
    <span class="hl-operator">*</span><span class="hl-identifier">c</span> <span class="hl-operator">=</span> <span class="hl-string">&apos;\0&apos;</span><span class="hl-operator">;</span>

    <span class="hl-keyword">return</span> <span class="hl-identifier">str</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span>
</code></pre>
<h2 id="javascript-implementation">JavaScript implementation</h2>
<p>Here's the corresponding JavaScript on the other side:</p>
<pre><code class="language-javascript"><span class="hl-keyword">import</span> <span class="hl-identifier">fs</span> <span class="hl-identifier">from</span> <span class="hl-string">&quot;fs&quot;</span><span class="hl-operator">;</span>

<span class="hl-operator">(</span><span class="hl-keyword">async</span> <span class="hl-operator">(</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">module</span> <span class="hl-operator">=</span> <span class="hl-keyword">await</span> <span class="hl-type">WebAssembly</span><span class="hl-operator">.</span><span class="hl-function_method">instantiate</span><span class="hl-operator">(</span><span class="hl-keyword">await</span> <span class="hl-identifier">fs</span><span class="hl-operator">.</span><span class="hl-identifier">promises</span><span class="hl-operator">.</span><span class="hl-function_method">readFile</span><span class="hl-operator">(</span><span class="hl-string">&quot;./string-example.wasm&quot;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

    <span class="hl-comment">// String used for testing (from command line or hard-coded)</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">count</span> <span class="hl-operator">=</span> <span class="hl-function_builtin">parseInt</span><span class="hl-operator">(</span><span class="hl-identifier">process</span><span class="hl-operator">.</span><span class="hl-identifier">argv</span><span class="hl-operator">[</span><span class="hl-number">2</span><span class="hl-operator">]</span> <span class="hl-operator">?</span><span class="hl-operator">?</span> <span class="hl-string">&quot;3&quot;</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">address</span> <span class="hl-operator">=</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">write_bs</span><span class="hl-operator">(</span><span class="hl-identifier">count</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">try</span> <span class="hl-operator">{</span>
        <span class="hl-keyword">const</span> <span class="hl-identifier">buffer</span> <span class="hl-operator">=</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-identifier">memory</span><span class="hl-operator">.</span><span class="hl-identifier">buffer</span><span class="hl-operator">;</span>
        <span class="hl-keyword">const</span> <span class="hl-identifier">encodedStringLength</span> <span class="hl-operator">=</span> <span class="hl-operator">(</span><span class="hl-keyword">new</span> <span class="hl-type">Uint8Array</span><span class="hl-operator">(</span><span class="hl-identifier">buffer</span><span class="hl-operator">,</span> <span class="hl-identifier">address</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">.</span><span class="hl-function_method">indexOf</span><span class="hl-operator">(</span><span class="hl-number">0</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-keyword">const</span> <span class="hl-identifier">encodedStringBuffer</span> <span class="hl-operator">=</span> <span class="hl-keyword">new</span> <span class="hl-type">Uint8Array</span><span class="hl-operator">(</span><span class="hl-identifier">buffer</span><span class="hl-operator">,</span> <span class="hl-identifier">address</span><span class="hl-operator">,</span> <span class="hl-identifier">encodedStringLength</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-keyword">const</span> <span class="hl-identifier">result</span> <span class="hl-operator">=</span> <span class="hl-operator">(</span><span class="hl-keyword">new</span> <span class="hl-function">TextDecoder</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">.</span><span class="hl-function_method">decode</span><span class="hl-operator">(</span><span class="hl-identifier">encodedStringBuffer</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-identifier">console</span><span class="hl-operator">.</span><span class="hl-function_method">log</span><span class="hl-operator">(</span><span class="hl-identifier">result</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span> <span class="hl-keyword">finally</span> <span class="hl-operator">{</span>
        <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">deallocate</span><span class="hl-operator">(</span><span class="hl-identifier">address</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>
<span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
</code></pre>
<p>Output:</p>
<pre><code class="language-bash"><span class="hl-operator">$</span> <span class="hl-identifier">node</span> <span class="hl-function_builtin">return</span><span class="hl-default">-string</span><span class="hl-default">.</span><span class="hl-identifier">js</span> <span class="hl-number">5</span>
<span class="hl-identifier">bbbbb</span>
</code></pre>
<p>Looks good!</p>
<h2 id="helpers">Helpers</h2>
<p>Similar to above, I'm going to refactor this logic into helpers (one for static strings, and one for new strings return via the heap):</p>
<pre><code class="language-javascript"><span class="hl-keyword">const</span> <span class="hl-identifier">textDecoder</span> <span class="hl-operator">=</span> <span class="hl-keyword">new</span> <span class="hl-function">TextDecoder</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

<span class="hl-keyword">export</span> <span class="hl-keyword">const</span> <span class="hl-identifier">readStaticCString</span> <span class="hl-operator">=</span> <span class="hl-operator">(</span><span class="hl-identifier">module</span><span class="hl-operator">,</span> <span class="hl-identifier">address</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">buffer</span> <span class="hl-operator">=</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-identifier">memory</span><span class="hl-operator">.</span><span class="hl-identifier">buffer</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">encodedStringLength</span> <span class="hl-operator">=</span> <span class="hl-operator">(</span><span class="hl-keyword">new</span> <span class="hl-type">Uint8Array</span><span class="hl-operator">(</span><span class="hl-identifier">buffer</span><span class="hl-operator">,</span> <span class="hl-identifier">address</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">.</span><span class="hl-function_method">indexOf</span><span class="hl-operator">(</span><span class="hl-number">0</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">encodedStringBuffer</span> <span class="hl-operator">=</span> <span class="hl-keyword">new</span> <span class="hl-type">Uint8Array</span><span class="hl-operator">(</span><span class="hl-identifier">buffer</span><span class="hl-operator">,</span> <span class="hl-identifier">address</span><span class="hl-operator">,</span> <span class="hl-identifier">encodedStringLength</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">return</span> <span class="hl-identifier">textDecoder</span><span class="hl-operator">.</span><span class="hl-function_method">decode</span><span class="hl-operator">(</span><span class="hl-identifier">encodedStringBuffer</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span><span class="hl-operator">;</span>

<span class="hl-keyword">export</span> <span class="hl-keyword">const</span> <span class="hl-identifier">receiveCString</span> <span class="hl-operator">=</span> <span class="hl-operator">(</span><span class="hl-identifier">module</span><span class="hl-operator">,</span> <span class="hl-identifier">create</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">address</span> <span class="hl-operator">=</span> <span class="hl-function">create</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">try</span> <span class="hl-operator">{</span>
        <span class="hl-keyword">return</span> <span class="hl-function">readStaticCString</span><span class="hl-operator">(</span><span class="hl-identifier">module</span><span class="hl-operator">,</span> <span class="hl-identifier">address</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span> <span class="hl-keyword">finally</span> <span class="hl-operator">{</span>
        <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">deallocate</span><span class="hl-operator">(</span><span class="hl-identifier">address</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-operator">}</span>
<span class="hl-operator">}</span><span class="hl-operator">;</span>
</code></pre>
<p>This simplifies the calling code significantly:</p>
<pre><code class="language-javascript"><span class="hl-operator">(</span><span class="hl-keyword">async</span> <span class="hl-operator">(</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">module</span> <span class="hl-operator">=</span> <span class="hl-keyword">await</span> <span class="hl-type">WebAssembly</span><span class="hl-operator">.</span><span class="hl-function_method">instantiate</span><span class="hl-operator">(</span><span class="hl-keyword">await</span> <span class="hl-identifier">fs</span><span class="hl-operator">.</span><span class="hl-identifier">promises</span><span class="hl-operator">.</span><span class="hl-function_method">readFile</span><span class="hl-operator">(</span><span class="hl-string">&quot;./string-example.wasm&quot;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">;</span>

    <span class="hl-comment">// String used for testing (from command line or hard-coded)</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">count</span> <span class="hl-operator">=</span> <span class="hl-function_builtin">parseInt</span><span class="hl-operator">(</span><span class="hl-identifier">process</span><span class="hl-operator">.</span><span class="hl-identifier">argv</span><span class="hl-operator">[</span><span class="hl-number">2</span><span class="hl-operator">]</span> <span class="hl-operator">?</span><span class="hl-operator">?</span> <span class="hl-string">&quot;3&quot;</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">str</span> <span class="hl-operator">=</span> <span class="hl-function">receiveCString</span><span class="hl-operator">(</span><span class="hl-identifier">module</span><span class="hl-operator">,</span> <span class="hl-operator">(</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-function_method">write_bs</span><span class="hl-operator">(</span><span class="hl-identifier">count</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-identifier">console</span><span class="hl-operator">.</span><span class="hl-function_method">log</span><span class="hl-operator">(</span><span class="hl-identifier">str</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
</code></pre>
<h1 id="strings-">Strings: ✔</h1>
<p>Perhaps that wasn't the most enjoyable experiment, but it does give one a new appreciation for binding generators that do all this work for you.</p>
<p>Armed with a way to pass strings between JavaScript and C, I'm now ready to leverage old C code (that I don't want to rewrite) by recompiling for WebAssembly and adding appropriate JavaScript glue. Theoretically the final WebAssembly module artifact will be useful for a long time (&quot;compile once, run forever&quot;?). I have one project in mind, but I'm not going to discuss it or commit to anything just yet.</p>
<p>Have fun manually managing memory with JavaScript!</p>
<h1 id="links">Links:</h1>
<ul>
<li><a href="https://github.com/jaredkrinke/wasm-c-string">Library for the string handling helpers</a> (with tests)</li>
<li><a href="https://github.com/jaredkrinke/webassembly-c-string-example">Repository with the test code</a></li>
<li><a href="https://jaredkrinke.github.io/webassembly-c-string-example/">Live demo</a></li>
</ul>

<footer>
<p>&crarr; <a href="../../index.html">Back to home</a></p>
</footer>
</article>
</main>

</body>
</html>
