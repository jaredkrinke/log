<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Porting a browser-based game to Steam, on Linux (part 2)</title>
<meta name="description" content="I finally ported my browser-based Steam game to Linux. It was mostly straight-forward." />
<meta name="keywords" content="steam,linux,sic1" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link rel="stylesheet" href="../../css/style.css" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Porting a browser-based game to Steam, on Linux (part 2)",
  "abstract": "I finally ported my browser-based Steam game to Linux. It was mostly straight-forward.",
  "keywords": "game-development,steam,linux,sic1",
  "datePublished": "2023-08-26"
}
</script>
</head>
<body>
<header>
<h1><a href="../../index.html">Schemescape</a></h1>
<p>Development log of a life-long coder</p>

<nav>
<strong>Topics:&nbsp;</strong>
<ul>
<li><a href="../../posts/game-development/index.html">game-development</a></li>
<li><a href="../../posts/steam/index.html">steam</a></li>
<li><a href="../../posts/linux/index.html">linux</a></li>
<li><a href="../../posts/sic1/index.html">sic1</a></li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h1><a href="../../posts/game-development/web-game-on-steam-for-linux-2.html">Porting a browser-based game to Steam, on Linux (part 2)</a></h1>
<p><time datetime="2023-08-26">August 26, 2023</time></p>
</header>
<p>In <a href="web-game-on-steam-for-linux.html">a previous post</a> I outlined a plan to (finally) port <a href="../game-development/sic-1.html">my browser-based Steam game</a> to Linux. (The original Windows-only release used WebView2.) The port mostly went according to plan and only took a week or two, working in my spare time.</p>
<h1 id="original-plan">Original plan</h1>
<p>The simplest way to run a browser-based game using Steam on Linux was to use Electron, but there was one problem: <a href="https://github.com/greenheartgames/greenworks">Greenworks</a> (a Steam integration library) didn&#39;t support friend leaderboards (an important feature of my game). My plan (which optimized for having to learn the fewest new libraries/concepts) was to:</p>
<ol>
<li>Port the Steam release to Electron</li>
<li>Refactor Steam integration code into a flat C interface</li>
<li>Consume the Steam integration code using one of Node&#39;s FFI libraries</li>
<li><em>Hope</em> that this new version works acceptably via Proton</li>
</ol>
<h1 id="porting-to-electron">Porting to Electron</h1>
<p>Porting to Electron was fairly straightforward. I was able to use Electron&#39;s tutorials to get a mostly working game pretty quickly. There were a few issues I had to iron out:</p>
<ul>
<li>Electron Forge doesn&#39;t have an easy way to add binaries (e.g. the Steamworks binary) to the root of the output folder, so I had to <a href="https://github.com/jaredkrinke/sic1/commit/c953e7adb63a43022102dbf434123c400ac507a2#diff-4c2d32d0a0906dd3108b9ce9d29178bc2e8e3eae8d82f0b735a73e1f2b23ee5e">hack in an <code>afterExtract</code> callback to copy the files</a> and switch from using <code>electron-forge start</code> (which <em>doesn&#39;t</em> run <code>afterExtract</code>) to <code>electron-forge package</code> (which does) for testing</li>
<li>Electron allows &quot;Ctrl+R&quot; to reload the page by default (fix: <a href="https://github.com/jaredkrinke/sic1/commit/0459f8c1bd7efd55095936fd1d5350bd27b6eab8">remove the menu</a>)</li>
</ul>
<p>Fortunately, <a href="https://github.com/jaredkrinke/sic1/commit/ef4d99f517f227ba7755bb67cb7abf962d18be0b">adding crash reporting</a> was trivially easy.</p>
<h1 id="refactoring-steam-integration-for-electron-andor-linux">Refactoring Steam integration for Electron and/or Linux</h1>
<p>My original Steam integration code used the Win32 API, so I had to rewrite it using only the C++11 standard library. I then exposed that code in a flat, synchronous C interface (which I dubbed <a href="https://github.com/jaredkrinke/ez-steam-api">ez-steam-api</a>).</p>
<p>To support calling the C API from Electron, I used <a href="https://koffi.dev/">Koffi</a> (which was great, other than one bug I hit--which has since been fixed). The wrapper is documented <a href="https://github.com/jaredkrinke/ez-steam-api/tree/main/js">here</a>.</p>
<h1 id="hoping-that-electron-runs-on-proton"><em>Hoping</em> that Electron runs on Proton</h1>
<p>In the previous post, I acknowledged that <em>hoping</em> Electron ran acceptably on Proton was a risk. It turns out this risk was well founded.</p>
<p>In addition to <a href="https://github.com/jaredkrinke/sic1/issues/270#issuecomment-1636918488">wasting a lot of time testing out different Electron and Proton combinations</a>, I ran into one insurmountable bug that was only <em>just annoying enough</em> to make me give up: the mouse cursor is off by about 25 pixels on Ubuntu, when windowed (no idea why or how to investigate it, although I wonder if it&#39;s related to the system bar at the top of the screen). In fullscreen, Electron-on-Proton worked great! But having windowed mode be broken was unacceptable for my programming game (for other genres, this bug might be acceptable).</p>
<p>So I ended up having to do a native Linux port anyway.</p>
<h1 id="native-linux-port-on-steam">Native Linux port on Steam</h1>
<p>Building an Electron app for Linux is trivial. Getting it to run on Steam was a bit frustrating, however, because the game would fail to launch. But <em>only</em> when run from Steam! Even <a href="https://gitlab.steamos.cloud/steamrt/scout/sdk/-/blob/steamrt/scout/README.md#testing-software-that-runs-in-scout">Steam&#39;s test script</a> launched the game fine.</p>
<p>I don&#39;t recall how I discovered the solution, but the issue was related to Electron&#39;s sandboxing. Given my game only loads its own code (and not anything from the web), the workaround was just to <a href="https://steamcommunity.com/groups/steamworks/discussions/13/3801651941320989565/#c3801651941326097085">add <code>--no-sandbox</code> to the list of command line arguments</a>.</p>
<p>And just like that, I had a working Linux port!</p>
<h1 id="summary-and-statistics">Summary and statistics</h1>
<p>I&#39;ve said it before, but I&#39;ll say it again: I should have just used Electron from the beginning. It&#39;s inefficient, but it&#39;s known to work fine on Steam, across platforms (cf. Vampire Survivors). If I had just used Electron originally, porting to Linux would have been trivial. Fortunately, porting to Electron and then Linux wasn&#39;t too onerous.</p>
<p>This Linux port also resolved <a href="sic-1-retrospective.html#should-i-port-the-steam-version-of-the-game-to-linux">one of my open questions</a> around what to do with SIC-1. And, of course, now people on a free OS can play my game, <em>with friend leaderboards</em>. I think the peak number of concurrent Linux players was roughly 3, which is pretty high for a game that only ever peaked at 10 concurrent players on Windows.</p>
<h1 id="up-next">Up next...</h1>
<p>That&#39;s all for the Linux port! Next, I&#39;m planning to provide an update on how SIC-1&#39;s release has been going. Spoiler: it finally met my own internal bar for success!</p>

<footer>
<p>&crarr; <a href="../../index.html">Back to home</a></p>
</footer>
</article>
</main>

</body>
</html>
