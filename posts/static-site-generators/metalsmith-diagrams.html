<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Generating SVG diagrams automatically with Metalsmith</title>
<meta name="description" content="Metalsmith is used to build this static site. Here&#039;s how Graphviz was integrated to automatically generate diagrams." />
<meta name="keywords" content="metalsmith,diagrams" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link rel="stylesheet" href="../../css/style.css" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Generating SVG diagrams automatically with Metalsmith",
  "abstract": "Metalsmith is used to build this static site. Here's how Graphviz was integrated to automatically generate diagrams.",
  "keywords": "static-site-generators,metalsmith,diagrams",
  "datePublished": "2021-10-10"
}
</script>
</head>
<body>
<header>
<h1><a href="../../index.html">Schemescape</a></h1>
<p>Development log of a life-long coder</p>

<nav>
<strong>Topics:&nbsp;</strong>
<ul>
<li><a href="../../posts/static-site-generators/index.html">static-site-generators</a></li>
<li><a href="../../posts/metalsmith/index.html">metalsmith</a></li>
<li><a href="../../posts/diagrams/index.html">diagrams</a></li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h1><a href="../../posts/static-site-generators/metalsmith-diagrams.html">Generating SVG diagrams automatically with Metalsmith</a></h1>
<p><time datetime="2021-10-10">October 10, 2021</time></p>
</header>
<p>Now that I've <a href="../webassembly/compiling-graphviz-to-webassembly.html">compiled Graphviz to a WebAssembly module</a>, I'm going to use it to automatically generate SVG diagrams when I build my static site using Metalsmith.</p>
<h1 id="the-plan">The plan</h1>
<p>Here's a flow chart of my general plan:</p>
<div>
<svg width="312pt" height="260pt"
 viewBox="0.00 0.00 311.67 260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<polygon class="diagram-transparent-white" points="-4,4 -4,-256 307.67,-256 307.67,4 -4,4"/>
<g id="node1" class="node">
<title>Compile Graphviz to WebAssembly</title>
<ellipse class="diagram-black-none" cx="151.84" cy="-234" rx="151.67" ry="18"/>
<text text-anchor="middle" x="151.84" y="-229.8" font-size="14.00">Compile Graphviz to WebAssembly</text>
</g>
<g id="node2" class="node">
<title>Generate diagrams at build time</title>
<ellipse class="diagram-black-none" cx="151.84" cy="-162" rx="134.85" ry="18"/>
<text text-anchor="middle" x="151.84" y="-157.8" font-size="14.00">Generate diagrams at build time</text>
</g>
<g id="edge1" class="edge">
<title>Compile Graphviz to WebAssembly&#45;&gt;Generate diagrams at build time</title>
<path class="diagram-black-none" d="M151.84,-215.7C151.84,-207.98 151.84,-198.71 151.84,-190.11"/>
<polygon class="diagram-black-black" points="155.34,-190.1 151.84,-180.1 148.34,-190.1 155.34,-190.1"/>
</g>
<g id="node3" class="node">
<title>???</title>
<ellipse class="diagram-black-none" cx="151.84" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="151.84" y="-85.8" font-size="14.00">???</text>
</g>
<g id="edge2" class="edge">
<title>Generate diagrams at build time&#45;&gt;???</title>
<path class="diagram-black-none" d="M151.84,-143.7C151.84,-135.98 151.84,-126.71 151.84,-118.11"/>
<polygon class="diagram-black-black" points="155.34,-118.1 151.84,-108.1 148.34,-118.1 155.34,-118.1"/>
</g>
<g id="node4" class="node">
<title>Profit!</title>
<ellipse class="diagram-black-none" cx="151.84" cy="-18" rx="36.49" ry="18"/>
<text text-anchor="middle" x="151.84" y="-13.8" font-size="14.00">Profit!</text>
</g>
<g id="edge3" class="edge">
<title>???&#45;&gt;Profit!</title>
<path class="diagram-black-none" d="M151.84,-71.7C151.84,-63.98 151.84,-54.71 151.84,-46.11"/>
<polygon class="diagram-black-black" points="155.34,-46.1 151.84,-36.1 148.34,-46.1 155.34,-46.1"/>
</g>
</g>
</svg>
</div>
<p>That diagram was generated using the following Markdown:</p>
<pre><code class="language-markdown"><span class="hl-code">```dot2svg
digraph {
    &quot;Compile Graphviz to WebAssembly&quot; -&gt; &quot;Generate diagrams at build time&quot; -&gt; &quot;???&quot; -&gt; &quot;Profit!&quot;;
}
```
</span></code></pre>
<h1 id="extending-the-marked-renderer">Extending the Marked renderer</h1>
<p>As shown in the example near the top of this post, my plan is to piggyback on Markdown code blocks, using a special language tag <code>dot2svg</code>. For all other code blocks (and on error), I simply defer to the default code block rendering function:</p>
<pre><code class="language-javascript"><span class="hl-comment">// Generate diagrams with dot2svg</span>
<span class="hl-keyword">const</span> <span class="hl-identifier">baseCodeRenderer</span> <span class="hl-operator">=</span> <span class="hl-identifier">markdownRenderer</span><span class="hl-operator">.</span><span class="hl-identifier">code</span><span class="hl-operator">;</span>
<span class="hl-keyword">const</span> <span class="hl-identifier">dotConverter</span> <span class="hl-operator">=</span> <span class="hl-keyword">await</span> <span class="hl-function">createDOTToSVGAsync</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-identifier">markdownRenderer</span><span class="hl-operator">.</span><span class="hl-identifier">code</span> <span class="hl-operator">=</span> <span class="hl-keyword">function</span> <span class="hl-operator">(</span><span class="hl-identifier">code</span><span class="hl-operator">,</span> <span class="hl-identifier">language</span><span class="hl-operator">,</span> <span class="hl-identifier">escaped</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">if</span> <span class="hl-operator">(</span><span class="hl-identifier">language</span> <span class="hl-operator">=</span><span class="hl-operator">=</span><span class="hl-operator">=</span> <span class="hl-string">&quot;dot2svg&quot;</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
        <span class="hl-keyword">const</span> <span class="hl-identifier">svg</span> <span class="hl-operator">=</span> <span class="hl-identifier">dotConverter</span><span class="hl-operator">.</span><span class="hl-function_method">dotToSVG</span><span class="hl-operator">(</span><span class="hl-identifier">code</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-keyword">if</span> <span class="hl-operator">(</span><span class="hl-identifier">svg</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
            <span class="hl-keyword">return</span> <span class="hl-identifier">svg</span><span class="hl-operator">;</span>
        <span class="hl-operator">}</span> <span class="hl-keyword">else</span> <span class="hl-operator">{</span>
            <span class="hl-comment">// On error, just treat the code block like normal</span>
            <span class="hl-identifier">language</span> <span class="hl-operator">=</span> <span class="hl-string">&quot;&quot;</span><span class="hl-operator">;</span>
        <span class="hl-operator">}</span>
    <span class="hl-operator">}</span>
    <span class="hl-keyword">return</span> <span class="hl-identifier">baseCodeRenderer</span><span class="hl-operator">.</span><span class="hl-function_method">call</span><span class="hl-operator">(</span><span class="hl-keyword">this</span><span class="hl-operator">,</span> <span class="hl-identifier">code</span><span class="hl-operator">,</span> <span class="hl-identifier">language</span><span class="hl-operator">,</span> <span class="hl-identifier">escaped</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span><span class="hl-operator">;</span>
</code></pre>
<h1 id="styling">Styling</h1>
<p>The above rendering code worked (and didn't break my <a href="metalsmith-syntax-highlighting.html">syntax highlighting</a>), but there were a few tweaks I had in mind:</p>
<ul>
<li>Remove the <a href="https://www.w3.org/TR/xml/#sec-prolog-dtd">XML prolog and document type declaration</a><ul>
<li>Since I'm inlining my SVG in HTML, this information is redundant</li>
</ul>
</li>
<li>Replace Graphviz's default styling (annoyingly hard-coded via <code>fill</code> and <code>stroke</code> attributes on each element) with CSS classes<ul>
<li>This allows me to style the graphs using my CSS stylesheet</li>
<li>In my case, I'm replacing the <code>fill=&quot;white&quot; stroke=&quot;black&quot;</code> attributes with a single CSS class: <code>class=&quot;diagram-black-white&quot;</code></li>
</ul>
</li>
</ul>
<p>Fortunately, both of these transformations can be done with regular expression replacements:</p>
<pre><code class="language-javascript"><span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-keyword">if</span> <span class="hl-operator">(</span><span class="hl-identifier">svg</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-comment">// Remove XML prolog, since we&apos;re inlining</span>
    <span class="hl-comment">// Also convert default styles to CSS classes, for custom styling</span>
    <span class="hl-keyword">return</span> <span class="hl-identifier">svg</span>
        <span class="hl-operator">.</span><span class="hl-function_method">replace</span><span class="hl-operator">(</span><span class="hl-regex">/^.*?&lt;svg /</span><span class="hl-identifier">s</span><span class="hl-operator">,</span> <span class="hl-string">&quot;&lt;svg &quot;</span><span class="hl-operator">)</span>
        <span class="hl-operator">.</span><span class="hl-function_method">replace</span><span class="hl-operator">(</span><span class="hl-regex">/fill=&quot;([^&quot;]+)&quot; stroke=&quot;([^&quot;]+)&quot;/g</span><span class="hl-operator">,</span> <span class="hl-string">&quot;class=\&quot;diagram-$2-$1\&quot;&quot;</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span> <span class="hl-keyword">else</span> <span class="hl-operator">{</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
</code></pre>
<p>Now, I can just style everything with CSS:</p>
<pre><code class="language-css"><span class="hl-comment">/* Diagrams */</span>
<span class="hl-identifier">svg</span> <span class="hl-identifier">text</span> <span class="hl-operator">{</span> <span class="hl-identifier">fill</span><span class="hl-operator">:</span> <span class="hl-number">#eee</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>
<span class="hl-operator">.</span><span class="hl-identifier">diagram-transparent-white</span> <span class="hl-operator">{</span> <span class="hl-identifier">stroke</span><span class="hl-operator">:</span> <span class="hl-constant_builtin">none</span><span class="hl-operator">;</span> <span class="hl-identifier">fill</span><span class="hl-operator">:</span> <span class="hl-constant_builtin">none</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>
<span class="hl-function_builtin">ellipse</span><span class="hl-operator">.</span><span class="hl-identifier">diagram-black-none</span> <span class="hl-operator">{</span> <span class="hl-identifier">stroke</span><span class="hl-operator">:</span> <span class="hl-number">#ccc</span><span class="hl-operator">;</span> <span class="hl-identifier">fill</span><span class="hl-operator">:</span> <span class="hl-number">#444</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>
<span class="hl-operator">.</span><span class="hl-identifier">diagram-black-none</span> <span class="hl-operator">{</span> <span class="hl-identifier">stroke</span><span class="hl-operator">:</span> <span class="hl-number">#999</span><span class="hl-operator">;</span> <span class="hl-identifier">fill</span><span class="hl-operator">:</span><span class="hl-constant_builtin">none</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>
<span class="hl-operator">.</span><span class="hl-identifier">diagram-black-black</span> <span class="hl-operator">{</span> <span class="hl-identifier">stroke</span><span class="hl-operator">:</span> <span class="hl-number">#999</span><span class="hl-operator">;</span> <span class="hl-identifier">fill</span><span class="hl-operator">:</span> <span class="hl-number">#333</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>
</code></pre>
<h1 id="thats-it">That's it!</h1>
<p>To my surprise, this entire integration went smoothly, and only took an hour or so. It remains to be seen how useful these diagrams will be, but at least now if I ever feel the need to insert a superfluous diagram, the functionality will be there.</p>
<p>For reference, all of the code used to generate this site (along with the content) is in <a href="https://github.com/jaredkrinke/md2blog">this repository</a>.</p>
<p><strong>Update</strong>: I've removed this feature from my static site generator for the time being because it's unclear what license covers Graphviz (the web site and source code are not in sync).</p>

<footer>
<p>&crarr; <a href="../../index.html">Back to home</a></p>
</footer>
</article>
</main>

</body>
</html>
