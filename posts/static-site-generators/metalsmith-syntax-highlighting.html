<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Syntax highlighting for a static site built with Metalsmith</title>
<meta name="description" content="I&#039;m using Metalsmith to build my static site. Here&#039;s how I integrated syntax highlighting using highlight.js." />
<meta name="keywords" content="metalsmith" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link rel="stylesheet" href="../../css/style.css" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Syntax highlighting for a static site built with Metalsmith",
  "abstract": "I'm using Metalsmith to build my static site. Here's how I integrated syntax highlighting using highlight.js.",
  "keywords": "static-site-generators,metalsmith",
  "datePublished": "2021-10-01"
}
</script>
</head>
<body>
<header>
<h1><a href="../../index.html">Schemescape</a></h1>
<p>Development log of a life-long coder</p>

<nav>
<strong>Topics:&nbsp;</strong>
<ul>
<li><a href="../../posts/static-site-generators/index.html">static-site-generators</a></li>
<li><a href="../../posts/metalsmith/index.html">metalsmith</a></li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h1><a href="../../posts/static-site-generators/metalsmith-syntax-highlighting.html">Syntax highlighting for a static site built with Metalsmith</a></h1>
<p><time datetime="2021-10-01">October 1, 2021</time></p>
</header>
<p>As <a href="metalsmith.html">described previously</a>, I'm using <a href="https://metalsmith.io/">Metalsmith</a> to build my static site because I like its modular, easy to extend design (even though it required more effort to setup initially).</p>
<p>Here's how I integrated <a href="https://highlightjs.org/">highlight.js</a> syntax highlighting into my static builds.</p>
<h1 id="marked">Marked</h1>
<p>Metalsmith's official Markdown plug, <a href="https://github.com/segmentio/metalsmith-markdown">metalsmith-markdown</a> uses <a href="https://marked.js.org/">Marked</a> for converting Markdown into HTML. Note that the plugin uses a fairly old version of Marked: 0.7.0. Fortunately, Marked has <a href="https://marked.js.org/using_advanced#highlight">convenient support for integrating syntax highlighting</a>.</p>
<h1 id="highlightjs">highlight.js</h1>
<p>Since I'm working within the Node/NPM ecosystem, I decided to try <a href="https://highlightjs.org/">highlight.js</a>, because it's conveniently implemented in JavaScript (no manual compilation required). I suspect a native highlighting library would be faster, but I'd rather optimize later, if needed, than waste time upfront.</p>
<h1 id="build-script-integration">Build script integration</h1>
<p>First step (after installing highlight.js via NPM: <code>npm install --save highlight.js</code>) is to use the documentation above to integrate highlight.js into my build script. This turned out to be fairly easy:</p>
<pre><code class="language-javascript"><span class="hl-keyword">import</span> <span class="hl-identifier">highlight</span> <span class="hl-identifier">from</span> <span class="hl-string">&quot;highlight.js&quot;</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-comment">// Configure syntax highlighting aliases</span>
<span class="hl-identifier">highlight</span><span class="hl-operator">.</span><span class="hl-function">registerAliases</span><span class="hl-operator">(</span><span class="hl-string">&quot;wasm&quot;</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">languageName</span><span class="hl-operator">:</span> <span class="hl-string">&quot;lisp&quot;</span> <span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
<span class="hl-function">Metalsmith</span><span class="hl-operator">(</span><span class="hl-identifier">__dirname</span><span class="hl-operator">)</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
    <span class="hl-operator">.</span><span class="hl-function">use</span><span class="hl-operator">(</span><span class="hl-function">markdown</span><span class="hl-operator">(</span><span class="hl-operator">{</span>
        <span class="hl-identifier">highlight</span><span class="hl-operator">:</span> <span class="hl-operator">(</span><span class="hl-identifier">code</span><span class="hl-operator">,</span> <span class="hl-identifier">language</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
            <span class="hl-keyword">if</span> <span class="hl-operator">(</span><span class="hl-identifier">language</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
                <span class="hl-keyword">return</span> <span class="hl-identifier">highlight</span><span class="hl-operator">.</span><span class="hl-function">highlight</span><span class="hl-operator">(</span><span class="hl-identifier">code</span><span class="hl-operator">,</span> <span class="hl-operator">{</span> <span class="hl-identifier">language</span> <span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">.</span><span class="hl-identifier">value</span><span class="hl-operator">;</span>
            <span class="hl-operator">}</span> <span class="hl-keyword">else</span> <span class="hl-operator">{</span>
                <span class="hl-keyword">return</span> <span class="hl-identifier">highlight</span><span class="hl-operator">.</span><span class="hl-function">highlightAuto</span><span class="hl-operator">(</span><span class="hl-identifier">code</span><span class="hl-operator">)</span><span class="hl-operator">.</span><span class="hl-identifier">value</span><span class="hl-operator">;</span>
            <span class="hl-operator">}</span>
        <span class="hl-operator">}</span><span class="hl-operator">,</span>
    <span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">)</span>
<span class="hl-operator">.</span><span class="hl-operator">.</span><span class="hl-operator">.</span>
</code></pre>
<p>Notes:</p>
<ul>
<li>I'm using <code>import</code> instead of <code>require</code> to experiment with ES modules (<a href="../web-development/using-commonjs-modules-from-es-modules.html">Node supports loading CommonJS modules with <code>import</code></a>)</li>
<li>highlight.js <a href="https://highlightjs.org/static/demo/">supports a lot of languages</a>, but not WebAssembly, so I set up an alias that let's me mark code blocks as &quot;wasm&quot; and they'll be highlighted using Lisp s-expression syntax</li>
<li>highlight.js can auto-detect languages, so I use <code>highlightAuto</code> in cases where no programming language is explicitly specified</li>
</ul>
<p>So far, so good.</p>
<h1 id="theming">Theming</h1>
<p>Now, on to the annoying part: theming!</p>
<p>I kind of expected this, but <a href="https://highlightjs.readthedocs.io/en/latest/theme-guide.html#">creating a theme</a> (mostly from scratch) for highlight.js is fairly tedious. The <a href="https://highlightjs.readthedocs.io/en/latest/css-classes-reference.html">list of &quot;scopes&quot;</a> (i.e. classes of tokens) is long, and some are even nested. For example, the name of a function gets the following CSS classes applied: &quot;hljs-title function_&quot;.</p>
<p>To tweak a theme, the best approach I can recommend here is:</p>
<ol>
<li>Run highlight.js on some code</li>
<li>Inspect the output HTML (specifically the CSS classes)</li>
<li>Add/update your CSS rules</li>
<li>Repeat</li>
</ol>
<p>I had hoped that I could just take an existing theme and modify it slightly, but I couldn't find a theme that didn't group scopes in unappealing ways (e.g. grouping macros/templates with literals).</p>
<h1 id="my-final-css">My &quot;final&quot; CSS</h1>
<p>After a lot of trial and error, below is the CSS I came up with, using colors that are mostly already present on my site. I grouped the rules by color.</p>
<p>I'm sure this theme doesn't cover all languages well, so I'll likely need to tweak it a few times in the future, but it seems adequate for all the code I've thrown at it thus far.</p>
<pre><code class="language-css"><span class="hl-comment">/* Syntax highlighting */</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-comment</span> <span class="hl-operator">{</span> <span class="hl-property">color</span><span class="hl-operator">:</span> <span class="hl-number">#5a8c3f</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>

<span class="hl-operator">.</span><span class="hl-identifier">hljs-tag</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-punctuation</span> <span class="hl-operator">{</span> <span class="hl-property">color</span><span class="hl-operator">:</span> <span class="hl-number">#ccc</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>

<span class="hl-operator">.</span><span class="hl-identifier">hljs-literal</span> <span class="hl-operator">{</span> <span class="hl-property">color</span><span class="hl-operator">:</span> <span class="hl-number">#66c9fe</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>

<span class="hl-operator">.</span><span class="hl-identifier">hljs-title</span><span class="hl-operator">.</span><span class="hl-identifier">class_</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-tag</span> <span class="hl-operator">.</span><span class="hl-identifier">hljs-name</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-tag</span> <span class="hl-operator">.</span><span class="hl-identifier">hljs-attr</span> <span class="hl-operator">{</span> <span class="hl-property">color</span><span class="hl-operator">:</span> <span class="hl-number">#7bbf56</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>

<span class="hl-operator">.</span><span class="hl-identifier">hljs-attr</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-symbol</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-variable</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-template-variable</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-link</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-selector-attr</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-selector-pseudo</span> <span class="hl-operator">{</span> <span class="hl-property">color</span><span class="hl-operator">:</span> <span class="hl-number">#59c5ff</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>

<span class="hl-operator">.</span><span class="hl-identifier">hljs-keyword</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-attribute</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-selector-tag</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-meta</span> <span class="hl-operator">.</span><span class="hl-identifier">hljs-keyword</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-doctag</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-name</span> <span class="hl-operator">{</span> <span class="hl-property">color</span><span class="hl-operator">:</span> <span class="hl-number">#51a1cc</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>

<span class="hl-operator">.</span><span class="hl-identifier">hljs-type</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-string</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-number</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-quote</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-template-tag</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-deletion</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-title</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-section</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-meta</span> <span class="hl-operator">{</span> <span class="hl-property">color</span><span class="hl-operator">:</span> <span class="hl-number">#d97c57</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>

<span class="hl-operator">.</span><span class="hl-identifier">hljs-regexp</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-meta</span> <span class="hl-operator">.</span><span class="hl-identifier">hljs-string</span> <span class="hl-operator">{</span> <span class="hl-property">color</span><span class="hl-operator">:</span> <span class="hl-number">#b25947</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>

<span class="hl-operator">.</span><span class="hl-identifier">hljs-title</span><span class="hl-operator">.</span><span class="hl-identifier">function_</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-built_in</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-bullet</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-code</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-addition</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-selector-id</span><span class="hl-operator">,</span>
<span class="hl-operator">.</span><span class="hl-identifier">hljs-selector-class</span> <span class="hl-operator">{</span> <span class="hl-property">color</span><span class="hl-operator">:</span> <span class="hl-number">#e6b95c</span><span class="hl-operator">;</span> <span class="hl-operator">}</span>
</code></pre>
<h1 id="performance">Performance</h1>
<p>On my code-heavy, but tiny, site, I measured the following build times with and without syntax highlighting:</p>
<table>
<thead>
<tr>
<th align="left">Scenario</th>
<th align="right">Build time (s)</th>
<th align="right">Avg. time per page (ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Without highlighting</td>
<td align="right">1.4</td>
<td align="right">67</td>
</tr>
<tr>
<td align="left">With highlighting</td>
<td align="right">2.2</td>
<td align="right">105</td>
</tr>
</tbody>
</table>
<p>For me, on this machine, the overhead of syntax highlighting is roughly 40ms/page. This is certainly tolerable for my small site. I'll revisit the decision to use a JavaScript-based highlighter in the future, if needed. But for now, this is sufficient.</p>
<h1 id="the-end">The end</h1>
<p>Despite griping about theming, I'm impressed with how smoothly everything integrated. Adding working syntax highlighting to a static site in a single sitting shows how productive modern software stacks can be.</p>
<p>I'll end the post with some examples of syntax highlighting in a few languages I've already used on this site.</p>
<h2 id="syntax-highlighting-examples">Syntax highlighting examples</h2>
<h3 id="javascript">JavaScript</h3>
<pre><code class="language-javascript"><span class="hl-keyword">const</span> <span class="hl-identifier">fs</span> <span class="hl-operator">=</span> <span class="hl-function">require</span><span class="hl-operator">(</span><span class="hl-string">&apos;fs&apos;</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">(</span><span class="hl-keyword">async</span> <span class="hl-operator">(</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">module</span> <span class="hl-operator">=</span> <span class="hl-keyword">await</span> <span class="hl-type">WebAssembly</span><span class="hl-operator">.</span><span class="hl-function">instantiate</span><span class="hl-operator">(</span><span class="hl-keyword">await</span> <span class="hl-identifier">fs</span><span class="hl-operator">.</span><span class="hl-identifier">promises</span><span class="hl-operator">.</span><span class="hl-function">readFile</span><span class="hl-operator">(</span><span class="hl-string">&quot;./add.wasm&quot;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
    <span class="hl-keyword">const</span> <span class="hl-identifier">add</span> <span class="hl-operator">=</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-identifier">add</span><span class="hl-operator">;</span>
    <span class="hl-identifier">console</span><span class="hl-operator">.</span><span class="hl-function">log</span><span class="hl-operator">(</span><span class="hl-function">add</span><span class="hl-operator">(</span><span class="hl-number">2</span><span class="hl-operator">,</span> <span class="hl-number">2</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
</code></pre>
<h3 id="c">C</h3>
<pre><code class="language-c"><span class="hl-preprocessor">#define</span> <span class="hl-function">WASM_EXPORT_AS</span><span class="hl-operator">(</span><span class="hl-identifier">name</span><span class="hl-operator">)</span> <span class="hl-keyword">__attribute__</span><span class="hl-operator">(</span><span class="hl-operator">(</span><span class="hl-function">export_name</span><span class="hl-operator">(</span><span class="hl-identifier">name</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">)</span>
<span class="hl-preprocessor">#define</span> <span class="hl-function">WASM_EXPORT</span><span class="hl-operator">(</span><span class="hl-identifier">symbol</span><span class="hl-operator">)</span> <span class="hl-function">WASM_EXPORT_AS</span><span class="hl-operator">(</span><span class="hl-default">#</span><span class="hl-identifier">symbol</span><span class="hl-operator">)</span> <span class="hl-identifier">symbol</span>

<span class="hl-type">int</span> <span class="hl-function">WASM_EXPORT</span><span class="hl-operator">(</span><span class="hl-identifier">add</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-type">int</span> <span class="hl-identifier">a</span><span class="hl-operator">,</span> <span class="hl-type">int</span> <span class="hl-identifier">b</span><span class="hl-operator">)</span> <span class="hl-operator">{</span>
    <span class="hl-keyword">return</span> <span class="hl-identifier">a</span> <span class="hl-operator">+</span> <span class="hl-identifier">b</span><span class="hl-operator">;</span>
<span class="hl-operator">}</span>
</code></pre>
<h3 id="webassembly">WebAssembly</h3>
<pre><code class="language-webassembly">(module
  (type (;0;) (func (param i32 i32) (result i32)))
  (import &quot;env&quot; &quot;__linear_memory&quot; (memory (;0;) 0))
  (func $add (type 0) (param i32 i32) (result i32)
    local.get 1
    local.get 0
    i32.add))
</code></pre>
<h3 id="html">HTML</h3>
<pre><code class="language-html"><span class="hl-tag">&lt;</span><span class="hl-tag">html</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;</span><span class="hl-tag">body</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;</span><span class="hl-tag">p</span><span class="hl-tag">&gt;</span><span class="hl-default">T</span><span class="hl-default">h</span><span class="hl-default">e</span> <span class="hl-default">v</span><span class="hl-default">a</span><span class="hl-default">l</span><span class="hl-default">u</span><span class="hl-default">e</span> <span class="hl-default">o</span><span class="hl-default">f</span> <span class="hl-default">2</span> <span class="hl-default">+</span> <span class="hl-default">2</span> <span class="hl-default">i</span><span class="hl-default">s</span> <span class="hl-tag">&lt;</span><span class="hl-tag">span</span> <span class="hl-attribute">id</span><span class="hl-operator">=</span><span class="hl-string">&quot;result&quot;</span><span class="hl-tag">&gt;</span><span class="hl-default">?</span><span class="hl-tag">&lt;/</span><span class="hl-tag">span</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/</span><span class="hl-tag">p</span><span class="hl-tag">&gt;</span>

        <span class="hl-tag">&lt;</span><span class="hl-tag">script</span><span class="hl-tag">&gt;</span>
            <span class="hl-operator">(</span><span class="hl-keyword">async</span> <span class="hl-operator">(</span><span class="hl-operator">)</span> <span class="hl-operator">=</span><span class="hl-operator">&gt;</span> <span class="hl-operator">{</span>
                <span class="hl-keyword">const</span> <span class="hl-identifier">module</span> <span class="hl-operator">=</span> <span class="hl-keyword">await</span> <span class="hl-type">WebAssembly</span><span class="hl-operator">.</span><span class="hl-function">instantiateStreaming</span><span class="hl-operator">(</span><span class="hl-function">fetch</span><span class="hl-operator">(</span><span class="hl-string">&quot;./add.wasm&quot;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
                <span class="hl-keyword">const</span> <span class="hl-identifier">add</span> <span class="hl-operator">=</span> <span class="hl-identifier">module</span><span class="hl-operator">.</span><span class="hl-identifier">instance</span><span class="hl-operator">.</span><span class="hl-identifier">exports</span><span class="hl-operator">.</span><span class="hl-identifier">add</span><span class="hl-operator">;</span>
                <span class="hl-identifier">document</span><span class="hl-operator">.</span><span class="hl-function">getElementById</span><span class="hl-operator">(</span><span class="hl-string">&quot;result&quot;</span><span class="hl-operator">)</span><span class="hl-operator">.</span><span class="hl-identifier">innerText</span> <span class="hl-operator">=</span> <span class="hl-function">add</span><span class="hl-operator">(</span><span class="hl-number">2</span><span class="hl-operator">,</span> <span class="hl-number">2</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
            <span class="hl-operator">}</span><span class="hl-operator">)</span><span class="hl-operator">(</span><span class="hl-operator">)</span><span class="hl-operator">;</span>
        <span class="hl-tag">&lt;/</span><span class="hl-tag">script</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;/</span><span class="hl-tag">body</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/</span><span class="hl-tag">html</span><span class="hl-tag">&gt;</span>
</code></pre>

<footer>
<p>&crarr; <a href="../../index.html">Back to home</a></p>
</footer>
</article>
</main>

</body>
</html>
