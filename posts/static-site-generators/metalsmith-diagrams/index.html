<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Schemescape: Generating SVG diagrams automatically with Metalsmith</title>
<meta name="description" content="Metalsmith is used to build this static site. Here&#x27;s how Graphviz was integrated to automatically generate diagrams." />
<meta name="keywords" content="metalsmith,diagrams" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link rel="stylesheet" href="../../../css/style.css" />
<link rel="alternate" type="application/rss+xml" href="../../../feed.xml" />
</head>
<body>
<header>
<h1><a href="../../../">Schemescape</a></h1>
<p>Development log of a life-long coder</p>
<nav>
<ul>
<li><a href="../../../posts/static-site-generators">static-site-generators</a></li>
<li><a href="../../../posts/metalsmith">metalsmith</a></li>
<li><a href="../../../posts/diagrams">diagrams</a></li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h1><a href=".">Generating SVG diagrams automatically with Metalsmith</a></h1>
<p><time datetime="2021-10-10">October 10, 2021</time></p>
</header>
<p>Now that I&#39;ve <a href="../../webassembly/compiling-graphviz-to-webassembly/">compiled Graphviz to a WebAssembly module</a>, I&#39;m going to use it to automatically generate SVG diagrams when I build my static site using Metalsmith.</p>
<h1 id="the-plan">The plan</h1>
<p>Here&#39;s a flow chart of my general plan:</p>
<svg width="312pt" height="260pt"
 viewBox="0.00 0.00 311.67 260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<polygon class="diagram-transparent-white" points="-4,4 -4,-256 307.67,-256 307.67,4 -4,4"/>
<g id="node1" class="node">
<title>Compile Graphviz to WebAssembly</title>
<ellipse class="diagram-black-none" cx="151.84" cy="-234" rx="151.67" ry="18"/>
<text text-anchor="middle" x="151.84" y="-229.8" font-size="14.00">Compile Graphviz to WebAssembly</text>
</g>
<g id="node2" class="node">
<title>Generate diagrams at build time</title>
<ellipse class="diagram-black-none" cx="151.84" cy="-162" rx="134.85" ry="18"/>
<text text-anchor="middle" x="151.84" y="-157.8" font-size="14.00">Generate diagrams at build time</text>
</g>
<g id="edge1" class="edge">
<title>Compile Graphviz to WebAssembly&#45;&gt;Generate diagrams at build time</title>
<path class="diagram-black-none" d="M151.84,-215.7C151.84,-207.98 151.84,-198.71 151.84,-190.11"/>
<polygon class="diagram-black-black" points="155.34,-190.1 151.84,-180.1 148.34,-190.1 155.34,-190.1"/>
</g>
<g id="node3" class="node">
<title>???</title>
<ellipse class="diagram-black-none" cx="151.84" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="151.84" y="-85.8" font-size="14.00">???</text>
</g>
<g id="edge2" class="edge">
<title>Generate diagrams at build time&#45;&gt;???</title>
<path class="diagram-black-none" d="M151.84,-143.7C151.84,-135.98 151.84,-126.71 151.84,-118.11"/>
<polygon class="diagram-black-black" points="155.34,-118.1 151.84,-108.1 148.34,-118.1 155.34,-118.1"/>
</g>
<g id="node4" class="node">
<title>Profit!</title>
<ellipse class="diagram-black-none" cx="151.84" cy="-18" rx="36.49" ry="18"/>
<text text-anchor="middle" x="151.84" y="-13.8" font-size="14.00">Profit!</text>
</g>
<g id="edge3" class="edge">
<title>???&#45;&gt;Profit!</title>
<path class="diagram-black-none" d="M151.84,-71.7C151.84,-63.98 151.84,-54.71 151.84,-46.11"/>
<polygon class="diagram-black-black" points="155.34,-46.1 151.84,-36.1 148.34,-46.1 155.34,-46.1"/>
</g>
</g>
</svg>
<p>That diagram was generated using the following Markdown:</p>
<pre><code class="language-md"><span class="hljs-code">```dot2svg
digraph {
    &quot;Compile Graphviz to WebAssembly&quot; -&gt; &quot;Generate diagrams at build time&quot; -&gt; &quot;???&quot; -&gt; &quot;Profit!&quot;;
}
```</span>
</code></pre>
<h1 id="extending-the-marked-renderer">Extending the Marked renderer</h1>
<p>As shown in the example near the top of this post, my plan is to piggyback on Markdown code blocks, using a special language tag <code>dot2svg</code>. For all other code blocks (and on error), I simply defer to the default code block rendering function:</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Generate diagrams with dot2svg</span>
<span class="hljs-keyword">const</span> baseCodeRenderer = markdownRenderer.<span class="hljs-property">code</span>;
<span class="hljs-keyword">const</span> dotConverter = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createDOTToSVGAsync</span>();
markdownRenderer.<span class="hljs-property">code</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">code, language, escaped</span>) {
    <span class="hljs-keyword">if</span> (language === <span class="hljs-string">&quot;dot2svg&quot;</span>) {
        <span class="hljs-keyword">const</span> svg = dotConverter.<span class="hljs-title function_">dotToSVG</span>(code);
        <span class="hljs-keyword">if</span> (svg) {
            <span class="hljs-keyword">return</span> svg;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// On error, just treat the code block like normal</span>
            language = <span class="hljs-string">&quot;&quot;</span>;
        }
    }
    <span class="hljs-keyword">return</span> baseCodeRenderer.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, code, language, escaped);
};
</code></pre>
<h1 id="styling">Styling</h1>
<p>The above rendering code worked (and didn&#39;t break my <a href="../metalsmith-syntax-highlighting/">syntax highlighting</a>), but there were a few tweaks I had in mind:</p>
<ul>
<li>Remove the <a href="https://www.w3.org/TR/xml/#sec-prolog-dtd">XML prolog and document type declaration</a><ul>
<li>Since I&#39;m inlining my SVG in HTML, this information is redundant</li>
</ul>
</li>
<li>Replace Graphviz&#39;s default styling (annoyingly hard-coded via <code>fill</code> and <code>stroke</code> attributes on each element) with CSS classes<ul>
<li>This allows me to style the graphs using my CSS stylesheet</li>
<li>In my case, I&#39;m replacing the <code>fill=&quot;white&quot; stroke=&quot;black&quot;</code> attributes with a single CSS class: <code>class=&quot;diagram-black-white&quot;</code></li>
</ul>
</li>
</ul>
<p>Fortunately, both of these transformations can be done with regular expression replacements:</p>
<pre><code class="language-javascript">...
<span class="hljs-keyword">if</span> (svg) {
    <span class="hljs-comment">// Remove XML prolog, since we&#x27;re inlining</span>
    <span class="hljs-comment">// Also convert default styles to CSS classes, for custom styling</span>
    <span class="hljs-keyword">return</span> svg
        .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^.*?&lt;svg /</span>s, <span class="hljs-string">&quot;&lt;svg &quot;</span>)
        .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/fill=&quot;([^&quot;]+)&quot; stroke=&quot;([^&quot;]+)&quot;/g</span>, <span class="hljs-string">&quot;class=\&quot;diagram-$2-$1\&quot;&quot;</span>);
} <span class="hljs-keyword">else</span> {
...
</code></pre>
<p>Now, I can just style everything with CSS:</p>
<pre><code class="language-css"><span class="hljs-comment">/* Diagrams */</span>
svg text { fill: <span class="hljs-number">#eee</span>; }
<span class="hljs-selector-class">.diagram-transparent-white</span> { stroke: none; fill: none; }
ellipse<span class="hljs-selector-class">.diagram-black-none</span> { stroke: <span class="hljs-number">#ccc</span>; fill: <span class="hljs-number">#444</span>; }
<span class="hljs-selector-class">.diagram-black-none</span> { stroke: <span class="hljs-number">#999</span>; fill:none; }
<span class="hljs-selector-class">.diagram-black-black</span> { stroke: <span class="hljs-number">#999</span>; fill: <span class="hljs-number">#333</span>; }
</code></pre>
<h1 id="thats-it">That&#39;s it!</h1>
<p>To my surprise, this entire integration went smoothly, and only took an hour or so. It remains to be seen how useful these diagrams will be, but at least now if I ever feel the need to insert a superfluous diagram, the functionality will be there.</p>
<p>For reference, all of the code used to generate this site (along with the content) is in <a href="https://github.com/jaredkrinke/log">this repository</a>.</p>

<footer>
<p><a href="../../../">Back to home</a></p>
</footer>
</article>
</main>
</body>
</html>
