<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Syntax highlighting for 150 languages in &lt; 200 KB</title>
<meta name="description" content="It&#039;s not bloat if I actually use it, right?" />
<meta name="keywords" content="lua" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link rel="stylesheet" href="../../css/style.css" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Syntax highlighting for 150 languages in < 200 KB",
  "abstract": "It's not bloat if I actually use it, right?",
  "keywords": "static-site-generators,lua",
  "datePublished": "2025-06-25"
}
</script>
</head>
<body>
<header>
<h1><a href="../../index.html">Schemescape</a></h1>
<p>Development log of a life-long coder</p>

<nav>
<strong>Topics:&nbsp;</strong>
<ul>
<li><a href="../../posts/static-site-generators/index.html">static-site-generators</a></li>
<li><a href="../../posts/lua/index.html">lua</a></li>
</ul>
</nav>
</header>
<main>
<article>
<header>
<h1><a href="../../posts/static-site-generators/luasmith-syntax-highlighting.html">Syntax highlighting for 150 languages in &lt; 200 KB</a></h1>
<p><time datetime="2025-06-25">June 25, 2025</time></p>
</header>
<p>After <a href="smallest-static-site-generator.html">creating a (formerly) 270 KB static site generator</a> and <a href="extending-luasmith.html">adding internal link-checking with minimal bloat</a>, the feature creep continues: <a href="https://github.com/jaredkrinke/luasmith">luasmith</a> now supports syntax highlighting for ~150 languages, thanks to <a href="https://orbitalquark.github.io/scintillua/">Scintillua</a>--<strong>and it only increased the gzipped download by about 180 KB</strong>!</p>
<p>This post describes my path to adding lightweight and customizable syntax highlighting to luasmith.</p>
<h1 id="research">Research</h1>
<h2 id="initial-research">Initial research</h2>
<p>My initial research on existing well-supported solutions was fruitless:</p>
<ul>
<li><a href="https://highlightjs.org/">highlight.js</a> is what I used in <a href="https://github.com/jaredkrinke/md2blog">md2blog</a>, but it required JavaScript (or at least a JS regular expression engine?) so it couldn't be trivially integrated into Lua-based luasmith</li>
<li><a href="https://tree-sitter.github.io/tree-sitter/">Tree-sitter</a> is the undisputed king of high performance syntax highlighting, but it didn't appear to provide an interpreter (instead relying on code generation and a C compiler) -- and, honestly, it seemed like overkill for coloring a few code samples on my tiny site</li>
<li>Most other highlighters were implemented in JavaScript, Rust, or Go, which, like highlight.js, would significantly complicate luasmith's dependency tree and build process</li>
</ul>
<p><strong>What I wanted was something either Lua-native or small but easily extensible.</strong></p>
<h2 id="lpeg-and-scintillua">LPeg and Scintillua</h2>
<p>The most obvious starting point for parsing in Lua is <a href="https://www.inf.puc-rio.br/~roberto/lpeg/">LPeg</a>, from the same folks who created Lua. While investigating LPeg-based highlighters, I ran across <a href="https://orbitalquark.github.io/scintillua/">Scintillua</a>, which supports an impressive number of languages with a minimalist approach--it's even apparently used in the lightweight <a href="https://github.com/martanne/vis">vis</a> editor.</p>
<p>Investigating further, I found that <a href="https://orbitalquark.github.io/scintillua/api.html">Scintillua was well documented</a> and a sample grammar from the documentation was easy to understand. Here's that sample grammar, for reference:</p>
<pre><code class="language-lua"><span class="hl-keyword">local</span> <span class="hl-identifier">lexer</span> <span class="hl-operator">=</span> <span class="hl-identifier">lexer</span>
<span class="hl-keyword">local</span> <span class="hl-identifier">P</span><span class="hl-operator">,</span> <span class="hl-identifier">S</span> <span class="hl-operator">=</span> <span class="hl-identifier">lpeg</span><span class="hl-operator">.</span><span class="hl-identifier">P</span><span class="hl-operator">,</span> <span class="hl-identifier">lpeg</span><span class="hl-operator">.</span><span class="hl-identifier">S</span>

<span class="hl-keyword">local</span> <span class="hl-identifier">lex</span> <span class="hl-operator">=</span> <span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-function">new</span><span class="hl-operator">(</span><span class="hl-operator">..</span><span class="hl-operator">.</span><span class="hl-operator">)</span>

<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">add_rule</span><span class="hl-operator">(</span><span class="hl-string">&apos;keyword&apos;</span><span class="hl-operator">,</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">tag</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">KEYWORD</span><span class="hl-operator">,</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">word_match</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">KEYWORD</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">)</span>
<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">add_rule</span><span class="hl-operator">(</span><span class="hl-string">&apos;custom&apos;</span><span class="hl-operator">,</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">tag</span><span class="hl-operator">(</span><span class="hl-string">&apos;custom&apos;</span><span class="hl-operator">,</span> <span class="hl-string">&apos;quux&apos;</span><span class="hl-operator">)</span><span class="hl-operator">)</span>
<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">add_rule</span><span class="hl-operator">(</span><span class="hl-string">&apos;identifier&apos;</span><span class="hl-operator">,</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">tag</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">IDENTIFIER</span><span class="hl-operator">,</span> <span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">word</span><span class="hl-operator">)</span><span class="hl-operator">)</span>
<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">add_rule</span><span class="hl-operator">(</span><span class="hl-string">&apos;string&apos;</span><span class="hl-operator">,</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">tag</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">STRING</span><span class="hl-operator">,</span> <span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-function">range</span><span class="hl-operator">(</span><span class="hl-string">&apos;&quot;&apos;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">)</span>
<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">add_rule</span><span class="hl-operator">(</span><span class="hl-string">&apos;comment&apos;</span><span class="hl-operator">,</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">tag</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">COMMENT</span><span class="hl-operator">,</span> <span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-function">to_eol</span><span class="hl-operator">(</span><span class="hl-string">&apos;#&apos;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">)</span>
<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">add_rule</span><span class="hl-operator">(</span><span class="hl-string">&apos;number&apos;</span><span class="hl-operator">,</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">tag</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">NUMBER</span><span class="hl-operator">,</span> <span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">number</span><span class="hl-operator">)</span><span class="hl-operator">)</span>
<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">add_rule</span><span class="hl-operator">(</span><span class="hl-string">&apos;operator&apos;</span><span class="hl-operator">,</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">tag</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">OPERATOR</span><span class="hl-operator">,</span> <span class="hl-function">S</span><span class="hl-operator">(</span><span class="hl-string">&apos;+-*/%^=&lt;&gt;,.()[]{}&apos;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">)</span>

<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">add_fold_point</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">OPERATOR</span><span class="hl-operator">,</span> <span class="hl-string">&apos;{&apos;</span><span class="hl-operator">,</span> <span class="hl-string">&apos;}&apos;</span><span class="hl-operator">)</span>

<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">set_word_list</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">KEYWORD</span><span class="hl-operator">,</span> <span class="hl-operator">{</span><span class="hl-string">&apos;foo&apos;</span><span class="hl-operator">,</span> <span class="hl-string">&apos;bar&apos;</span><span class="hl-operator">,</span> <span class="hl-string">&apos;baz&apos;</span><span class="hl-operator">}</span><span class="hl-operator">)</span>

<span class="hl-keyword">return</span> <span class="hl-identifier">lex</span>
</code></pre>
<p><strong>Given that Scintillua used one tenth the code of highlight.js and was Lua-native and well documented, it was exactly what I was looking for.</strong></p>
<h1 id="implementation">Implementation</h1>
<h2 id="highlighting-code-blocks">Highlighting code blocks</h2>
<p>For maximum efficiency, I would have hooked syntax highlighting directly into <a href="https://github.com/mity/md4c">md4c</a> (the Markdown parser luasmith uses), so that it would syntax-highlight code as it is parsed. That might have required creating a callback mechanism for md4c, leading to Lua-calling-into-C-calling-into-Lua messiness.</p>
<p>In pursuit of relentless <del>laziness</del> simplicity, I instead used <a href="extending-luasmith.html">the trivial HTML parser I previous created for link-checking</a> to find <code>&lt;pre&gt;</code> and <code>&lt;code&gt;</code> blocks with <code>language-*</code> CSS classes on them, and funneled those into Scintillua. This resulted in maybe a page of simple Lua code, as opposed to probably a few hundred lines of tricky C-Lua integration code in the &quot;optimal&quot; implementation. <strong>I guess the &quot;efficiency&quot; I optimized for was &quot;time to produce a working tool, with acceptable performance&quot;, rather than strict runtime performance</strong>.</p>
<p>Aside: given that this approach used HTML as input, it would be trivial to use it to create a tool that adds syntax highlighting to hand-authored HTML files, or even a tool that adds syntax highlighting as <code>&lt;b&gt;</code>, <code>&lt;i&gt;</code>, etc. tags instead of <code>&lt;span&gt;</code>'s, so that text mode browsers like Lynx or w3m could enjoy the fun!</p>
<h2 id="loading-grammars">Loading grammars</h2>
<p>Rather than ship a zip with 100+ Lua files from Scintillua, I decided to embed all those scripts directly into the executable (with the ability to override them, as needed). <strong>This allowed me to ship a single static binary</strong> (my preferred packaging method for one-off tools).</p>
<p>The only trick was that Scintillua, in its library form, implemented its own file search and load system based on probing files with Lua's <code>loadfile</code> function. I ended up wrapping <code>loadfile</code> with some code to detect Scintillua's calls and point them at the embedded strings (which are lazily loaded into Lua). In general, I dislike Lua's file-loading infrastructure, but I understand that they're limited by the C standard library--specifically, its lack of file enumeration support.</p>
<h2 id="result">Result</h2>
<p>In the end, adding in LPeg, Scintillua, almost all its grammars, and glue code only added around 175 KB to the (gzip-compressed) tarball (a 67% increase--not as bad as I originally feared). Even better, syntax highlighting for my blog only increased the generation time by around 50% (roughly 1 millisecond per page, on my 2013 laptop).</p>
<p>Finally, I had a small and simple static site generator that did what I wanted!</p>
<h1 id="bonus-authoring-an-etlua-grammar">Bonus: authoring an etlua grammar</h1>
<p>One aspect of Scintillua that hooked me was that adding new grammars simply required writing some Lua code, using the LPeg library. I had not actually used LPeg before, but <a href="https://www.inf.puc-rio.br/~roberto/lpeg/">its documentation</a> was easy to understand (and there's also <a href="https://leafo.net/guides/parsing-expression-grammars.html">a great LPeg tutorial on leafo.net</a>).</p>
<p>Given that luasmith uses <a href="https://github.com/leafo/etlua">etlua</a> for templates, I thought it would be fun to write a syntax highlighter for etlua.</p>
<h2 id="structure">Structure</h2>
<p>Scintillua's documentation provides <a href="https://orbitalquark.github.io/scintillua/api.html#embedded-lexers">information and examples for embedding one parser within another</a>. In the case of etlua, I'm assuming Lua code will always be embedded in HTML, so an etlua parser should simply be an HTML parser with Lua embedded between <code>&lt;%</code> ... <code>%&gt;</code> tags. The author of Scintillua even pointed out to me that there's already a very similar parser: <a href="https://github.com/orbitalquark/scintillua/blob/default/lexers/rhtml.lua">RHTML</a> (Ruby in HTML).</p>
<h2 id="implementation-1">Implementation</h2>
<p>Using the RHTML parser as a starting point, it was simply a matter of including the appropriate start and end tags (note: LPeg uses Lua metatables for repurposing arithmetic operations as parsing expression grammar building blocks, e.g. <code>^-1</code> means &quot;at most one&quot;, <code>*</code> means &quot;concatenation&quot;, and <code>+</code> means &quot;alternation/or&quot; -- and <code>lpeg.P(...)</code> just matches string literals). Here's the trivial parser:</p>
<pre><code class="language-lua"><span class="hl-keyword">local</span> <span class="hl-identifier">lexer</span> <span class="hl-operator">=</span> <span class="hl-identifier">lexer</span>
<span class="hl-keyword">local</span> <span class="hl-identifier">P</span><span class="hl-operator">,</span> <span class="hl-identifier">S</span> <span class="hl-operator">=</span> <span class="hl-identifier">lpeg</span><span class="hl-operator">.</span><span class="hl-identifier">P</span><span class="hl-operator">,</span> <span class="hl-identifier">lpeg</span><span class="hl-operator">.</span><span class="hl-identifier">S</span>

<span class="hl-comment">-- Base on the existing HTML parser</span>
<span class="hl-keyword">local</span> <span class="hl-identifier">lex</span> <span class="hl-operator">=</span> <span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-function">new</span><span class="hl-operator">(</span><span class="hl-operator">..</span><span class="hl-operator">.</span><span class="hl-operator">,</span> <span class="hl-operator">{</span><span class="hl-identifier">inherit</span> <span class="hl-operator">=</span> <span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-function">load</span><span class="hl-operator">(</span><span class="hl-string">&apos;html&apos;</span><span class="hl-operator">)</span><span class="hl-operator">}</span><span class="hl-operator">)</span>

<span class="hl-comment">-- Embed the existing Lua parser</span>
<span class="hl-keyword">local</span> <span class="hl-identifier">lua</span> <span class="hl-operator">=</span> <span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-function">load</span><span class="hl-operator">(</span><span class="hl-string">&apos;lua&apos;</span><span class="hl-operator">)</span>

<span class="hl-comment">-- Specify `&lt;%` and `%&gt;` (and highlight the tags as &quot;preprocessor directives&quot;)</span>
<span class="hl-keyword">local</span> <span class="hl-identifier">start_rule</span> <span class="hl-operator">=</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">tag</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">PREPROCESSOR</span><span class="hl-operator">,</span> <span class="hl-string">&apos;&lt;%&apos;</span> <span class="hl-operator">*</span> <span class="hl-operator">(</span><span class="hl-function">P</span><span class="hl-operator">(</span><span class="hl-string">&apos;=&apos;</span><span class="hl-operator">)</span> <span class="hl-operator">+</span> <span class="hl-function">P</span><span class="hl-operator">(</span><span class="hl-string">&apos;-&apos;</span><span class="hl-operator">)</span><span class="hl-operator">)</span><span class="hl-operator">^</span><span class="hl-number">-1</span><span class="hl-operator">)</span>
<span class="hl-keyword">local</span> <span class="hl-identifier">end_rule</span> <span class="hl-operator">=</span> <span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">tag</span><span class="hl-operator">(</span><span class="hl-identifier">lexer</span><span class="hl-operator">.</span><span class="hl-identifier">PREPROCESSOR</span><span class="hl-operator">,</span> <span class="hl-function">P</span><span class="hl-operator">(</span><span class="hl-string">&apos;-&apos;</span><span class="hl-operator">)</span><span class="hl-operator">^</span><span class="hl-number">-1</span> <span class="hl-operator">*</span> <span class="hl-string">&apos;%&gt;&apos;</span><span class="hl-operator">)</span>

<span class="hl-comment">-- Highlight contained code as Lua</span>
<span class="hl-identifier">lex</span><span class="hl-operator">:</span><span class="hl-function">embed</span><span class="hl-operator">(</span><span class="hl-identifier">lua</span><span class="hl-operator">,</span> <span class="hl-identifier">start_rule</span><span class="hl-operator">,</span> <span class="hl-identifier">end_rule</span><span class="hl-operator">)</span>

<span class="hl-keyword">return</span> <span class="hl-identifier">lex</span>
</code></pre>
<h2 id="result-1">Result</h2>
<p>Finally, here is an example of a highlighted etlua template:</p>
<pre><code class="language-etlua"><span class="hl-tag">&lt;</span><span class="hl-tag">ul</span><span class="hl-tag">&gt;</span>
<span class="hl-preprocessor">&lt;%</span> <span class="hl-keyword">for</span> <span class="hl-identifier">i</span><span class="hl-operator">,</span> <span class="hl-identifier">item</span> <span class="hl-keyword">in</span> <span class="hl-function">ipairs</span><span class="hl-operator">(</span><span class="hl-identifier">table</span><span class="hl-operator">.</span><span class="hl-function">sortBy</span><span class="hl-operator">(</span><span class="hl-identifier">items</span><span class="hl-operator">,</span> <span class="hl-string">&quot;date&quot;</span><span class="hl-operator">,</span> <span class="hl-keyword">true</span><span class="hl-operator">)</span><span class="hl-operator">)</span> <span class="hl-keyword">do</span> <span class="hl-preprocessor">-%&gt;</span>
<span class="hl-tag">&lt;</span><span class="hl-tag">li</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;</span><span class="hl-tag">a</span> <span class="hl-attribute">href</span><span class="hl-operator">=</span><span class="hl-string">&quot;&lt;%= item.path %&gt;&quot;</span><span class="hl-tag">&gt;</span><span class="hl-preprocessor">&lt;%=</span> <span class="hl-identifier">item</span><span class="hl-operator">.</span><span class="hl-identifier">title</span> <span class="hl-preprocessor">%&gt;</span><span class="hl-tag">&lt;/</span><span class="hl-tag">a</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;/</span><span class="hl-tag">li</span><span class="hl-tag">&gt;</span>
<span class="hl-preprocessor">&lt;%</span> <span class="hl-keyword">end</span> <span class="hl-preprocessor">-%&gt;</span>
<span class="hl-tag">&lt;/</span><span class="hl-tag">ul</span><span class="hl-tag">&gt;</span>
</code></pre>
<p>Notice that <code>for i, item in ipairs(...)</code> is highlighted as Lua code, while the surrounding HTML is highlighted as HTML. Of course, this also reveals a limitation of Sctinllua's nesting approach in that the <code>item.path</code> Lua code that's inside an HTML attribute is just treated as part of the HTML attribute, i.e. a string. Not perfect, but also not a big deal for, essentially, ornamentation.</p>
<p>Overall, it works pretty well, while remaining small and simple.</p>
<h1 id="further-reading">Further reading</h1>
<p>If a minimal, Lua-based static site generator sounds good to you, <a href="https://github.com/jaredkrinke/luasmith">give luasmith a look</a>. Note that it's still &quot;alpha&quot; quality, and is likely to remain that way unless it miraculously becomes internet famous.</p>
<p>Example sites are here:</p>
<ul>
<li><a href="https://log.schemescape.com/">This blog</a> (<a href="https://github.com/jaredkrinke/log">source</a>)</li>
<li><a href="https://jaredkrinke.github.io/til/">List of small things I've learned</a> (<a href="https://github.com/jaredkrinke/til">source</a>)</li>
</ul>
<p>Note: The latter repository contains <a href="https://github.com/jaredkrinke/til/blob/main/readme.lua">a simple self-contained luasmith &quot;template&quot; (script) for generating its README file</a>.</p>

<footer>
<p>&crarr; <a href="../../index.html">Back to home</a></p>
</footer>
</article>
</main>

</body>
</html>
